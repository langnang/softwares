<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Nav\Admin\Controller; use Illuminate\Routing\Controller; use ModStart\Admin\Concern\HasAdminQuickCRUD; use ModStart\Admin\Layout\AdminCRUDBuilder; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Type\TypeUtil; use ModStart\Field\AbstractField; use ModStart\Field\AutoRenderedFieldValue; use ModStart\Field\Type\FieldRenderMode; use ModStart\Form\Form; use ModStart\ModStart; use ModStart\Repository\Filter\ScopeFilter; use ModStart\Support\Concern\HasFields; use Module\Nav\Type\NavOpenType; use Module\Nav\Type\NavPosition; use Module\Nav\Util\NavUtil; class NavController extends Controller { use HasAdminQuickCRUD; protected function crud(AdminCRUDBuilder $Jf1S7) { goto HkwgC; h4EIO: foreach (NavPosition::getList() as $F66vY => $I1R2f) { $Jf1S7->scopeFilter($F66vY, $I1R2f, function (ScopeFilter $XM5aD) use($F66vY) { return $XM5aD->where('position', $F66vY); }); } goto fcam3; fcam3: $Jf1S7->scopeDefault(NavPosition::first()); goto ob2_G; HkwgC: if ($Jf1S7->mode() == AdminCRUDBuilder::MODE_FORM) { goto AzKUB; g1acT: ModStart::scriptFile('module/Nav/Admin/Controller/NavEdit.js'); goto RyZ2L; B0VRz: foreach (ModelUtil::all('nav', array('pid' => 0), array('*')) as $qlKQK) { $liJ5j[$qlKQK['id']] = TypeUtil::name(NavPosition::class, $qlKQK['position']) . ' > ' . $qlKQK['name']; } goto qNeF7; qNeF7: ModStart::script('window.__navPositionMap=' . json_encode($liJ5j) . ';'); goto g1acT; AzKUB: $liJ5j = array(); goto B0VRz; RyZ2L: } goto d0QwC; ob2_G: $Jf1S7->hookSaved(function (Form $oqTbu) { $qlKQK = $oqTbu->item(); if ($qlKQK->pid > 0) { $fGy3y = ModelUtil::get('nav', $qlKQK->pid); ModelUtil::update('nav', $qlKQK->id, array('position' => $fGy3y['position'])); } })->hookChanged(function (Form $oqTbu) { NavUtil::clearCache(); })->canBatchDelete(true)->asTree('id', 'pid', 'sort', 'name')->treeMaxLevel(2)->title('导航'); goto WtwF6; d0QwC: $Jf1S7->init('nav')->field(function ($Jf1S7) { $Jf1S7->id('id', 'ID'); $Jf1S7->select('position', '位置')->optionType(NavPosition::class)->hookRendering(function (AbstractField $gxoEj, $qlKQK, $mlRDG) { switch ($gxoEj->renderMode()) { case FieldRenderMode::DETAIL: case FieldRenderMode::GRID: if ($qlKQK->pid) { return AutoRenderedFieldValue::make(''); } return AutoRenderedFieldValue::make(TypeUtil::name(NavPosition::class, $qlKQK->position)); } }); $Jf1S7->text('name', '名称'); $Jf1S7->icon('icon', '图标')->help('部分主题支持图标显示'); $Jf1S7->link('link', '链接'); $Jf1S7->switch('enable', '启用')->optionsYesNo()->gridEditable(true)->defaultValue(true); $Jf1S7->radio('openType', '打开方式')->optionType(NavOpenType::class)->defaultValue(NavOpenType::CURRENT_WINDOW); $Jf1S7->display('created_at', L('Created At'))->listable(false); $Jf1S7->display('updated_at', L('Updated At'))->listable(false); }); goto h4EIO; WtwF6: } }