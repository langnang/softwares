<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Tecmz\Util; use App\Constant\AppConstant; use Chumper\Zipper\Zipper; use Illuminate\Support\Facades\Artisan; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Response; use ModStart\Core\Util\CurlUtil; use ModStart\Core\Util\FileUtil; use ModStart\ModStart; class UpgradeUtil { const REMOTE_BASE = 'https://www.tecmz.com'; private static function baseRequest($ELIlU, $WAiaw = array(), $nxg8F = null) { return CurlUtil::postJSONBody(self::REMOTE_BASE . $ELIlU, $WAiaw, array('header' => array('api-token' => $nxg8F, 'X-Requested-With' => 'XMLHttpRequest'))); } public static function latest() { goto kx_5l; kx_5l: $ULXwZ = self::baseRequest('/api/app/latest', array('app' => AppConstant::APP, 'version' => AppConstant::VERSION)); goto b1X9c; tlL8E: return $ULXwZ['data']; goto P9Meq; b1X9c: BizException::throwsIfResponseError($ULXwZ); goto tlL8E; P9Meq: } public static function downloadPackage($nxg8F, $ye3vG, $Q_thE, $JaZ3s) { goto oviP1; aFYjK: file_put_contents($QkQlj, $WAiaw); goto ih4Qs; qq1bD: $QkQlj = FileUtil::generateLocalTempPath('zip'); goto aFYjK; ih4Qs: BizException::throwsIf('文件MD5校验失败', md5_file($QkQlj) != $JmKWs); goto iIvO2; Rykkk: return Response::generateSuccessData(array('diffContentFile' => $mc3cG, 'package' => $QkQlj, 'packageSize' => filesize($QkQlj))); goto agonE; iIvO2: $mc3cG = FileUtil::generateLocalTempPath('json'); goto CAc0F; Pie2S: $WAiaw = CurlUtil::getRaw($S5NA4); goto Rzgm1; CAc0F: file_put_contents($mc3cG, $EKWAX); goto Rykkk; KES2K: BizException::throwsIfResponseError($ULXwZ); goto Rct3t; M6GmR: $EKWAX = $ULXwZ['data']['diffContent']; goto Pie2S; YKM2K: $JmKWs = $ULXwZ['data']['packageMd5']; goto M6GmR; Rzgm1: BizException::throwsIfEmpty('安装包获取失败', $WAiaw); goto qq1bD; Rct3t: $S5NA4 = $ULXwZ['data']['package']; goto YKM2K; oviP1: $ULXwZ = self::baseRequest('/api/app/download_package', array('app' => $ye3vG, 'fromVersion' => $Q_thE, 'toVersion' => $JaZ3s), $nxg8F); goto KES2K; agonE: } public static function upgradePackage($S5NA4, $mc3cG) { goto zd99Z; WUCXH: return Response::generateSuccessData(array('logs' => $jUt7q)); goto PYzDz; Xhk5M: BizException::throwsIf('diffContent为空', empty($EKWAX)); goto ncVzO; yP3lc: $lBl7m = new Zipper(); goto UX2Gs; Bro45: $jUt7q = array(); goto hmcjF; XlJIY: ModStart::clearCache(); goto D8uqi; EvQAZ: $lBl7m->close(); goto XlJIY; UX2Gs: $lBl7m->make($S5NA4); goto Bro45; hmcjF: if (!empty($EKWAX['add'])) { goto MmHOq; QkQ2b: foreach ($EKWAX['add'] as $rd0Br) { goto P0VUE; xkIiZ: FileUtil::write(base_path($rd0Br), $yo_tt); goto Gn60s; Gn60s: $jUt7q[] = "> {$rd0Br}"; goto aTHm6; P0VUE: $yo_tt = $lBl7m->getFileContent($rd0Br); goto xkIiZ; aTHm6: } goto KPLwd; KPLwd: $jUt7q[] = ''; goto MfyWn; MmHOq: $jUt7q[] = '新增文件：'; goto QkQ2b; MfyWn: } goto CD1Mp; CQaVJ: try { $cLx4V = Artisan::call('modstart:module-install-all'); } catch (\Exception $H8GLS) { $cLx4V = -1; } goto ZVCVG; ZVCVG: BizException::throwsIf('调用 php artisan modstart:module-install-all 失败', 0 != $cLx4V); goto Y6Lm3; jXTGP: FileUtil::safeCleanLocalTemp($mc3cG); goto WUCXH; zd99Z: BizException::throwsIf('package不存在', !file_exists($S5NA4)); goto eLA12; D8uqi: try { $cLx4V = Artisan::call('migrate'); } catch (\Exception $H8GLS) { $cLx4V = -1; } goto ZPFZk; BLWEW: if (!empty($EKWAX['update'])) { $Gp43V = array_merge($Gp43V, $EKWAX['update']); } goto Hpf6R; CD1Mp: if (!empty($EKWAX['update'])) { goto iDoxz; RFQmy: foreach ($EKWAX['update'] as $rd0Br) { goto SW4G_; MZjp8: FileUtil::write(base_path($rd0Br), $yo_tt); goto hZINg; hZINg: $jUt7q[] = "> {$rd0Br}"; goto vQxGv; SW4G_: $yo_tt = $lBl7m->getFileContent($rd0Br); goto MZjp8; vQxGv: } goto jWqhm; jWqhm: $jUt7q[] = ''; goto zofYW; iDoxz: $jUt7q[] = '修改文件：'; goto RFQmy; zofYW: } goto XLfGk; XLfGk: if (!empty($EKWAX['delete'])) { goto A0tqn; J1WZg: $jUt7q[] = ''; goto ezpBu; A0tqn: $jUt7q[] = '删除文件：'; goto OWc7L; OWc7L: foreach ($EKWAX['delete'] as $rd0Br) { if (file_exists($b8b8j = base_path($rd0Br))) { @unlink($b8b8j); $jUt7q[] = "> {$rd0Br}"; } } goto J1WZg; ezpBu: } goto EvQAZ; ncVzO: $Gp43V = array(); goto aWpGv; Y6Lm3: FileUtil::safeCleanLocalTemp($S5NA4); goto jXTGP; eLA12: BizException::throwsIf('diffContentFile不存在', !file_exists($mc3cG)); goto OfJhN; Hpf6R: $ULXwZ = FileUtil::filePathWritableCheck($Gp43V); goto YGxYG; YGxYG: BizException::throwsIfResponseError($ULXwZ); goto yP3lc; aWpGv: if (!empty($EKWAX['add'])) { $Gp43V = array_merge($Gp43V, $EKWAX['add']); } goto BLWEW; OfJhN: $EKWAX = @json_decode(file_get_contents($mc3cG), true); goto Xhk5M; ZPFZk: BizException::throwsIf('调用 php artisan migrate 失败', 0 != $cLx4V); goto CQaVJ; PYzDz: } }