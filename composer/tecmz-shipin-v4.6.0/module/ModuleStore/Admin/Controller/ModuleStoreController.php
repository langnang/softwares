<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\ModuleStore\Admin\Controller; use Illuminate\Routing\Controller; use ModStart\Admin\Auth\AdminPermission; use ModStart\Admin\Layout\AdminConfigBuilder; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Response; use ModStart\Core\Util\CRUDUtil; use ModStart\Core\Util\FileUtil; use ModStart\Core\Util\ReUtil; use ModStart\Form\Form; use ModStart\Module\ModuleManager; use ModStart\Repository\RepositoryUtil; use Module\ModuleStore\Util\ModuleStoreUtil; class ModuleStoreController extends Controller { public function index() { AdminPermission::permitCheck('ModuleStoreManage'); return view('module::ModuleStore.View.admin.moduleStore.index'); } public function all() { AdminPermission::permitCheck('ModuleStoreManage'); return Response::generateSuccessData(ModuleStoreUtil::all()); } private function moduleOperateCheck($DvHya) { goto MmNvE; rAiUv: $IS5AS = array_map(function ($p4EDY) { return trim($p4EDY); }, explode(',', $IS5AS)); goto zwalN; zwalN: $IS5AS = array_filter($IS5AS); goto gEAxn; m5UsD: if (empty($IS5AS)) { return; } goto rAiUv; TKW51: foreach ($IS5AS as $qlKQK) { if (ReUtil::isWildMatch($qlKQK, $DvHya)) { $VgM9p = true; break; } } goto uVB8v; gEAxn: if (empty($IS5AS)) { return; } goto mgzuL; uVB8v: BizException::throwsIf('只允许操作模块:' . join(',', $IS5AS), !$VgM9p); goto fI2G7; MmNvE: BizException::throwsIf('当前环境禁止「模块管理」相关操作', config('env.MS_MODULE_STORE_DISABLE', false)); goto ZVWq3; ZVWq3: $IS5AS = config('env.MS_MODULE_WHITELIST', ''); goto m5UsD; mgzuL: $VgM9p = false; goto TKW51; fI2G7: } private function doFinish($e7tw9) { return Response::generateSuccessData(array('msg' => array_map(function ($qlKQK) { return '<i class="iconfont icon-hr"></i> ' . $qlKQK; }, $e7tw9), 'finish' => true)); } private function doNext($CrJ7D, $CfYsf, $e7tw9 = array(), $WAiaw = array()) { goto PQDJf; IyQJF: return Response::generateSuccessData(array('msg' => array_map(function ($qlKQK) { if (!starts_with($qlKQK, '<')) { $qlKQK = "<span class='ub-text-white'>{$qlKQK}</span>"; } return '<i class="iconfont icon-hr"></i> ' . $qlKQK; }, $e7tw9), 'command' => $CrJ7D, 'step' => $CfYsf, 'data' => $WAiaw, 'finish' => false)); goto YOOJB; RJiQm: $WAiaw = array_merge($nIp2z->getJsonAsInput('data')->all(), $WAiaw); goto IyQJF; PQDJf: $nIp2z = InputPackage::buildFromInput(); goto RJiQm; YOOJB: } public function disable() { goto wuKLh; V28GF: switch ($CfYsf) { default: goto GILgV; VA0uP: BizException::throwsIfResponseError($ULXwZ); goto Pn_jg; GILgV: $ULXwZ = ModuleManager::disable($DvHya); goto VA0uP; Pn_jg: return $this->doFinish(array('<span class="ub-text-success">禁用成功，请 <a href="javascript:;" onclick="parent.location.reload()">刷新后台</a> 查看最新系统</span>')); goto OLwZD; OLwZD: } goto GbKyp; wuKLh: AdminPermission::permitCheck('ModuleStoreManage'); goto twNR0; ho9uF: BizException::throwsIfEmpty('module为空', $DvHya); goto Jt7Z_; cVyIT: $suowW = $nIp2z->getJsonAsInput('data'); goto ALbQK; ALbQK: $DvHya = $suowW->getTrimString('module'); goto p9kBp; CyT8W: $nIp2z = InputPackage::buildFromInput(); goto rnehZ; TxRbb: $this->moduleOperateCheck($DvHya); goto V28GF; rnehZ: $CfYsf = $nIp2z->getTrimString('step'); goto cVyIT; p9kBp: $h1TN3 = $suowW->getTrimString('version'); goto ho9uF; Jt7Z_: BizException::throwsIfEmpty('version为空', $h1TN3); goto TxRbb; twNR0: AdminPermission::demoCheck(); goto CyT8W; GbKyp: } public function enable() { goto pZiK3; oG5He: switch ($CfYsf) { default: goto Oi_ng; KITHY: BizException::throwsIfResponseError($ULXwZ); goto IRADX; Oi_ng: $ULXwZ = ModuleManager::enable($DvHya); goto KITHY; IRADX: return $this->doFinish(array('<span class="ub-text-success">启动成功，请 <a href="javascript:;" onclick="parent.location.reload()">刷新后台</a> 查看最新系统</span>')); goto tIee8; tIee8: } goto EQi_N; CeyV3: BizException::throwsIfEmpty('version为空', $h1TN3); goto YX4WT; N_3uF: $nIp2z = InputPackage::buildFromInput(); goto xJ6DQ; Q1PfS: $suowW = $nIp2z->getJsonAsInput('data'); goto Vhh91; pZiK3: AdminPermission::permitCheck('ModuleStoreManage'); goto rHk2Z; YX4WT: $this->moduleOperateCheck($DvHya); goto oG5He; rHk2Z: AdminPermission::demoCheck(); goto N_3uF; Rj7uk: $h1TN3 = $suowW->getTrimString('version'); goto opYes; opYes: BizException::throwsIfEmpty('module为空', $DvHya); goto CeyV3; xJ6DQ: $CfYsf = $nIp2z->getTrimString('step'); goto Q1PfS; Vhh91: $DvHya = $suowW->getTrimString('module'); goto Rj7uk; EQi_N: } public function uninstall() { goto ObZgT; p8RO3: $DvHya = $suowW->getTrimString('module'); goto Bvbr9; F7E0i: BizException::throwsIfEmpty('module为空', $DvHya); goto n68f4; UtPUe: $this->moduleOperateCheck($DvHya); goto IsG5l; ObZgT: AdminPermission::permitCheck('ModuleStoreManage'); goto WlE6u; h3JhK: $nIp2z = InputPackage::buildFromInput(); goto Bi2ar; JlJ2i: $suowW = $nIp2z->getJsonAsInput('data'); goto p8RO3; IsG5l: if ($e2GGo) { switch ($CfYsf) { default: goto kAhZg; Aq9A6: return $this->doFinish(array('<span class="ub-text-success">卸载完成，请 <a href="javascript:;" onclick="parent.location.reload()">刷新后台</a> 查看最新系统</span>')); goto KVLU0; tmpHN: BizException::throwsIfResponseError($ULXwZ); goto Aq9A6; kAhZg: $ULXwZ = ModuleManager::uninstall($DvHya); goto tmpHN; KVLU0: } } else { switch ($CfYsf) { case 'removePackage': goto YLR_2; YLR_2: $ULXwZ = ModuleStoreUtil::removeModule($DvHya, $h1TN3); goto FwxFz; FwxFz: BizException::throwsIfResponseError($ULXwZ); goto j5zDx; j5zDx: return $this->doFinish(array('<span class="ub-text-success">卸载完成，请 <a href="javascript:;" onclick="parent.location.reload()">刷新后台</a> 查看最新系统</span>')); goto yiada; yiada: default: goto Dwehx; WDol7: BizException::throwsIfResponseError($ULXwZ); goto Kh_3g; Dwehx: $ULXwZ = ModuleManager::uninstall($DvHya); goto WDol7; Kh_3g: return $this->doNext('uninstall', 'removePackage', array('<span class="ub-text-success">开始卸载 ' . $DvHya . ' V' . $h1TN3 . '</span>')); goto JBrZu; JBrZu: } } goto FPhow; bFbed: $e2GGo = $suowW->getBoolean('isLocal'); goto F7E0i; HLOsS: BizException::throwsIf('系统模块不能动态配置', ModuleManager::isSystemModule($DvHya)); goto UtPUe; Bi2ar: $CfYsf = $nIp2z->getTrimString('step'); goto JlJ2i; WlE6u: AdminPermission::demoCheck(); goto h3JhK; Bvbr9: $h1TN3 = $suowW->getTrimString('version'); goto bFbed; n68f4: BizException::throwsIfEmpty('version为空', $h1TN3); goto HLOsS; FPhow: } public function upgrade() { goto HVnKS; DL8OY: $suowW = $nIp2z->getJsonAsInput('data'); goto nDhEh; deszJ: $CfYsf = $nIp2z->getTrimString('step'); goto liLcp; cAfPI: AdminPermission::demoCheck(); goto eUgPt; OLce5: switch ($CfYsf) { case 'installModule': goto hnSE7; JR3lb: return $this->doFinish(array('<span class="ub-text-success">升级安装完成，请 <a href="javascript:;" onclick="parent.location.reload()">刷新后台</a> 查看最新系统</span>')); goto px_v1; VGvu6: BizException::throwsIfResponseError($ULXwZ); goto C4kSk; hnSE7: $ULXwZ = ModuleManager::install($DvHya, true); goto VGvu6; C4kSk: $ULXwZ = ModuleManager::enable($DvHya); goto FwpUb; FwpUb: BizException::throwsIfResponseError($ULXwZ); goto JR3lb; px_v1: case 'unpackPackage': goto o4xaf; B1qKU: BizException::throwsIfEmpty('package为空', $S5NA4); goto lKsxP; sjD87: try { $ULXwZ = ModuleStoreUtil::unpackModule($DvHya, $S5NA4, $u4IvZ); } catch (\Exception $H8GLS) { ModuleStoreUtil::cleanDownloadedPackage($S5NA4); throw $H8GLS; } goto O30RP; O30RP: BizException::throwsIfResponseError($ULXwZ); goto VBdoq; o4xaf: $S5NA4 = $suowW->getTrimString('package'); goto B1qKU; lKsxP: $u4IvZ = $suowW->getTrimString('licenseKey'); goto IH7XI; VBdoq: return $this->doNext('upgrade', 'installModule', array_merge(array('<span class="ub-text-success">模块解压完成</span>', '<span class="ub-text-white">开始安装...</span>'), $ULXwZ['data'])); goto u117v; IH7XI: BizException::throwsIfEmpty('licenseKey为空', $u4IvZ); goto sjD87; u117v: case 'downloadPackage': goto B7jV_; B7jV_: $ULXwZ = ModuleStoreUtil::downloadPackage($nxg8F, $DvHya, $h1TN3); goto FDzWe; ES5xE: return $this->doNext('upgrade', 'unpackPackage', array('<span class="ub-text-success">获取安装包完成，大小 ' . FileUtil::formatByte($ULXwZ['data']['packageSize']) . '</span>', '<span class="ub-text-white">开始解压安装包...</span>'), array('package' => $ULXwZ['data']['package'], 'licenseKey' => $ULXwZ['data']['licenseKey'])); goto oM_6n; FDzWe: BizException::throwsIfResponseError($ULXwZ); goto ES5xE; oM_6n: case 'checkPackage': goto X70iO; ZimvX: if ($ULXwZ['data']['errorCount'] > 0) { return $this->doFinish(array_merge($e7tw9, array('<span class="ub-text-danger">预检失败，' . $ULXwZ['data']['errorCount'] . '个依赖不满足要求</span>'))); } goto VcWQ3; SQ3rn: return $this->doNext('upgrade', 'downloadPackage', array_merge(array('PHP版本: v' . PHP_VERSION, '<span class="ub-text-success">预检成功，' . count($ULXwZ['data']['requires']) . '个依赖满足要求，安装包大小 ' . FileUtil::formatByte($ULXwZ['data']['packageSize']) . '</span>'), $e7tw9)); goto rp2IB; wfX21: BizException::throwsIfResponseError($ULXwZ); goto tkMhR; hn81K: foreach ($ULXwZ['data']['requires'] as $lZ9mO) { $e7tw9[] = '<span>&nbsp;&nbsp;</span>' . ($lZ9mO['success'] ? '<span class="ub-text-success"><i class="iconfont icon-check"></i> 成功</span>' : '<span class="ub-text-danger"><i class="iconfont icon-warning"></i> 失败</span>') . " <span>{$lZ9mO['name']}</span> " . ($lZ9mO['resolve'] ? " <span>解决：{$lZ9mO['resolve']}</span>" : ''); } goto ZimvX; tkMhR: $e7tw9 = array(); goto hn81K; X70iO: $ULXwZ = ModuleStoreUtil::checkPackage($nxg8F, $DvHya, $h1TN3); goto wfX21; VcWQ3: $e7tw9[] = '<span class="ub-text-white">开始下载安装包...</span>'; goto SQ3rn; rp2IB: default: return $this->doNext('upgrade', 'checkPackage', array('<span class="ub-text-success">开始升级到远程模块 ' . $DvHya . ' V' . $h1TN3 . '</span>', '<span class="ub-text-white">开始模块安装预检...</span>')); } goto cqJZA; sr9Nb: $h1TN3 = $suowW->getTrimString('version'); goto o0f2F; liLcp: BizException::throwsIfEmpty('请先登录ModStartCMS账号', $nxg8F); goto DL8OY; nDhEh: $DvHya = $suowW->getTrimString('module'); goto sr9Nb; um8gd: $this->moduleOperateCheck($DvHya); goto OLce5; o0f2F: BizException::throwsIfEmpty('module为空', $DvHya); goto JaddB; HVnKS: AdminPermission::permitCheck('ModuleStoreManage'); goto cAfPI; lz3Rq: $nxg8F = $nIp2z->getTrimString('token'); goto deszJ; JaddB: BizException::throwsIfEmpty('version为空', $h1TN3); goto um8gd; eUgPt: $nIp2z = InputPackage::buildFromInput(); goto lz3Rq; cqJZA: } public function install() { goto u8XBh; kNFG8: if ($e2GGo) { switch ($CfYsf) { case 'installModule': goto sWEq_; f_20L: $ULXwZ = ModuleManager::enable($DvHya); goto r4NC1; oXUeU: return $this->doFinish(array('<span class="ub-text-success">安装完成，请 <a href="javascript:;" onclick="parent.location.reload()">刷新后台</a> 查看最新系统</span>')); goto eDKQB; sWEq_: $ULXwZ = ModuleManager::install($DvHya, true); goto Lyw29; r4NC1: BizException::throwsIfResponseError($ULXwZ); goto oXUeU; Lyw29: BizException::throwsIfResponseError($ULXwZ); goto f_20L; eDKQB: default: return $this->doNext('install', 'installModule', array('<span class="ub-text-success">开始安装本地模块 ' . $DvHya . ' V' . $h1TN3 . '</span>', '<span class="ub-text-white">开始安装..</span>')); } } else { switch ($CfYsf) { case 'installModule': goto RE1lm; xGRzm: return $this->doFinish(array('<span class="ub-text-success">安装完成，请 <a href="javascript:;" onclick="parent.location.reload()">刷新后台</a> 查看最新系统</span>')); goto Gm3u2; K7baV: if (Response::isError($ULXwZ)) { ModuleManager::clean($DvHya); BizException::throws($ULXwZ['msg']); } goto cbSHB; RE1lm: $ULXwZ = ModuleManager::install($DvHya, true); goto K7baV; bqNBX: BizException::throwsIfResponseError($ULXwZ); goto xGRzm; cbSHB: $ULXwZ = ModuleManager::enable($DvHya); goto bqNBX; Gm3u2: case 'unpackPackage': goto dfua8; EfT8C: BizException::throwsIfResponseError($ULXwZ); goto yA3Nm; sPYwK: BizException::throwsIfEmpty('package为空', $S5NA4); goto S2D8m; S2D8m: $u4IvZ = $suowW->getTrimString('licenseKey'); goto cp5aQ; cp5aQ: BizException::throwsIfEmpty('licenseKey为空', $u4IvZ); goto xuTYz; yA3Nm: return $this->doNext('install', 'installModule', array_merge(array('<span class="ub-text-success">模块解压完成</span>', '<span class="ub-text-white">开始安装...</span>'), $ULXwZ['data'])); goto xiojS; dfua8: $S5NA4 = $suowW->getTrimString('package'); goto sPYwK; xuTYz: try { $ULXwZ = ModuleStoreUtil::unpackModule($DvHya, $S5NA4, $u4IvZ); } catch (\Exception $H8GLS) { ModuleStoreUtil::cleanDownloadedPackage($S5NA4); throw $H8GLS; } goto EfT8C; xiojS: case 'downloadPackage': goto cpPjm; hMCeQ: BizException::throwsIfResponseError($ULXwZ); goto iUeii; iUeii: return $this->doNext('install', 'unpackPackage', array('<span class="ub-text-success">获取安装包完成，大小 ' . FileUtil::formatByte($ULXwZ['data']['packageSize']) . '</span>', '<span class="ub-text-white">开始解压安装包...</span>'), array('package' => $ULXwZ['data']['package'], 'licenseKey' => $ULXwZ['data']['licenseKey'])); goto dxAhV; cpPjm: $ULXwZ = ModuleStoreUtil::downloadPackage($nxg8F, $DvHya, $h1TN3); goto hMCeQ; dxAhV: case 'checkPackage': goto k0oMv; IXqaJ: if ($ULXwZ['data']['errorCount'] > 0) { return $this->doFinish(array_merge($e7tw9, array('<span class="ub-text-danger">预检失败，' . $ULXwZ['data']['errorCount'] . '个依赖不满足要求</span>'))); } goto isKKU; J1dLh: $e7tw9 = array(); goto m6Fdx; m6Fdx: foreach ($ULXwZ['data']['requires'] as $lZ9mO) { $e7tw9[] = '<span>&nbsp;&nbsp;</span>' . ($lZ9mO['success'] ? '<span class="ub-text-success"><i class="iconfont icon-check"></i> 成功</span>' : '<span class="ub-text-danger"><i class="iconfont icon-warning"></i> 失败</span>') . " <span>{$lZ9mO['name']}</span> " . ($lZ9mO['resolve'] ? " <span>解决：{$lZ9mO['resolve']}</span>" : ''); } goto IXqaJ; k0oMv: $ULXwZ = ModuleStoreUtil::checkPackage($nxg8F, $DvHya, $h1TN3); goto EX75g; isKKU: $e7tw9[] = '<span class="ub-text-white">开始下载安装包...</span>'; goto F4ZfY; EX75g: BizException::throwsIfResponseError($ULXwZ); goto J1dLh; dKUa3: break; goto rmVVe; F4ZfY: return $this->doNext('install', 'downloadPackage', array_merge(array('PHP版本: v' . PHP_VERSION, '<span class="ub-text-success">预检成功，' . count($ULXwZ['data']['requires']) . '个依赖满足要求，安装包大小 ' . FileUtil::formatByte($ULXwZ['data']['packageSize']) . '</span>'), $e7tw9)); goto dKUa3; rmVVe: default: return $this->doNext('install', 'checkPackage', array('<span class="ub-text-success">开始安装远程模块 ' . $DvHya . ' V' . $h1TN3 . '</span>', '<span class="ub-text-white">开始模块安装预检...</span>')); } } goto mhHEF; m4ZxU: $this->moduleOperateCheck($DvHya); goto kNFG8; Cmzrb: BizException::throwsIf('系统模块不能动态配置', ModuleManager::isSystemModule($DvHya)); goto m4ZxU; QwZey: $h1TN3 = $suowW->getTrimString('version'); goto a7cVc; bCe5L: $nIp2z = InputPackage::buildFromInput(); goto aPy8z; sSMpJ: BizException::throwsIfEmpty('请先登录ModStartCMS账号', $nxg8F); goto rpIXf; KljaK: BizException::throwsIfEmpty('module为空', $DvHya); goto H0Bx2; k4G2F: $DvHya = $suowW->getTrimString('module'); goto QwZey; pmQcx: $CfYsf = $nIp2z->getTrimString('step'); goto sSMpJ; a7cVc: $e2GGo = $suowW->getBoolean('isLocal'); goto KljaK; rpIXf: $suowW = $nIp2z->getJsonAsInput('data'); goto k4G2F; NExR0: AdminPermission::demoCheck(); goto bCe5L; aPy8z: $nxg8F = $nIp2z->getTrimString('token'); goto pmQcx; u8XBh: AdminPermission::permitCheck('ModuleStoreManage'); goto NExR0; H0Bx2: BizException::throwsIfEmpty('version为空', $h1TN3); goto Cmzrb; mhHEF: } public function config(AdminConfigBuilder $Jf1S7, $DvHya) { goto MZjmZ; mlgpz: BizException::throwsIfEmpty('Module config error', $J5GyQ['config']); goto d1hyR; GhvPS: $J5GyQ = ModuleManager::getModuleBasic($DvHya); goto IvRBK; d1hyR: foreach ($J5GyQ['config'] as $F66vY => $SBiS6) { goto uzc0s; uzc0s: $gxoEj = null; goto m8Ss4; eXBC4: foreach ($SBiS6 as $j2fcZ) { $FPiC8 = array_shift($j2fcZ); if (null === $gxoEj) { array_unshift($j2fcZ, $F66vY); $gxoEj = call_user_func(array($Jf1S7, $FPiC8), ...$j2fcZ); } else { call_user_func(array($gxoEj, $FPiC8), ...$j2fcZ); } } goto dtGPd; m8Ss4: if (!isset($Z9dF0['config'][$F66vY])) { $Z9dF0['config'][$F66vY] = null; } goto eXBC4; dtGPd: } goto XoLAa; XoLAa: return $Jf1S7->perform(RepositoryUtil::itemFromArray($Z9dF0['config']), function (Form $oqTbu) use($DvHya, $Z9dF0) { AdminPermission::demoCheck(); if ($Z9dF0['isSystem']) { ModuleManager::saveSystemOverwriteModuleConfig($DvHya, $oqTbu->dataForming()); } else { ModuleManager::saveUserInstalledModuleConfig($DvHya, $oqTbu->dataForming()); } return Response::generate(0, '保存成功', null, CRUDUtil::jsDialogClose()); }); goto dpFDQ; UX5Yl: $Jf1S7->pageTitle(htmlspecialchars($J5GyQ['title']) . ' ' . L('Module Config')); goto lRk8y; lRk8y: $Z9dF0 = ModuleManager::getInstalledModuleInfo($DvHya); goto mlgpz; MZjmZ: AdminPermission::permitCheck('ModuleStoreManage'); goto GhvPS; IvRBK: $Jf1S7->useDialog(); goto UX5Yl; dpFDQ: } }