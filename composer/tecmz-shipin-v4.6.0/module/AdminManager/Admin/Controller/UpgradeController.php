<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\AdminManager\Admin\Controller; use App\Constant\AppConstant; use Illuminate\Routing\Controller; use Illuminate\Support\Facades\Artisan; use ModStart\Admin\Auth\AdminPermission; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Core\Util\FileUtil; use Module\AdminManager\Util\ModuleUtil; use Module\AdminManager\Util\UpgradeUtil; class UpgradeController extends Controller { public static $PermitMethodMap = array('index' => '@SystemUpgrade', 'info' => '@SystemUpgrade', 'auth' => '@SystemUpgrade'); private function doFinish($e7tw9, $jUt7q = null) { return Response::generateSuccessData(array('msg' => array_map(function ($qlKQK) { return '<i class="iconfont icon-hr"></i> ' . $qlKQK; }, $e7tw9), 'logs' => $jUt7q, 'finish' => true)); } private function doNext($CfYsf, $e7tw9 = array(), $WAiaw = array()) { goto sxHSQ; sxHSQ: $nIp2z = InputPackage::buildFromInput(); goto WB2EF; WB2EF: $WAiaw = array_merge($nIp2z->getJsonAsInput('data')->all(), $WAiaw); goto kBcVj; kBcVj: return Response::generateSuccessData(array('msg' => array_map(function ($qlKQK) { if (!starts_with($qlKQK, '<')) { $qlKQK = "<span class='ub-text-white'>{$qlKQK}</span>"; } return '<i class="iconfont icon-hr"></i> ' . $qlKQK; }, $e7tw9), 'step' => $CfYsf, 'data' => $WAiaw, 'finish' => false)); goto PWCIu; PWCIu: } public function index() { goto W_Fjo; IOX2G: return view('module::AdminManager.View.admin.upgrade'); goto vuSHO; Qe2G9: if (Request::isPost()) { goto V24F2; ZKOg2: $suowW = $nIp2z->getJsonAsInput('data'); goto u7FI1; UjwAG: BizException::throwsIfEmpty('toVersion为空', $JaZ3s); goto LfNzO; YMxk6: $nIp2z = InputPackage::buildFromInput(); goto KkO22; LfNzO: switch ($CfYsf) { case 'upgradePackage': goto EMvll; wQlXy: $ULXwZ = UpgradeUtil::upgradePackage($S5NA4, $mc3cG); goto s023G; s023G: BizException::throwsIfResponseError($ULXwZ); goto xCO_4; xCO_4: return $this->doFinish(array('<span class="ub-text-success">升级完成，请 <a href="javascript:;" onclick="window.location.reload()">刷新后台</a> 查看最新系统</span>'), $ULXwZ['data']['logs']); goto pAtGG; EMvll: $S5NA4 = $suowW->getTrimString('package'); goto WFdWQ; WE2fD: BizException::throwsIfEmpty('package为空', $S5NA4); goto r0F6n; WFdWQ: $mc3cG = $suowW->getTrimString('diffContentFile'); goto WE2fD; r0F6n: BizException::throwsIfEmpty('diffContentFile为空', $mc3cG); goto wQlXy; pAtGG: case 'downloadPackage': goto rqAsq; lPO5n: BizException::throwsIfResponseError($ULXwZ); goto n2mho; rqAsq: $ULXwZ = UpgradeUtil::downloadPackage($nxg8F, AppConstant::APP, AppConstant::VERSION, $JaZ3s); goto lPO5n; n2mho: return $this->doNext('upgradePackage', array('<span class="ub-text-success">获取安装包完成，大小 ' . FileUtil::formatByte($ULXwZ['data']['packageSize']) . '</span>', '<span class="ub-text-white">开始解压升级装包...</span>'), array('package' => $ULXwZ['data']['package'], 'diffContentFile' => $ULXwZ['data']['diffContentFile'])); goto dNGwS; dNGwS: case 'checkPackage': goto l6Eb8; l6Eb8: try { $cLx4V = Artisan::call('migrate'); } catch (\Exception $H8GLS) { $cLx4V = -1; } goto EKRQH; VxBL4: return $this->doNext('downloadPackage', array('PHP版本: v' . PHP_VERSION, '<span class="ub-text-success">预检通过</span>', '<span class="ub-text-white">开始下载升级包...</span>')); goto sH0LI; EKRQH: BizException::throwsIf('调用 php artisan 命令失败，不能自动升级', 0 != $cLx4V); goto VxBL4; sH0LI: default: return $this->doNext('checkPackage', array('<span class="ub-text-success">开始升级系统，从 V' . AppConstant::VERSION . ' 到 V' . $JaZ3s . '</span>', '<span class="ub-text-white">开始预检系统...</span>')); } goto RbOVz; V24F2: AdminPermission::demoCheck(); goto YMxk6; aYC7v: $nxg8F = $nIp2z->getTrimString('token'); goto ZKOg2; u7FI1: $JaZ3s = $suowW->getTrimString('toVersion'); goto UjwAG; KkO22: $CfYsf = $nIp2z->getTrimString('step'); goto aYC7v; RbOVz: } goto IOX2G; W_Fjo: if (config('modstart.admin.upgradeDisable', false)) { return Response::sendError('系统升级功能已关闭'); } goto Qe2G9; vuSHO: } public function auth() { return view('module::AdminManager.View.admin.auth', array('modules' => ModuleUtil::modules())); } public function info() { $W1tj0 = UpgradeUtil::latest(); return Response::generateSuccessData(array('version' => AppConstant::VERSION, 'latestVersion' => $W1tj0['latestVersion'], 'autoUpgrade' => $W1tj0['autoUpgrade'])); } }