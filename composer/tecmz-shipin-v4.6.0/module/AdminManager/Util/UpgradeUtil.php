<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\AdminManager\Util; use App\Constant\AppConstant; use Chumper\Zipper\Zipper; use Illuminate\Support\Facades\Artisan; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Response; use ModStart\Core\Util\CurlUtil; use ModStart\Core\Util\FileUtil; use ModStart\ModStart; class UpgradeUtil { const REMOTE_BASE = 'https://modstart.com'; private static function baseRequest($ELIlU, $WAiaw = array(), $nxg8F = null) { return CurlUtil::postJSONBody(self::REMOTE_BASE . $ELIlU, $WAiaw, array('header' => array('api-token' => $nxg8F, 'X-Requested-With' => 'XMLHttpRequest'))); } public static function latest() { goto eOM3A; ycRRQ: return $ULXwZ['data']; goto u_NUi; eubB2: BizException::throwsIfResponseError($ULXwZ); goto ycRRQ; eOM3A: $ULXwZ = self::baseRequest('/api/app/latest', array('app' => AppConstant::APP, 'version' => AppConstant::VERSION)); goto eubB2; u_NUi: } public static function downloadPackage($nxg8F, $ye3vG, $Q_thE, $JaZ3s) { goto Vwu70; M8YxJ: $JmKWs = $ULXwZ['data']['packageMd5']; goto TVxrZ; rNnnx: $mc3cG = FileUtil::generateLocalTempPath('json'); goto BnLNz; vnKlS: BizException::throwsIfEmpty('安装包获取失败', $WAiaw); goto WEaTJ; WEaTJ: $QkQlj = FileUtil::generateLocalTempPath('zip'); goto bVdQc; bnY_i: $WAiaw = CurlUtil::getRaw($S5NA4); goto vnKlS; Vwu70: $ULXwZ = self::baseRequest('/api/app/download_package', array('app' => $ye3vG, 'fromVersion' => $Q_thE, 'toVersion' => $JaZ3s), $nxg8F); goto w9gU8; nCG2s: $S5NA4 = $ULXwZ['data']['package']; goto M8YxJ; Lof40: return Response::generateSuccessData(array('diffContentFile' => $mc3cG, 'package' => $QkQlj, 'packageSize' => filesize($QkQlj))); goto bklCD; ByqS4: BizException::throwsIf('文件MD5校验失败', md5_file($QkQlj) != $JmKWs); goto rNnnx; TVxrZ: $EKWAX = $ULXwZ['data']['diffContent']; goto bnY_i; BnLNz: file_put_contents($mc3cG, $EKWAX); goto Lof40; bVdQc: file_put_contents($QkQlj, $WAiaw); goto ByqS4; w9gU8: BizException::throwsIfResponseError($ULXwZ); goto nCG2s; bklCD: } public static function upgradePackage($S5NA4, $mc3cG) { goto nuHGG; O7OUZ: BizException::throwsIf('diffContent为空', empty($EKWAX)); goto Jo7VI; Pn6zL: if (!empty($EKWAX['update'])) { goto X_GH4; X_GH4: $jUt7q[] = '修改文件：'; goto aBkBI; aBkBI: foreach ($EKWAX['update'] as $rd0Br) { goto jXoiQ; X8i1Y: FileUtil::write(base_path($rd0Br), $yo_tt); goto b3t63; jXoiQ: $yo_tt = $lBl7m->getFileContent($rd0Br); goto X8i1Y; b3t63: $jUt7q[] = "> {$rd0Br}"; goto cv47w; cv47w: } goto oehgu; oehgu: $jUt7q[] = ''; goto YQNmz; YQNmz: } goto xzAvp; kXNRF: if (!empty($EKWAX['update'])) { $Gp43V = array_merge($Gp43V, $EKWAX['update']); } goto VQLeM; SGlZx: BizException::throwsIf('diffContentFile不存在', !file_exists($mc3cG)); goto FX39R; U2UkJ: return Response::generateSuccessData(array('logs' => $jUt7q)); goto mcZ08; VQLeM: $ULXwZ = FileUtil::filePathWritableCheck($Gp43V); goto OAf7X; r716h: $lBl7m->make($S5NA4); goto GfQo8; oh655: if (!empty($EKWAX['add'])) { goto BW9rK; BW9rK: $jUt7q[] = '新增文件：'; goto ezGjR; ezGjR: foreach ($EKWAX['add'] as $rd0Br) { goto SVj1i; KBYmb: FileUtil::write(base_path($rd0Br), $yo_tt); goto mGGuz; SVj1i: $yo_tt = $lBl7m->getFileContent($rd0Br); goto KBYmb; mGGuz: $jUt7q[] = "> {$rd0Br}"; goto u7WMK; u7WMK: } goto AKa3A; AKa3A: $jUt7q[] = ''; goto E2I8j; E2I8j: } goto Pn6zL; a1B0s: $lBl7m->close(); goto J3xN7; dNlGF: if (!empty($EKWAX['add'])) { $Gp43V = array_merge($Gp43V, $EKWAX['add']); } goto kXNRF; nuHGG: BizException::throwsIf('package不存在', !file_exists($S5NA4)); goto SGlZx; Jo7VI: $Gp43V = array(); goto dNlGF; FX39R: $EKWAX = @json_decode(file_get_contents($mc3cG), true); goto O7OUZ; K0qBf: BizException::throwsIf('调用 php artisan migrate 失败', 0 != $cLx4V); goto YCFW1; jXzDh: BizException::throwsIf('调用 php artisan modstart:module-install-all 失败', 0 != $cLx4V); goto sV2iD; YCFW1: $cLx4V = Artisan::call('modstart:module-install-all'); goto jXzDh; xzAvp: if (!empty($EKWAX['delete'])) { goto nr68z; ioC_N: $jUt7q[] = ''; goto Nx5Tt; nr68z: $jUt7q[] = '删除文件：'; goto vamer; vamer: foreach ($EKWAX['delete'] as $rd0Br) { if (file_exists($b8b8j = base_path($rd0Br))) { @unlink($b8b8j); $jUt7q[] = "> {$rd0Br}"; } } goto ioC_N; Nx5Tt: } goto a1B0s; sV2iD: FileUtil::safeCleanLocalTemp($S5NA4); goto SPjhD; vR4yu: $lBl7m = new Zipper(); goto r716h; SPjhD: FileUtil::safeCleanLocalTemp($mc3cG); goto U2UkJ; OAf7X: BizException::throwsIfResponseError($ULXwZ); goto vR4yu; ftH4f: try { $cLx4V = Artisan::call('migrate'); } catch (\Exception $H8GLS) { $cLx4V = -1; } goto K0qBf; J3xN7: ModStart::clearCache(); goto ftH4f; GfQo8: $jUt7q = array(); goto oh655; mcZ08: } }