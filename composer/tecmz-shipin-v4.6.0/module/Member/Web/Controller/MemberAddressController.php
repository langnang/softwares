<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Web\Controller; use Illuminate\Support\Facades\View; use ModStart\App\Web\Layout\WebConfigBuilder; use ModStart\App\Web\Layout\WebPage; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Core\Util\ArrayUtil; use ModStart\Core\Util\CRUDUtil; use ModStart\Field\AbstractField; use ModStart\Field\AutoRenderedFieldValue; use ModStart\Form\Form; use ModStart\Grid\Grid; use ModStart\Grid\GridFilter; use ModStart\Module\ModuleManager; use ModStart\Repository\Filter\RepositoryFilter; use Module\Member\Auth\MemberUser; use Module\Member\Support\MemberLoginCheck; class MemberAddressController extends MemberFrameController implements MemberLoginCheck { private $api; public function __construct() { parent::__construct(); $this->api = app(\Module\Member\Api\Controller\MemberAddressController::class); } public function index(WebPage $H1G2d) { goto WIE1P; WIE1P: $RZHSW = Grid::make('member_address'); goto IwmX3; gysrZ: return $H1G2d->view($M1iJt)->pageTitle('我的地址')->body($RZHSW); goto A3lYa; Ty2pS: $RZHSW->disableCUD()->disableItemOperate()->canAdd(true)->urlAdd(action('\\' . __CLASS__ . '@add'))->addDialogSize(array('60%', '80%')); goto zYcpt; TdjA7: $RZHSW->title('地址'); goto DDXa9; DDXa9: if (Request::isPost()) { return $RZHSW->request(); } goto GaCh_; IwmX3: $RZHSW->repositoryFilter(function (RepositoryFilter $XM5aD) { $XM5aD->where(array('memberUserId' => MemberUser::id())); }); goto Ty2pS; zYcpt: $RZHSW->useSimple(function (AbstractField $gxoEj, $qlKQK, $mlRDG) { return AutoRenderedFieldValue::makeView('module::Member.View.pc.memberAddress.item', array('item' => $qlKQK)); }); goto TdjA7; GaCh_: list($M1iJt, $eEo37) = $this->viewPaths('memberAddress.index'); goto gysrZ; A3lYa: } private function doAddEdit() { goto KVbIc; MWuUU: $Jf1S7->text('post', '邮政编码'); goto GS7fr; guLf3: $Jf1S7->text('phone', '手机号')->required(); goto cRdnC; BprRC: $Jf1S7 = app(WebConfigBuilder::class); goto r1Zjx; cRdnC: if (ModuleManager::isModuleEnabled('Area')) { $Jf1S7->areaChina('area', '省市地区')->required(); } else { $DxTaI = '<div class=\'tw-bg-gray-200 tw-rounded tw-px-2\'>省市地区需要依赖 <a href=\'https://modstart.com/m/Area\' target=\'_blank\'>Area</a> 模块</div>'; $Jf1S7->html('area', '省市地区')->html($DxTaI)->addable(true)->required(); } goto wMMbH; r1Zjx: $Jf1S7->useDialog(); goto d1iYa; c0EIo: if ($wQ1uv) { $HuFy_ = ModelUtil::get('member_address', array('id' => $wQ1uv, 'memberUserId' => MemberUser::id())); BizException::throwsIfEmpty('地址不存在', $HuFy_); } goto BprRC; wMMbH: $Jf1S7->textarea('detail', '详细地址')->required(); goto MWuUU; GS7fr: return $Jf1S7->perform(ArrayUtil::keepKeys($HuFy_, array('name', 'phone', 'area', 'detail', 'post')), function (Form $oqTbu) use($wQ1uv) { $WAiaw = $oqTbu->dataForming(); if ($wQ1uv) { ModelUtil::update('member_address', $wQ1uv, $WAiaw); } else { $WAiaw['memberUserId'] = MemberUser::id(); ModelUtil::insert('member_address', $WAiaw); } return Response::redirect(CRUDUtil::jsDialogCloseAndParentGridRefresh()); }); goto mWk_O; KVbIc: $wQ1uv = CRUDUtil::id(); goto tqRFM; E92nn: $Jf1S7->text('name', '姓名')->required(); goto guLf3; tqRFM: $HuFy_ = null; goto c0EIo; d1iYa: $Jf1S7->pageTitle(($wQ1uv ? '修改' : '增加') . '地址'); goto E92nn; mWk_O: } public function add() { return $this->doAddEdit(); } public function edit() { return $this->doAddEdit(); } public function delete() { goto keFg2; keFg2: $wQ1uv = CRUDUtil::id(); goto gnhUx; gnhUx: $HuFy_ = ModelUtil::get('member_address', array('id' => $wQ1uv, 'memberUserId' => MemberUser::id())); goto o4jib; u4G3C: ModelUtil::delete('member_address', $wQ1uv); goto AuYdn; AuYdn: return Response::redirect(CRUDUtil::jsGridRefresh()); goto VzQgU; o4jib: BizException::throwsIfEmpty('地址不存在', $HuFy_); goto u4G3C; VzQgU: } }