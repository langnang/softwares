<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Web\Controller; use Illuminate\Support\Facades\Input; use Illuminate\Support\Facades\Session; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Module\ModuleBaseController; use Module\Member\Auth\MemberUser; class AuthController extends ModuleBaseController { private $api; public function __construct() { $this->api = app(\Module\Member\Api\Controller\AuthController::class); } public function login() { goto lYk9M; dZb0a: if (modstart_config('Member_LoginPhoneEnable', false)) { $xbwNm = modstart_config('Member_LoginDefault', 'default'); if ('phone' == $xbwNm) { $rSsaW = $nIp2z->getBoolean('force', false); if (!$rSsaW) { return Response::redirect(modstart_web_url('login/phone', array('redirect' => $R7X4g, 'dialog' => $JTDDw))); } } } goto Wu7E9; MKUMz: if (Request::isPost()) { goto lfdGS; W2hts: if (Response::isError($ULXwZ)) { return Response::sendFromGenerate($ULXwZ); } goto e5iyE; lfdGS: $ULXwZ = $this->api->login(); goto W2hts; Ro7P3: return Response::send(0, '', '', $R7X4g); goto QzPg3; e5iyE: if ($JTDDw) { return Response::send(0, '', '', '[js]parent.location.href=' . json_encode($R7X4g) . ';'); } goto Ro7P3; QzPg3: } goto dZb0a; h36Z6: return $this->view($M1iJt, $Caarc); goto TDFsQ; zsvy5: $R7X4g = $nIp2z->getTrimString('redirect', modstart_web_url('member')); goto snCQg; TXOD8: $this->api->checkRedirectSafety($R7X4g); goto pEo6m; pEo6m: if (modstart_config('ssoClientEnable', false)) { goto QCTNk; QCTNk: Input::merge(array('client' => Request::domainUrl() . '/sso/client')); goto pVTB0; tEHHi: Session::put('ssoClientRedirect', $R7X4g); goto uQ_4Z; pVTB0: $ULXwZ = $this->api->ssoClientPrepare(); goto XfX8r; XfX8r: if ($ULXwZ['code']) { return Response::send(-1, $ULXwZ['msg']); } goto tEHHi; uQ_4Z: return Response::send(0, null, null, $ULXwZ['data']['redirect']); goto shgQN; shgQN: } goto MKUMz; Wu7E9: $M1iJt = 'login'; goto F3w0z; O89HC: if ($JTDDw) { $Caarc['dialog'] = $JTDDw; } goto TXOD8; snCQg: $Caarc = array('redirect' => $R7X4g); goto O89HC; QasIK: $JTDDw = $nIp2z->getInteger('dialog'); goto zsvy5; F3w0z: if ($JTDDw) { $M1iJt = 'loginDialog'; } goto h36Z6; lYk9M: $nIp2z = InputPackage::buildFromInput(); goto QasIK; TDFsQ: } public function loginCaptcha() { return $this->api->loginCaptchaRaw(); } public function loginPhone() { goto VDuP2; IJzdN: $M1iJt = 'loginPhone'; goto zJirV; EEZDB: if (Request::isPost()) { goto e5QIH; IMjzO: if ($JTDDw) { return Response::send(0, '', '', '[js]parent.location.href=' . json_encode($R7X4g) . ';'); } goto hlPGD; e5QIH: $ULXwZ = $this->api->loginPhone(); goto qbLLo; qbLLo: if ($ULXwZ['code']) { return Response::send(-1, $ULXwZ['msg']); } goto IMjzO; hlPGD: return Response::send(0, null, null, $R7X4g); goto hBcX_; hBcX_: } goto IJzdN; D03sM: $JTDDw = $nIp2z->getInteger('dialog'); goto vNbNT; vNbNT: $R7X4g = $nIp2z->getTrimString('redirect', modstart_web_url('member')); goto SyQIh; SyQIh: $Caarc = array('redirect' => $R7X4g); goto WGmVt; zJirV: if ($JTDDw) { $M1iJt = 'loginPhoneDialog'; } goto DRNT0; VDuP2: $nIp2z = InputPackage::buildFromInput(); goto D03sM; DRNT0: return $this->view($M1iJt, $Caarc); goto aeKID; WGmVt: if ($JTDDw) { $Caarc['dialog'] = $JTDDw; } goto qxfAc; qxfAc: $this->api->checkRedirectSafety($R7X4g); goto EEZDB; aeKID: } public function loginPhoneCaptcha() { return $this->api->loginPhoneCaptchaRaw(); } public function loginPhoneVerify() { return Response::sendFromGenerate($this->api->loginPhoneVerify()); } public function logout() { goto KU_VO; lXuyj: $this->api->checkRedirectSafety($R7X4g); goto BZsSk; KU_VO: $nIp2z = InputPackage::buildFromInput(); goto jKRxB; Ua9SH: $R7X4g = $nIp2z->getTrimString('redirect', modstart_web_url('')); goto zssPe; b57o2: if ($ULXwZ['code']) { return Response::send(-1, $ULXwZ['msg']); } goto Rd29f; J1WRB: Session::forget('memberUserId'); goto Ua9SH; jKRxB: $R7X4g = $nIp2z->getTrimString('redirect', modstart_web_url('')); goto lXuyj; zssPe: return Response::redirect($R7X4g); goto Js3Cu; BZsSk: if (modstart_config('ssoClientEnable', false) && modstart_config('ssoClientLogoutSyncEnable', false)) { goto YmFiH; wiX29: $ULXwZ = $this->api->ssoClientLogoutPrepare(); goto UGfxP; qH1yL: Session::put('ssoLogoutRedirect', $R7X4g); goto e5JRX; e5JRX: return Response::send(0, null, null, $ULXwZ['data']['redirect']); goto MGG7D; UGfxP: if ($ULXwZ['code']) { return Response::send(-1, $ULXwZ['msg']); } goto qH1yL; YmFiH: Input::merge(array('domainUrl' => Request::domainUrl())); goto wiX29; MGG7D: } goto cnMsi; cnMsi: $ULXwZ = $this->api->logout(); goto b57o2; Rd29f: $nIp2z = InputPackage::buildFromInput(); goto J1WRB; Js3Cu: } public function register() { goto GG9qE; rqxCc: if ($JTDDw) { $Caarc['dialog'] = $JTDDw; } goto D0VbY; gr11C: $R7X4g = $nIp2z->getTrimString('redirect', modstart_web_url('member')); goto saqsX; adD94: $M1iJt = 'register'; goto c15IJ; D0VbY: if (Request::isPost()) { goto dWDQa; Z3ujT: return Response::send(0, '', '', $JSZCL); goto bmCdU; xQDtx: if ($ULXwZ['code']) { if ($nIp2z->getTrimString('captcha')) { return Response::send(-1, $ULXwZ['msg'], null, '[js]$("[data-captcha]").click()'); } return Response::send(-1, $ULXwZ['msg']); } goto TI20t; TI20t: $JSZCL = modstart_web_url('login', array('redirect' => $R7X4g, 'dialog' => $JTDDw)); goto Z3ujT; dWDQa: $ULXwZ = $this->api->register(); goto xQDtx; bmCdU: } goto SyfY1; SyfY1: if (modstart_config('Member_RegisterPhoneEnable', false)) { $WgOyP = modstart_config('Member_RegisterDefault', 'default'); if ('phone' == $WgOyP) { $rSsaW = $nIp2z->getBoolean('force', false); if (!$rSsaW) { return Response::redirect(modstart_web_url('register/phone', $Caarc)); } } } goto adD94; GG9qE: $nIp2z = InputPackage::buildFromInput(); goto ipBmE; saqsX: $Caarc = array('redirect' => $R7X4g); goto rqxCc; c15IJ: if ($JTDDw) { $M1iJt = 'registerDialog'; } goto thl80; ipBmE: $JTDDw = $nIp2z->getInteger('dialog'); goto gr11C; thl80: return $this->view($M1iJt, $Caarc); goto CXrnL; CXrnL: } public function registerPhone() { goto CwvYB; KeCE1: if (Request::isPost()) { goto ZMPPR; G2gq6: return Response::send(0, null, null, $R7X4g); goto k0bp9; ZMPPR: $ULXwZ = $this->api->registerPhone(); goto Przf4; Przf4: if ($ULXwZ['code']) { return Response::send(-1, $ULXwZ['msg']); } goto G2gq6; k0bp9: } goto coazT; LhsFg: $R7X4g = $nIp2z->getTrimString('redirect', modstart_web_url('member')); goto vioez; vioez: $Caarc = array('redirect' => $R7X4g); goto LOTaw; iFSXy: return $this->view($M1iJt, $Caarc); goto Y1z3T; LOTaw: if ($JTDDw) { $Caarc['dialog'] = $JTDDw; } goto SMdfq; znN5F: $JTDDw = $nIp2z->getInteger('dialog'); goto LhsFg; CwvYB: $nIp2z = InputPackage::buildFromInput(); goto znN5F; SMdfq: $this->api->checkRedirectSafety($R7X4g); goto KeCE1; coazT: $M1iJt = 'registerPhone'; goto y8GSz; y8GSz: if ($JTDDw) { $M1iJt = 'registerPhoneDialog'; } goto iFSXy; Y1z3T: } public function registerEmailVerify() { return Response::sendFromGenerate($this->api->registerEmailVerify()); } public function registerPhoneVerify() { return Response::sendFromGenerate($this->api->registerPhoneVerify()); } public function registerCaptcha() { return $this->api->registerCaptchaRaw(); } public function registerCaptchaVerify() { goto hM7j1; ETTRc: return Response::send(0, $ULXwZ['msg']); goto M9Acl; hM7j1: $ULXwZ = $this->api->registerCaptchaVerify(); goto mB5t2; mB5t2: if ($ULXwZ['code']) { return Response::send(-1, $ULXwZ['msg'], null, '[js]$("[data-captcha]").click()'); } goto ETTRc; M9Acl: } public function retrieve() { goto LTzP4; LTzP4: $nIp2z = InputPackage::buildFromInput(); goto ijVUq; V1l9E: return $this->view('retrieve', array('redirect' => $R7X4g)); goto IYVrA; ijVUq: $R7X4g = $nIp2z->getTrimString('redirect', modstart_web_url('member')); goto V1l9E; IYVrA: } public function retrievePhone() { goto Ljt9J; Ljt9J: $nIp2z = InputPackage::buildFromInput(); goto jRNEc; su20C: if (Request::isPost()) { goto tOuj3; JqaT1: return Response::send(0, $ULXwZ['msg'], null, modstart_web_url('retrieve') . '/reset?redirect=' . urlencode($R7X4g)); goto xg12L; tOuj3: $ULXwZ = $this->api->retrievePhone(); goto btpXQ; btpXQ: if ($ULXwZ['code']) { return Response::send(-1, $ULXwZ['msg']); } goto JqaT1; xg12L: } goto Pb9aU; jRNEc: $R7X4g = $nIp2z->getTrimString('redirect', modstart_web_url('member')); goto su20C; Pb9aU: return $this->view('retrievePhone', array('redirect' => $R7X4g)); goto pBaC3; pBaC3: } public function retrievePhoneVerify() { return Response::sendFromGenerate($this->api->retrievePhoneVerify()); } public function retrieveEmail() { goto mZ3fm; UJXlH: $R7X4g = $nIp2z->getTrimString('redirect', modstart_web_url('member')); goto aCWut; mZ3fm: $nIp2z = InputPackage::buildFromInput(); goto UJXlH; aCWut: if (Request::isPost()) { goto tpFrD; tpFrD: $ULXwZ = $this->api->retrieveEmail(); goto qxLQg; qxLQg: if ($ULXwZ['code']) { return Response::send(-1, $ULXwZ['msg']); } goto MbW_I; MbW_I: return Response::send(0, $ULXwZ['msg'], null, modstart_web_url('retrieve') . '/reset?redirect=' . urlencode($R7X4g)); goto U1K4E; U1K4E: } goto DWBk5; DWBk5: return $this->view('retrieveEmail', array('redirect' => $R7X4g)); goto Qnl60; Qnl60: } public function retrieveEmailVerify() { return Response::sendFromGenerate($this->api->retrieveEmailVerify()); } public function retrieveCaptcha() { return $this->api->retrieveCaptchaRaw(); } public function retrieveReset() { goto nxcXI; CZNK9: if ($ULXwZ['code']) { return Response::send(-1, $ULXwZ['msg']); } goto hfCyh; pNj80: $R7X4g = $nIp2z->getTrimString('redirect', modstart_web_url('member')); goto S2AVJ; nxcXI: $nIp2z = InputPackage::buildFromInput(); goto pNj80; hfCyh: return $this->view('retrieveReset', array('redirect' => $R7X4g, 'memberUser' => $ULXwZ['data']['memberUser'])); goto fhPjf; S2AVJ: if (Request::isPost()) { goto jRKFu; ZSsI_: return Response::send(0, $ULXwZ['msg'], null, $R7X4g); goto V9FtA; jRKFu: $ULXwZ = $this->api->retrieveReset(); goto TyLRv; TyLRv: if ($ULXwZ['code']) { return Response::send(-1, $ULXwZ['msg']); } goto ZSsI_; V9FtA: } goto gWBFR; gWBFR: $ULXwZ = $this->api->retrieveResetInfo(); goto CZNK9; fhPjf: } public function oauthLogin($bMuGA = null) { goto fCIZW; oFB0T: if ($ULXwZ['code']) { return Response::send(-1, $ULXwZ['msg']); } goto n6_sG; fCIZW: $nIp2z = InputPackage::buildFromInput(); goto Tpocq; xV021: $ULXwZ = $this->api->oauthLogin($bMuGA, $LcMnE); goto oFB0T; pcyW3: $LcMnE = Request::domainUrl() . '/oauth_callback_' . $bMuGA; goto xV021; n6_sG: Session::put('oauthRedirect', $R7X4g); goto iRULL; C4Qh0: $this->api->checkRedirectSafety($R7X4g); goto pcyW3; Tpocq: $M1iJt = $nIp2z->getBoolean('view', false); goto XQjeQ; XQjeQ: if ($M1iJt) { Session::put('oauthLoginView', true); } goto gj4jv; iRULL: return Response::redirect($ULXwZ['data']['redirect']); goto tpwI8; gj4jv: $R7X4g = $nIp2z->getTrimString('redirect', modstart_web_url('member')); goto C4Qh0; tpwI8: } public function oauthCallback($bMuGA = null) { goto BhvkI; ELmmI: $ULXwZ = $this->api->oauthCallback($bMuGA, $LcMnE); goto Rl38U; GGaMo: Session::forget('oauthLoginView'); goto l8nWr; Rl38U: if ($ULXwZ['code']) { return Response::sendFromGenerate($ULXwZ); } goto y3M3e; yBVDE: return Response::redirect(Request::domainUrl() . '/oauth_bind_' . $bMuGA); goto pW_iM; BhvkI: $LcMnE = Request::domainUrl() . '/oauth_callback_' . $bMuGA; goto ELmmI; y3M3e: $M1iJt = Session::get('oauthLoginView', false); goto GGaMo; l8nWr: if ($M1iJt) { goto pkFBL; pkFBL: $R7X4g = Session::get('oauthRedirect', modstart_web_url('member')); goto p0Vg1; p0Vg1: $oyra5 = Session::get('oauthUserInfo'); goto pP7AT; pP7AT: Session::put('oauthViewOpenId_' . $bMuGA, $oyra5['openid']); goto p3Rmf; p3Rmf: return Response::redirect($R7X4g); goto PZwam; PZwam: } goto yBVDE; pW_iM: } public function oauthBind($bMuGA = null) { goto xE20G; UYbCK: $ULXwZ = $this->api->oauthTryLogin($bMuGA); goto HKEXp; hM8qF: if ($ULXwZ['data']['memberUserId'] > 0) { Session::forget('oauthRedirect'); return Response::redirect($R7X4g); } goto THqXA; S11XY: $oyra5 = Session::get('oauthUserInfo', array()); goto UYbCK; HKEXp: if ($ULXwZ['code']) { return Response::send(-1, $ULXwZ['msg']); } goto hM8qF; f4alZ: $this->api->checkRedirectSafety($R7X4g); goto it3bt; THqXA: if (MemberUser::isLogin()) { goto fN2yc; fN2yc: $ULXwZ = $this->api->oauthBind($bMuGA); goto TOBKk; sY301: return Response::send(0, '绑定成功', null, $R7X4g); goto xwyY1; pXMsR: Session::forget('oauthRedirect'); goto sY301; TOBKk: if ($ULXwZ['code']) { return Response::send(-1, $ULXwZ['msg']); } goto pXMsR; xwyY1: } goto PnfLI; PnfLI: return $this->view('oauthBind', array('oauthUserInfo' => $oyra5, 'redirect' => $R7X4g)); goto FQUUQ; xE20G: $R7X4g = Session::get('oauthRedirect', modstart_web_url('member')); goto f4alZ; it3bt: if (Request::isPost()) { goto rEKSI; Qw8cu: Session::forget('oauthRedirect'); goto A6ZOp; rEKSI: $nIp2z = InputPackage::buildFromInput(); goto Boben; Boben: $ULXwZ = $this->api->oauthBind($bMuGA); goto A4PVF; A4PVF: if ($ULXwZ['code']) { if ($nIp2z->getTrimString('captcha')) { return Response::send(-1, $ULXwZ['msg'], null, '[js]$("[data-captcha]").click()'); } return Response::send(-1, $ULXwZ['msg']); } goto Qw8cu; A6ZOp: return Response::send(0, $ULXwZ['msg'], null, $R7X4g); goto cDxOF; cDxOF: } goto S11XY; FQUUQ: } public function oauthBindCaptcha() { return $this->api->oauthBindCaptchaRaw(); } public function oauthBindCaptchaVerify() { goto cFPC4; Vf2pr: return Response::send(0, $ULXwZ['msg']); goto IiVFS; cFPC4: $ULXwZ = $this->api->oauthBindCaptchaVerify(); goto p7bN7; p7bN7: if ($ULXwZ['code']) { return Response::send(-1, $ULXwZ['msg'], null, '[js]$("[data-captcha]").click()'); } goto Vf2pr; IiVFS: } public function oauthBindEmailVerify() { return Response::sendFromGenerate($this->api->oauthBindEmailVerify()); } public function oauthBindPhoneVerify() { return Response::sendFromGenerate($this->api->oauthBindPhoneVerify()); } public function oauthProxy() { return $this->view('oauthProxy'); } public function ssoClient() { goto atYxy; atYxy: $ULXwZ = $this->api->ssoClient(); goto YSwsO; YSwsO: if ($ULXwZ['code']) { return Response::send(-1, $ULXwZ['msg']); } goto du3rj; du3rj: $R7X4g = Session::get('ssoClientRedirect', modstart_web_url('member')); goto BH6IT; BH6IT: return Response::send(0, null, null, $R7X4g); goto tMTqP; tMTqP: } public function ssoServer() { goto FO1wY; FO1wY: $nIp2z = InputPackage::buildFromInput(); goto HJ0N3; St4g2: if ($ULXwZ['code']) { return Response::send(-1, $ULXwZ['msg']); } goto GlaqO; Y09J0: return Response::send(0, null, null, modstart_web_url('login') . '?' . http_build_query(array('redirect' => $WUgkj))); goto n6s0k; GlaqO: $WUgkj = '/sso/server_success?' . http_build_query(array('client' => $nIp2z->getTrimString('client'), 'domainUrl' => Request::domainUrl())); goto Z2kPo; HJ0N3: $ULXwZ = $this->api->ssoServer(); goto St4g2; Z2kPo: if ($ULXwZ['data']['isLogin']) { return Response::send(0, null, null, $WUgkj); } goto Y09J0; n6s0k: } public function ssoServerSuccess() { goto NZkLK; NZkLK: $ULXwZ = $this->api->ssoServerSuccess(); goto pMXw8; pMXw8: if ($ULXwZ['code']) { return Response::send(-1, $ULXwZ['msg']); } goto DOwX_; DOwX_: return Response::send(0, null, null, $ULXwZ['data']['redirect']); goto tq5ll; tq5ll: } public function ssoServerLogout() { goto v3_jf; E7DYm: $ULXwZ = $this->api->ssoServerLogout(); goto PVRG9; v3_jf: $nIp2z = InputPackage::buildFromInput(); goto E7DYm; Hb8TJ: return Response::send(0, null, null, $R7X4g); goto wOa70; WsFRU: $R7X4g = $nIp2z->getTrimString('redirect', modstart_web_url('')); goto Hb8TJ; PVRG9: if ($ULXwZ['code']) { return Response::send(-1, $ULXwZ['msg']); } goto WsFRU; wOa70: } public function ssoClientLogout() { goto HZ_GA; HZ_GA: $ULXwZ = $this->api->ssoClientLogout(); goto eg3mX; jIs86: $R7X4g = Session::get('ssoLogoutRedirect', modstart_web_url('')); goto kdSkz; kdSkz: return Response::send(0, null, null, $R7X4g); goto xErwU; eg3mX: if ($ULXwZ['code']) { return Response::send(-1, $ULXwZ['msg']); } goto jIs86; xErwU: } }