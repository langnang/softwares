<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Admin\Controller; use Illuminate\Routing\Controller; use ModStart\Admin\Auth\AdminPermission; use ModStart\Admin\Concern\HasAdminQuickCRUD; use ModStart\Admin\Layout\AdminConfigBuilder; use ModStart\Admin\Layout\AdminCRUDBuilder; use ModStart\Admin\Layout\AdminDialogPage; use ModStart\Core\Assets\AssetsUtil; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Core\Util\ArrayUtil; use ModStart\Core\Util\ColorUtil; use ModStart\Core\Util\CRUDUtil; use ModStart\Core\Util\EventUtil; use ModStart\Core\Util\RandomUtil; use ModStart\Core\Util\TimeUtil; use ModStart\Field\AbstractField; use ModStart\Field\AutoRenderedFieldValue; use ModStart\Field\Type\FieldRenderMode; use ModStart\Form\Form; use ModStart\Grid\Displayer\ItemOperate; use ModStart\Grid\GridFilter; use ModStart\Module\ModuleManager; use ModStart\Repository\Filter\RepositoryFilter; use ModStart\Support\Concern\HasFields; use ModStart\Widget\TextDialogRequest; use Module\Member\Config\MemberAdminList; use Module\Member\Config\MemberOauth; use Module\Member\Events\MemberUserRegisteredEvent; use Module\Member\Provider\MemberAdminShowPanel\MemberAdminShowPanelProvider; use Module\Member\Type\MemberStatus; use Module\Member\Util\MemberGroupUtil; use Module\Member\Util\MemberMessageUtil; use Module\Member\Util\MemberUtil; use Module\Member\Util\MemberVipUtil; class MemberController extends Controller { use HasAdminQuickCRUD; protected function crud(AdminCRUDBuilder $Jf1S7) { $Jf1S7->init('member_user')->field(function ($Jf1S7) { $Jf1S7->id('id', 'ID'); MemberAdminList::callGridField($Jf1S7); $Jf1S7->display('avatar', '头像')->hookRendering(function (AbstractField $gxoEj, $qlKQK, $mlRDG) { $hJ2r0 = AssetsUtil::fixOrDefault($qlKQK->avatar, 'asset/image/avatar.png'); $XcvUU = AssetsUtil::fixOrDefault($qlKQK->avatarBig, 'asset/image/avatar.png'); return AutoRenderedFieldValue::make("<a href='{$XcvUU}' class='tw-inline-block' data-image-preview>\n                        <img src='{$hJ2r0}' class='tw-rounded-full tw-w-8 tw-h-8 tw-shadow'></a>"); }); $Jf1S7->text('username', '用户名')->required()->ruleUnique('member_user')->hookRendering(function (AbstractField $gxoEj, $qlKQK, $mlRDG) { switch ($gxoEj->renderMode()) { case FieldRenderMode::GRID: case FieldRenderMode::DETAIL: return AutoRenderedFieldValue::make(TextDialogRequest::make('primary', htmlspecialchars($qlKQK->username), modstart_admin_url('member/show', array('_id' => $qlKQK->id)))->width('90%')->height('90%')->render()); break; } }); $Jf1S7->text('email', '邮箱'); $Jf1S7->text('phone', '手机'); $Jf1S7->text('nickname', '昵称'); if (MemberOauth::hasEnableItems()) { $Jf1S7->display('_oauth', '授权')->hookRendering(function (AbstractField $gxoEj, $qlKQK, $mlRDG) { $ePHMY = array(); $KGg2R = MemberUtil::listOauths($qlKQK->id); foreach ($KGg2R as $geXHy) { goto DkhG3; Wrya1: if (empty($qB_BF)) { $qB_BF = ColorUtil::pick($geXHy['type']); } goto E20_7; W16f5: $dxcjQ = MemberOauth::getByOauthKey($geXHy['type']); goto ouUrk; DkhG3: $qB_BF = null; goto vcx3H; E20_7: $ePHMY[] = '<a style="color:' . $qB_BF . ';" href="javascript:;" data-tip-popover="' . $gbyXi . '"><i class="iconfont icon-dot"></i></a>'; goto QvjOp; ouUrk: if ($dxcjQ) { $qB_BF = $dxcjQ->color(); $gbyXi = $dxcjQ->title(); } goto Wrya1; vcx3H: $gbyXi = $geXHy['type']; goto W16f5; QvjOp: } return join('', $ePHMY); }); } $Jf1S7->type('status', '状态')->type(MemberStatus::class, array(MemberStatus::NORMAL => 'success', MemberStatus::FORBIDDEN => 'danger'))->required(); if (ModuleManager::getModuleConfigBoolean('Member', 'groupEnable', false)) { $Jf1S7->radio('groupId', '分组')->options(MemberGroupUtil::mapIdTitle())->required(); } if (ModuleManager::getModuleConfigBoolean('Member', 'vipEnable', false)) { $Jf1S7->radio('vipId', 'VIP')->options(MemberVipUtil::mapTitle())->required(); $Jf1S7->date('vipExpire', 'VIP过期'); } $Jf1S7->display('registerIp', '注册IP'); $Jf1S7->display('created_at', '注册时间'); $Jf1S7->canBatchSelect(true); $Jf1S7->batchOperatePrepend('<button class="btn" data-batch-confirm="确认禁用 %d 个用户？" data-batch-operate="' . modstart_admin_url('member/status_forbidden') . '"><i class="iconfont icon-warning"></i> 禁用</button>'); })->repositoryFilter(function (RepositoryFilter $XM5aD) { $XM5aD->where(array('isDeleted' => false)); })->gridFilter(function (GridFilter $XM5aD) { $XM5aD->eq('id', L('ID')); $XM5aD->like('username', '用户名'); $XM5aD->like('email', '邮箱')->autoHide(true); $XM5aD->like('phone', '手机')->autoHide(true); $XM5aD->eq('status', '状态')->autoHide(true)->select(MemberStatus::class); if (ModuleManager::getModuleConfigBoolean('Member', 'groupEnable', false)) { $XM5aD->eq('groupId', '分组')->autoHide(true)->select(MemberGroupUtil::mapIdTitle()); } if (ModuleManager::getModuleConfigBoolean('Member', 'vipEnable', false)) { $XM5aD->eq('vipId', 'VIP')->autoHide(true)->select(MemberVipUtil::mapTitle()); } })->operateFixed('right')->hookItemOperateRendering(function (ItemOperate $KGMu0) { $qlKQK = $KGMu0->item(); $KGMu0->prepend(TextDialogRequest::make('primary', '用户信息', modstart_admin_url('member/show', array('_id' => $qlKQK->id)))->width('90%')->height('90%')->render()); })->title('用户管理')->canShow(false)->canDelete(true)->textEdit('修改账号'); } public function add(AdminDialogPage $H1G2d) { goto s7gPr; q_ELC: $oqTbu->showSubmit(false)->showReset(false); goto WVUqS; s7gPr: $oqTbu = Form::make(''); goto mJWLo; uW0I3: $oqTbu->layoutPanel('高级', function (Form $oqTbu) { $oqTbu->text('nickname', '昵称'); $oqTbu->radio('status', '状态')->optionType(MemberStatus::class)->defaultValue(MemberStatus::NORMAL); if (ModuleManager::getModuleConfigBoolean('Member', 'groupEnable', false)) { $oqTbu->radio('groupId', '分组')->options(MemberGroupUtil::mapIdTitle())->required(); } if (ModuleManager::getModuleConfigBoolean('Member', 'vipEnable', false)) { $oqTbu->radio('vipId', 'VIP')->options(MemberVipUtil::mapTitle())->required(); $oqTbu->date('vipExpire', 'VIP过期'); } }); goto q_ELC; mJWLo: $oqTbu->layoutPanel('基础（用户、手机、邮箱不能同时为空）', function (Form $oqTbu) { $oqTbu->text('username', '用户名'); $oqTbu->text('phone', '手机'); $oqTbu->text('email', '邮箱'); $oqTbu->text('password', '初始密码')->defaultValue(RandomUtil::lowerString(8)); }); goto uW0I3; WVUqS: return $H1G2d->pageTitle('创建用户')->body($oqTbu)->handleForm($oqTbu, function (Form $oqTbu) { AdminPermission::demoCheck(); $WAiaw = $oqTbu->dataForming(); $eZXtQ = $WAiaw['username'] ? $WAiaw['username'] : null; $TR7J6 = $WAiaw['phone'] ? $WAiaw['phone'] : null; $qAkQN = $WAiaw['email'] ? $WAiaw['email'] : null; $rkBBy = ArrayUtil::keepKeys($WAiaw, array('nickname', 'groupId', 'status', 'vipId', 'vipExpire')); $ULXwZ = MemberUtil::register($eZXtQ, $TR7J6, $qAkQN, $WAiaw['password']); BizException::throwsIfResponseError($ULXwZ); if (!empty($rkBBy)) { if (isset($rkBBy['vipExpire']) && TimeUtil::isDateEmpty($rkBBy['vipExpire'])) { $rkBBy['vipExpire'] = null; } MemberUtil::update($ULXwZ['data']['id'], $rkBBy); } EventUtil::fire(new MemberUserRegisteredEvent($ULXwZ['data']['id'])); return Response::redirect(CRUDUtil::jsDialogCloseAndParentGridRefresh()); }); goto d6dqL; d6dqL: } public function edit(AdminDialogPage $H1G2d) { goto Jo92_; JZx8n: $oqTbu->item($OYXQL)->fillFields(); goto Ih0B_; RDYoO: $oqTbu = Form::make(''); goto Ie1c5; z3uPa: return $H1G2d->pageTitle('创建用户')->body($oqTbu)->handleForm($oqTbu, function (Form $oqTbu) use($OYXQL) { AdminPermission::demoCheck(); $WAiaw = $oqTbu->dataForming(); $J5GyQ = ArrayUtil::keepKeys($WAiaw, array('username', 'phone', 'email')); $rkBBy = ArrayUtil::keepKeys($WAiaw, array('nickname', 'groupId', 'status', 'vipId', 'vipExpire')); $ULXwZ = MemberUtil::updateBasicWithUniqueCheck($OYXQL['id'], $J5GyQ); BizException::throwsIfResponseError($ULXwZ); if (isset($rkBBy['vipExpire']) && TimeUtil::isDateEmpty($rkBBy['vipExpire'])) { $rkBBy['vipExpire'] = null; } MemberUtil::update($OYXQL['id'], $rkBBy); return Response::redirect(CRUDUtil::jsDialogCloseAndParentGridRefresh()); }); goto URRpR; HfJEs: $oqTbu->layoutPanel('高级', function (Form $oqTbu) { $oqTbu->text('nickname', '昵称'); $oqTbu->radio('status', '状态')->optionType(MemberStatus::class)->defaultValue(MemberStatus::NORMAL); if (ModuleManager::getModuleConfigBoolean('Member', 'groupEnable', false)) { $oqTbu->radio('groupId', '分组')->options(MemberGroupUtil::mapIdTitle())->required(); } if (ModuleManager::getModuleConfigBoolean('Member', 'vipEnable', false)) { $oqTbu->radio('vipId', 'VIP')->options(MemberVipUtil::mapTitle())->required(); $oqTbu->date('vipExpire', 'VIP过期'); } }); goto JZx8n; FNORF: if (Request::isPost()) { goto gM3rL; gM3rL: AdminPermission::demoCheck(); goto AoBMb; BycQt: switch ($nIp2z->getTrimString('_action')) { case 'itemCellEdit': goto qDHGB; ETbNa: switch ($nIp2z->getTrimString('column')) { case 'status': $OSIrT['status'] = $nIp2z->getInteger('value'); break; } goto O40k6; WHSVA: return Response::generateSuccess(); goto Te_RW; O40k6: if (!empty($OSIrT)) { MemberUtil::update($OYXQL['id'], $OSIrT); } goto WHSVA; qDHGB: $OSIrT = array(); goto ETbNa; Te_RW: } goto vleJw; AoBMb: $nIp2z = InputPackage::buildFromInput(); goto BycQt; vleJw: } goto RDYoO; RFBDR: BizException::throwsIfEmpty('用户不存在', $OYXQL); goto FNORF; Ie1c5: $oqTbu->layoutPanel('基础', function (Form $oqTbu) { $oqTbu->text('username', '用户名'); $oqTbu->text('phone', '手机'); $oqTbu->text('email', '邮箱'); }); goto HfJEs; Jo92_: $OYXQL = ModelUtil::get('member_user', CRUDUtil::id()); goto RFBDR; Ih0B_: $oqTbu->showSubmit(false)->showReset(false); goto z3uPa; URRpR: } public function select(AdminDialogPage $H1G2d) { goto GKBWv; GKBWv: $RZHSW = $this->grid(); goto tXn2v; sHVyv: return $H1G2d->pageTitle('选择用户')->body($RZHSW); goto nHssy; Ljq9S: $RZHSW->canSingleSelectItem(true); goto Fl96S; DvUj6: if (Request::isPost()) { return $RZHSW->request(); } goto sHVyv; tXn2v: $RZHSW->disableCUD(); goto Ljq9S; Fl96S: CRUDUtil::registerGridResource($RZHSW, '\\' . __CLASS__); goto DvUj6; nHssy: } public function search() { goto nFAcA; KN3XE: $eMb8v = array(); goto QcfDC; Hd7or: return Response::jsonSuccessData($VxRpT); goto bZWt_; wwLML: $VxRpT = array_map(function ($qlKQK) { return array('value' => intval($qlKQK['id']), 'name' => htmlspecialchars(MemberUtil::viewName($qlKQK)), 'avatar' => AssetsUtil::fixOrDefault($qlKQK['avatar'], 'asset/image/avatar.png')); }, $CkO0l['records']); goto Hd7or; nFAcA: $nIp2z = InputPackage::buildFromInput(); goto O17oH; jvQsL: $CkO0l = MemberUtil::paginate(1, 10, $eMb8v); goto wwLML; QcfDC: $eMb8v['whereOperate'] = array('username', 'like', "%{$T6rtr}%"); goto jvQsL; O17oH: $T6rtr = $nIp2z->getTrimString('keywords'); goto KN3XE; bZWt_: } public function resetPassword(AdminConfigBuilder $Jf1S7) { goto wA_bl; oZDmM: BizException::throwsIfEmpty('用户不存在', $OYXQL); goto CyKdJ; HUw3Y: if (Request::isPost()) { return $Jf1S7->formRequest(function (Form $oqTbu) use($OYXQL) { AdminPermission::demoCheck(); $WAiaw = $oqTbu->dataForming(); $ULXwZ = MemberUtil::changePassword($OYXQL['id'], $WAiaw['passwordNew'], null, true); BizException::throwsIfResponseError($ULXwZ); return Response::redirect(CRUDUtil::jsDialogClose()); }); } goto OJQ8v; DEwko: $OYXQL = MemberUtil::get($wQ1uv); goto oZDmM; t5h45: $Jf1S7->text('passwordNew', '新密码')->required()->defaultValue(RandomUtil::upperString(6)); goto HUw3Y; wA_bl: $wQ1uv = CRUDUtil::id(); goto DEwko; CyKdJ: $Jf1S7->useDialog(); goto JO2Wu; OJQ8v: return $Jf1S7; goto CL9L9; JO2Wu: $Jf1S7->pageTitle('重置密码'); goto t5h45; CL9L9: } public function sendMessage(AdminConfigBuilder $Jf1S7) { goto mJh7m; Kbefq: if (Request::isPost()) { return $Jf1S7->formRequest(function (Form $oqTbu) use($OYXQL) { AdminPermission::demoCheck(); $WAiaw = $oqTbu->dataForming(); $ULXwZ = MemberMessageUtil::send($OYXQL['id'], $WAiaw['content']); BizException::throwsIfResponseError($ULXwZ); return Response::redirect(CRUDUtil::jsDialogClose()); }); } goto jOlRB; jOlRB: return $Jf1S7; goto waI9Q; cPiRT: $Jf1S7->useDialog(); goto eeeEL; iT4y8: $OYXQL = MemberUtil::get($wQ1uv); goto US5E0; eeeEL: $Jf1S7->pageTitle('发送消息'); goto LFPOh; US5E0: BizException::throwsIfEmpty('用户不存在', $OYXQL); goto cPiRT; LFPOh: $Jf1S7->richHtml('content', '消息内容')->required(); goto Kbefq; mJh7m: $wQ1uv = CRUDUtil::id(); goto iT4y8; waI9Q: } public function show() { goto wQJXL; wQJXL: $HuFy_ = MemberUtil::get(CRUDUtil::id()); goto EgOrb; EgOrb: $l9Mv3 = MemberAdminShowPanelProvider::listAll(); goto pJLdY; pJLdY: return view('module::Member.View.admin.memberUser.show', array('record' => $HuFy_, 'showPanelProviders' => $l9Mv3)); goto sSNuc; sSNuc: } public function delete() { goto Z0wwY; yO72Z: MemberUtil::delete(CRUDUtil::id()); goto eID__; Z0wwY: AdminPermission::demoCheck(); goto yO72Z; eID__: return Response::redirect(CRUDUtil::jsGridRefresh()); goto Z1X11; Z1X11: } public function statusForbidden() { goto XNSVb; I2B_P: return Response::redirect(CRUDUtil::jsGridRefresh()); goto w0834; TmrGL: MemberUtil::updateStatus(CRUDUtil::ids(), MemberStatus::FORBIDDEN); goto I2B_P; XNSVb: AdminPermission::demoCheck(); goto TmrGL; w0834: } }