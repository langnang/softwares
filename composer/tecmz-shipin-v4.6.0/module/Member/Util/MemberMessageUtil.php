<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Util; use Illuminate\Support\Facades\View; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Response; use Module\Member\Type\MemberMessageStatus; class MemberMessageUtil { public static function getUnreadMessageCount($T2y_X) { return ModelUtil::count('member_message', array('userId' => $T2y_X, 'status' => MemberMessageStatus::UNREAD)); } public static function setMemberMessageRead($T2y_X, $QLi7N = array()) { if (empty($QLi7N)) { return; } ModelUtil::model('member_message')->where(array('userId' => $T2y_X))->whereIn('id', $QLi7N)->update(array('status' => MemberMessageStatus::READ)); } public function setMemberMessageReadAll($T2y_X) { ModelUtil::model('member_message')->where(array('userId' => $T2y_X))->update(array('status' => MemberMessageStatus::READ)); } public static function paginate($T2y_X, $H1G2d, $HugPs, $eMb8v = array()) { goto vjNLX; qzhsQ: foreach ($CkO0l['records'] as $HuFy_) { goto nX20c; IjzdP: $VxRpT[] = $qlKQK; goto OHKtF; ePKaL: $qlKQK['status'] = $HuFy_['status']; goto oaRyU; oZNfB: $qlKQK['createTime'] = $HuFy_['created_at']; goto IjzdP; oaRyU: $qlKQK['fromId'] = $HuFy_['fromId']; goto aEvF_; nX20c: $qlKQK = array(); goto j8UtU; aEvF_: $qlKQK['content'] = $HuFy_['content']; goto oZNfB; j8UtU: $qlKQK['id'] = $HuFy_['id']; goto ePKaL; OHKtF: } goto vUAb2; BaxxQ: $CkO0l = ModelUtil::paginate('member_message', $H1G2d, $HugPs, $eMb8v); goto tnn1a; tnn1a: $VxRpT = array(); goto qzhsQ; vjNLX: $eMb8v['where']['userId'] = $T2y_X; goto BaxxQ; vUAb2: return array('records' => $VxRpT, 'total' => $CkO0l['total']); goto NEQQd; NEQQd: } public static function delete($T2y_X, $QLi7N = array()) { goto M0wA0; tzgX6: ModelUtil::model('member_message')->whereIn('id', $QLi7N)->where(array('userId' => $T2y_X))->delete(); goto D7gez; qhkmJ: if (!is_array($QLi7N)) { $QLi7N = array($QLi7N); } goto tzgX6; M0wA0: if (empty($QLi7N)) { return; } goto qhkmJ; D7gez: } public static function deleteAll($T2y_X) { ModelUtil::model('member_message')->where(array('userId' => $T2y_X))->delete(); } public static function update($T2y_X, $QLi7N = array(), $OSIrT = array()) { goto FEgws; FEgws: if (empty($QLi7N) || empty($OSIrT)) { return; } goto d_Ywa; EqkcC: ModelUtil::model('member_message')->whereIn('id', $QLi7N)->where(array('userId' => $T2y_X))->update($OSIrT); goto ONdmH; d_Ywa: if (!is_array($QLi7N)) { $QLi7N = array($QLi7N); } goto EqkcC; ONdmH: } public static function updateRead($T2y_X, $QLi7N = array()) { self::update($T2y_X, $QLi7N, array('status' => MemberMessageStatus::READ)); } public static function updateReadAll($T2y_X) { ModelUtil::model('member_message')->where(array('userId' => $T2y_X))->update(array('status' => MemberMessageStatus::READ)); } public static function send($T2y_X, $yo_tt, $AH3Tc = 0) { ModelUtil::insert('member_message', array('userId' => $T2y_X, 'fromId' => $AH3Tc, 'status' => MemberMessageStatus::UNREAD, 'content' => $yo_tt)); return Response::generate(0, null); } public static function sendTemplate($XK7hT, $rjBow, $kJl0M = array(), $ZL1jM = 0, $DvHya = null) { goto VEBpr; VEBpr: $sdjIf = modstart_config()->getWithEnv('siteTemplate', 'default'); goto aqVjh; Emztt: if (!view()->exists($M1iJt)) { $M1iJt = 'theme.default.message.' . $rjBow; if (!view()->exists($M1iJt)) { if ($DvHya) { $M1iJt = 'module::' . $DvHya . '.View.m.message.' . $rjBow; if (!view()->exists($M1iJt)) { $M1iJt = 'module::' . $DvHya . '.View.pc.message.' . $rjBow; } } else { $M1iJt = 'module::Member.View.' . $sdjIf . '.message.' . $rjBow; if (!view()->exists($M1iJt)) { $M1iJt = 'module::Member.View.default.message.' . $rjBow; } } } } goto o9q5J; aam_2: self::send($XK7hT, $m5hi1, $ZL1jM); goto PHvjd; o9q5J: if (!view()->exists($M1iJt)) { BizException::throws(L('View Not Found : %s', $rjBow)); } goto kWlR1; aqVjh: $M1iJt = 'theme.' . $sdjIf . '.message.' . $rjBow; goto Emztt; kWlR1: $m5hi1 = View::make($M1iJt, $kJl0M)->render(); goto aam_2; PHvjd: } public static function sendTemplateFromView($M1iJt, $sab10, $XK7hT, $ZL1jM = 0) { goto NLvRM; toEfV: self::send($XK7hT, $m5hi1, $ZL1jM); goto O1IjQ; W91mM: $m5hi1 = View::make($M1iJt, $sab10)->render(); goto toEfV; NLvRM: if (!view()->exists($M1iJt)) { throw new \Exception('message view not found : ' . $M1iJt); } goto W91mM; O1IjQ: } }