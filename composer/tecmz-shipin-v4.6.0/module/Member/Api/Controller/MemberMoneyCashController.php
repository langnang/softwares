<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Api\Controller; use Illuminate\Routing\Controller; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Response; use ModStart\Core\Type\TypeUtil; use Module\Member\Auth\MemberUser; use Module\Member\Support\MemberLoginCheck; use Module\Member\Type\MemberMoneyCashType; use Module\Member\Util\MemberMoneyUtil; class MemberMoneyCashController extends Controller implements MemberLoginCheck { public function get() { goto iSlpP; iSlpP: $Z3p9O = MemberMoneyUtil::getTotal(MemberUser::id()); goto W5yGm; kPgN6: return Response::generateSuccessData(array('total' => $Z3p9O, 'desc' => modstart_config('Member_MoneyCashDescription'), 'min' => sprintf('%0.2f', $MXipz), 'rate' => modstart_config('Member_MoneyCashTaxRate', 0), 'types' => TypeUtil::dump(MemberMoneyCashType::class), 'canCash' => $Z3p9O >= $MXipz, 'defaultType' => MemberMoneyCashType::ALIPAY)); goto LrSYk; W5yGm: $MXipz = modstart_config('Member_MoneyCashMin', 100); goto kPgN6; LrSYk: } public function calc() { goto nbJHp; gHmQB: $WRPnK = $nIp2z->getDecimal('money'); goto EoQWB; DZs_a: $Z3p9O = MemberMoneyUtil::getTotal(MemberUser::id()); goto hTBsg; EoQWB: if ($WRPnK < modstart_config('Member_MoneyCashMin', 100)) { return Response::generateError('最小提现金额为' . modstart_config('Member_MoneyCashMin', 100)); } goto DZs_a; SskTD: $I1R2f = bcdiv(bcmul($WRPnK, $JQFzL, 2), 100, 2); goto VUUwW; hTBsg: if ($WRPnK > $Z3p9O) { return Response::generateError('余额不足'); } goto Z0089; nbJHp: $nIp2z = InputPackage::buildFromInput(); goto gHmQB; Oq6WM: $JQFzL = 100 - min(max($JQFzL, 0), 99); goto SskTD; VUUwW: return Response::generateSuccessData(array('value' => $I1R2f)); goto Q4eeA; Z0089: $JQFzL = modstart_config('Member_MoneyCashTaxRate', 0); goto Oq6WM; Q4eeA: } public function submit() { goto C6xEk; C6xEk: if (!modstart_config('Member_MoneyCashEnable', false)) { return Response::generateError('功能未开启'); } goto Iwix8; o_qCE: if ($Z3p9O < modstart_config('Member_MoneyCashMin', 100)) { return Response::generate(-1, '当前账户余额不满' . modstart_config('Member_MoneyCashMin', 100) . ',不能提现'); } goto K1n_l; K1n_l: $JQFzL = modstart_config('Member_MoneyCashTaxRate', 0); goto tOBqY; F5rDS: try { goto kS1T6; kS1T6: ModelUtil::transactionBegin(); goto gqsF1; gqsF1: MemberMoneyUtil::cash(MemberUser::id(), $WRPnK, $drvzO, MemberMoneyCashType::ALIPAY, $J6e8F, $ZHcx4); goto kfeZO; kfeZO: ModelUtil::transactionCommit(); goto p60x8; p60x8: } catch (\Exception $H8GLS) { ModelUtil::transactionRollback(); throw $H8GLS; } goto gRD7l; ty4fq: if ($WRPnK < modstart_config('Member_MoneyCashMin', 100)) { return Response::generate(-1, '提现金额至少为' . modstart_config('Member_MoneyCashMin', 100)); } goto cbb5x; t1DkU: $Z3p9O = MemberMoneyUtil::getTotal(MemberUser::id()); goto o_qCE; AncHa: if ($WRPnK < 0.01) { return Response::generate(-1, '提现金额不能为空'); } goto ty4fq; gRD7l: return Response::generate(0, '提交成功', null, modstart_web_url('member_money/cash/log')); goto wpdyl; Iwix8: $nIp2z = InputPackage::buildFromInput(); goto tHYyc; cbb5x: $FmHYg = $nIp2z->getType('type', MemberMoneyCashType::class); goto vwhl4; tHYyc: $WRPnK = $nIp2z->getDecimal('money'); goto AncHa; vwhl4: switch ($FmHYg) { case MemberMoneyCashType::ALIPAY: goto yx80q; PgWXm: $ZHcx4 = $nIp2z->getTrimString('alipayAccount'); goto aytTV; fEOJO: break; goto bC0pQ; yx80q: $J6e8F = $nIp2z->getTrimString('alipayRealname'); goto PgWXm; aytTV: if (empty($J6e8F)) { return Response::generate(-1, '支付宝姓名不能为空'); } goto dc5V9; dc5V9: if (empty($ZHcx4)) { return Response::generate(-1, '支付宝账号不能为空'); } goto fEOJO; bC0pQ: default: return Response::generateError('支付类型错误'); } goto t1DkU; ROQju: $drvzO = bcdiv(bcmul($WRPnK, $JQFzL, 2), 100, 2); goto F5rDS; tOBqY: $JQFzL = 100 - min(max($JQFzL, 0), 99); goto ROQju; wpdyl: } public function log() { goto lOgij; o1wrY: return Response::generateSuccessPaginate($nIp2z->getPage(), $nIp2z->getPageSize(), $CkO0l); goto hp_ig; f56y1: $eMb8v = array(); goto QsN2J; lOgij: $nIp2z = InputPackage::buildFromInput(); goto f56y1; QsN2J: $CkO0l = MemberMoneyUtil::paginateCash(MemberUser::id(), $nIp2z->getPage(), $nIp2z->getPageSize(), $eMb8v); goto o1wrY; hp_ig: } }