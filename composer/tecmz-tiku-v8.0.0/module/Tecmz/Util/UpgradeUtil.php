<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Tecmz\Util; use App\Constant\AppConstant; use Chumper\Zipper\Zipper; use Illuminate\Support\Facades\Artisan; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Response; use ModStart\Core\Util\CurlUtil; use ModStart\Core\Util\FileUtil; use ModStart\ModStart; class UpgradeUtil { const REMOTE_BASE = 'https://www.tecmz.com'; private static function baseRequest($lYtoi, $GeXSC = array(), $HUlap = null) { return CurlUtil::postJSONBody(self::REMOTE_BASE . $lYtoi, $GeXSC, array('header' => array('api-token' => $HUlap, 'X-Requested-With' => 'XMLHttpRequest'))); } public static function latest() { goto JI6YB; h8LPX: return $BEdDh['data']; goto N2CVY; eyTP1: BizException::throwsIfResponseError($BEdDh); goto h8LPX; JI6YB: $BEdDh = self::baseRequest('/api/app/latest', array('app' => AppConstant::APP, 'version' => AppConstant::VERSION)); goto eyTP1; N2CVY: } public static function downloadPackage($HUlap, $rwsHh, $FUMHt, $bssXV) { goto B_XMZ; B_XMZ: $BEdDh = self::baseRequest('/api/app/download_package', array('app' => $rwsHh, 'fromVersion' => $FUMHt, 'toVersion' => $bssXV), $HUlap); goto S19Dj; DIqKT: file_put_contents($xZIda, $GeXSC); goto Uuxzk; EdNse: $HKlGd = $BEdDh['data']['diffContent']; goto l_TnY; dLENz: $xZIda = FileUtil::generateLocalTempPath('zip'); goto DIqKT; OdxJQ: $Qob5Q = FileUtil::generateLocalTempPath('json'); goto y8lbE; y8lbE: file_put_contents($Qob5Q, $HKlGd); goto J3qn0; FqcbR: $ZD7Jf = $BEdDh['data']['package']; goto dc2zX; dc2zX: $JiJ0N = $BEdDh['data']['packageMd5']; goto EdNse; uUpEh: BizException::throwsIfEmpty('安装包获取失败', $GeXSC); goto dLENz; l_TnY: $GeXSC = CurlUtil::getRaw($ZD7Jf); goto uUpEh; Uuxzk: BizException::throwsIf('文件MD5校验失败', md5_file($xZIda) != $JiJ0N); goto OdxJQ; J3qn0: return Response::generateSuccessData(array('diffContentFile' => $Qob5Q, 'package' => $xZIda, 'packageSize' => filesize($xZIda))); goto zqlF1; S19Dj: BizException::throwsIfResponseError($BEdDh); goto FqcbR; zqlF1: } public static function upgradePackage($ZD7Jf, $Qob5Q) { goto eI1hF; eI1hF: BizException::throwsIf('package不存在', !file_exists($ZD7Jf)); goto D9GwI; NlnOW: BizException::throwsIf('diffContent为空', empty($HKlGd)); goto jCLnb; raHCi: return Response::generateSuccessData(array('logs' => $gn4HX)); goto Zhh1P; HrYRr: if (!empty($HKlGd['add'])) { $eeenH = array_merge($eeenH, $HKlGd['add']); } goto ioXJ5; SXoX4: BizException::throwsIfResponseError($BEdDh); goto kOyO1; gNx9d: if (!empty($HKlGd['add'])) { goto Pi__9; FGPZO: $gn4HX[] = ''; goto y1_0N; e3I8U: foreach ($HKlGd['add'] as $dc3Q5) { goto Lsk40; Lsk40: $KqFED = $h6nbW->getFileContent($dc3Q5); goto x4hlX; JUwRz: $gn4HX[] = "> {$dc3Q5}"; goto oFxsz; x4hlX: FileUtil::write(base_path($dc3Q5), $KqFED); goto JUwRz; oFxsz: } goto FGPZO; Pi__9: $gn4HX[] = '新增文件：'; goto e3I8U; y1_0N: } goto f0wRU; f0wRU: if (!empty($HKlGd['update'])) { goto iXHWT; iXHWT: $gn4HX[] = '修改文件：'; goto uz_C9; zp_Lf: $gn4HX[] = ''; goto p7vju; uz_C9: foreach ($HKlGd['update'] as $dc3Q5) { goto zY13m; WDsoS: $gn4HX[] = "> {$dc3Q5}"; goto wsunW; r7L33: FileUtil::write(base_path($dc3Q5), $KqFED); goto WDsoS; zY13m: $KqFED = $h6nbW->getFileContent($dc3Q5); goto r7L33; wsunW: } goto zp_Lf; p7vju: } goto in3v1; kgiC_: try { $knCM0 = Artisan::call('migrate'); } catch (\Exception $knlzD) { $knCM0 = -1; } goto plktJ; DjCZr: $h6nbW->make($ZD7Jf); goto jepMo; ioXJ5: if (!empty($HKlGd['update'])) { $eeenH = array_merge($eeenH, $HKlGd['update']); } goto HGbQY; jepMo: $gn4HX = array(); goto gNx9d; datKc: FileUtil::safeCleanLocalTemp($Qob5Q); goto raHCi; HGbQY: $BEdDh = FileUtil::filePathWritableCheck($eeenH); goto SXoX4; VnP0q: $h6nbW->close(); goto nntmH; LTlTI: try { $knCM0 = Artisan::call('modstart:module-install-all'); } catch (\Exception $knlzD) { $knCM0 = -1; } goto LwRe6; plktJ: BizException::throwsIf('调用 php artisan migrate 失败', 0 != $knCM0); goto LTlTI; kOyO1: $h6nbW = new Zipper(); goto DjCZr; AjJOJ: FileUtil::safeCleanLocalTemp($ZD7Jf); goto datKc; LwRe6: BizException::throwsIf('调用 php artisan modstart:module-install-all 失败', 0 != $knCM0); goto AjJOJ; nntmH: ModStart::clearCache(); goto kgiC_; jCLnb: $eeenH = array(); goto HrYRr; IrDn2: $HKlGd = @json_decode(file_get_contents($Qob5Q), true); goto NlnOW; in3v1: if (!empty($HKlGd['delete'])) { goto YVO44; l5zAy: $gn4HX[] = ''; goto qOUjs; YVO44: $gn4HX[] = '删除文件：'; goto O2A_e; O2A_e: foreach ($HKlGd['delete'] as $dc3Q5) { if (file_exists($Elm_b = base_path($dc3Q5))) { @unlink($Elm_b); $gn4HX[] = "> {$dc3Q5}"; } } goto l5zAy; qOUjs: } goto VnP0q; D9GwI: BizException::throwsIf('diffContentFile不存在', !file_exists($Qob5Q)); goto IrDn2; Zhh1P: } }