<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Util; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Util\IdUtil; use Module\Member\Type\MemberMoneyCashStatus; use Module\Member\Type\MemberMoneyChargeStatus; class MemberMoneyUtil { public static function paginateLog($MqkYF, $gETpv, $Wo30p, $InfBU = array()) { goto RhzAo; RhzAo: $InfBU['where']['memberUserId'] = $MqkYF; goto bHGP8; bHGP8: $InfBU['order'] = array('id', 'desc'); goto BfmoT; BfmoT: return ModelUtil::paginate('member_money_log', $gETpv, $Wo30p, $InfBU); goto SMw0F; SMw0F: } public static function getTotal($MqkYF) { goto zSPZU; TGyBS: return $nq5ti['total']; goto sL1FW; wM8M5: if (empty($nq5ti)) { return '0.00'; } goto TGyBS; zSPZU: $nq5ti = ModelUtil::get('member_money', array('memberUserId' => $MqkYF)); goto wM8M5; sL1FW: } public static function change($MqkYF, $pvk5f, $DfuA7) { goto lEVTh; cLqs3: ModelUtil::insert('member_money_log', array('memberUserId' => $MqkYF, 'change' => $pvk5f, 'remark' => $DfuA7)); goto SMzc8; SMzc8: $nq5ti = ModelUtil::update('member_money', array('id' => $nq5ti['id']), array('total' => $nq5ti['total'] + $pvk5f)); goto btx1x; btx1x: if ($nq5ti['total'] < 0) { throw new \Exception('MemberMoneyService -> total empty'); } goto UAk2w; ffszO: if ($pvk5f < 0 && $nq5ti['total'] + $pvk5f < 0) { throw new \Exception('MemberMoneyService -> total change to empty'); } goto cLqs3; dvicY: $nq5ti = ModelUtil::getWithLock('member_money', array('memberUserId' => $MqkYF)); goto dUnlQ; dUnlQ: if (empty($nq5ti)) { $nq5ti = ModelUtil::insert('member_money', array('memberUserId' => $MqkYF, 'total' => 0)); } goto ffszO; lEVTh: if (!$pvk5f) { throw new \Exception('MemberMoneyService -> change empty'); } goto dvicY; UAk2w: } public static function cash($MqkYF, $HWmk2, $eINWC, $S3IJB, $vw_qw, $qxz1W, $DfuA7 = '余额提现') { self::change($MqkYF, -$HWmk2, '余额提现'); ModelUtil::insert('member_money_cash', array('memberUserId' => $MqkYF, 'status' => MemberMoneyCashStatus::VERIFYING, 'money' => $HWmk2, 'moneyAfterTax' => $eINWC, 'type' => $S3IJB, 'realname' => $vw_qw, 'account' => $qxz1W, 'remark' => $DfuA7)); } public static function paginateCash($MqkYF, $gETpv, $Wo30p, $InfBU = array()) { $InfBU['where']['memberUserId'] = $MqkYF; return ModelUtil::paginate('member_money_cash', $gETpv, $Wo30p, $InfBU); } public static function createCharge($MqkYF, $qqMY3) { return ModelUtil::insert('member_money_charge', array('sn' => IdUtil::generateSN(), 'status' => MemberMoneyChargeStatus::CREATED, 'memberUserId' => $MqkYF, 'fee' => $qqMY3)); } public static function processCharge($ss6Ko) { goto oEfw4; EsZdT: self::change($Ez6eC['memberUserId'], $Ez6eC['fee'], '充值'); goto aL5vL; aL5vL: ModelUtil::update('member_money_charge', array('id' => $ss6Ko), array('status' => MemberMoneyChargeStatus::SUCCESS)); goto x32py; la4Mw: if (empty($Ez6eC)) { throw new \Exception('member_money_charge empty -> ' . $ss6Ko); } goto q3ZKo; q3ZKo: if ($Ez6eC['status'] != MemberMoneyChargeStatus::CREATED) { throw new \Exception('member_money_charge status error -> ' . $ss6Ko); } goto EsZdT; oEfw4: $Ez6eC = ModelUtil::getWithLock('member_money_charge', array('id' => $ss6Ko)); goto la4Mw; x32py: } }