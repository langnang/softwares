<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Util; use Illuminate\Support\Facades\Cache; use Illuminate\Support\Str; use Intervention\Image\Facades\Image; use ModStart\Core\Assets\AssetsUtil; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Core\Util\AgentUtil; use ModStart\Core\Util\ArrayUtil; use ModStart\Core\Util\EncodeUtil; use ModStart\Core\Util\FormatUtil; use ModStart\Core\Util\RandomUtil; use ModStart\Data\DataManager; use ModStart\Data\Event\DataFileUploadedEvent; use Module\Member\Events\MemberUserLoginAttemptEvent; use Module\Member\Events\MemberUserLoginFailedEvent; use Module\Member\Type\MemberMessageStatus; use Module\Member\Type\MemberStatus; class MemberUtil { public static function total() { return Cache::remember('MemberUserTotal', 60, function () { return ModelUtil::count('member_user'); }); } public static function get($wa91I) { return ModelUtil::get('member_user', array('id' => $wa91I)); } public static function getCached($wa91I) { return Cache::remember('MemberUser:' . $wa91I, 60, function () use($wa91I) { return self::get($wa91I); }); } public static function processDefault(&$w45m7) { goto sbWxp; C4Vwx: if (empty($w45m7['nickname'])) { $w45m7['nickname'] = $w45m7['username']; } goto IG1Dv; sbWxp: if (empty($w45m7)) { return; } goto C4Vwx; WA4cE: if (empty($w45m7['avatarMedium'])) { $w45m7['avatarMedium'] = AssetsUtil::fixFull('asset/image/avatar.svg', false); } goto bGqFo; bGqFo: if (empty($w45m7['avatarBig'])) { $w45m7['avatarBig'] = AssetsUtil::fixFull('asset/image/avatar.svg', false); } goto mlOb7; IG1Dv: if (empty($w45m7['avatar'])) { $w45m7['avatar'] = AssetsUtil::fixFull('asset/image/avatar.svg', false); } goto WA4cE; mlOb7: } private static function processBasicFields($r3lK5) { goto XC8ti; tvktp: return $r3lK5; goto C8SN3; XC8ti: $vBSq7 = array('id', 'username', 'avatar', 'created_at', 'signature', 'nickname'); goto abQse; abQse: if (null === $r3lK5) { $r3lK5 = $vBSq7; } else { goto aha3D; ZnS8m: foreach ($r3lK5 as $nJFbs) { if ('<basic>' == $nJFbs) { $DLXst = array_merge($DLXst, $vBSq7); } else { $DLXst[] = $nJFbs; } } goto RXUx_; aha3D: $DLXst = array(); goto ZnS8m; RXUx_: $r3lK5 = $DLXst; goto uJ9iT; uJ9iT: } goto tvktp; C8SN3: } public static function fixAvatar($jPxQy) { return AssetsUtil::fixFullOrDefault($jPxQy, 'asset/image/avatar.svg'); } public static function getBasic($wa91I, $r3lK5 = null) { goto mx1Gx; MUbJd: if (empty($REa1I)) { return null; } goto C2T9o; C2T9o: if (empty($REa1I['nickname'])) { $REa1I['nickname'] = $REa1I['username']; } goto BsZ7Q; cELYS: $REa1I = self::get($wa91I); goto MUbJd; D5wDi: $hlYz_ = array(); goto kUXRd; ub4yF: return $hlYz_; goto gIUsh; mx1Gx: $r3lK5 = self::processBasicFields($r3lK5); goto cELYS; kUXRd: foreach ($r3lK5 as $F1bGF) { if (isset($REa1I[$F1bGF])) { $hlYz_[$F1bGF] = $REa1I[$F1bGF]; } else { $hlYz_[$F1bGF] = null; } } goto ub4yF; BsZ7Q: $REa1I['avatar'] = self::fixAvatar($REa1I['avatar']); goto D5wDi; gIUsh: } public static function listViewName($Da1nS) { goto kR_fZ; kR_fZ: $V8m5o = array(); goto HaK6d; XpNbE: return $V8m5o; goto lqe6c; bFvQq: foreach ($HUANX as $w45m7) { $V8m5o[] = self::viewName($w45m7); } goto XpNbE; HaK6d: $HUANX = ModelUtil::allIn('member_user', 'id', $Da1nS); goto bFvQq; lqe6c: } public static function listUsers($Da1nS) { return ModelUtil::allIn('member_user', 'id', $Da1nS); } public static function convertOneToBasic($w45m7) { return array('id' => $w45m7['id'], 'username' => $w45m7['username'], 'nickname' => empty($w45m7['nickname']) ? $w45m7['username'] : $w45m7['nickname'], 'created_at' => $w45m7['created_at'], 'signature' => isset($w45m7['signature']) ? $w45m7['signature'] : null, 'avatar' => AssetsUtil::fixFullOrDefault($w45m7['avatar'], 'asset/image/avatar.svg')); } public static function convertToBasic($HUANX) { return array_map(function ($REa1I) { return array('id' => $REa1I['id'], 'username' => $REa1I['username'], 'nickname' => empty($REa1I['nickname']) ? $REa1I['username'] : $REa1I['nickname'], 'created_at' => $REa1I['created_at'], 'signature' => isset($REa1I['signature']) ? $REa1I['signature'] : null, 'avatar' => AssetsUtil::fixFullOrDefault($REa1I['avatar'], 'asset/image/avatar.svg')); }, $HUANX); } public static function listUsersBasic($Da1nS) { return self::convertToBasic(self::listUsers($Da1nS)); } public static function getViewName($wa91I) { return self::viewName(self::get($wa91I)); } public static function viewName($w45m7) { goto kkDxv; dzzqI: return "ID-{$w45m7['id']}"; goto a3SIJ; uxkQz: if (!empty($w45m7['username'])) { return $w45m7['username']; } goto dzzqI; snxqv: if (empty($w45m7)) { return '-'; } goto RP_0K; RP_0K: if (!empty($w45m7['nickname'])) { return $w45m7['nickname']; } goto uxkQz; kkDxv: if ($w45m7 && is_numeric($w45m7)) { return self::getViewName($w45m7); } goto snxqv; a3SIJ: } public static function update($wa91I, $GeXSC) { return ModelUtil::update('member_user', array('id' => $wa91I), $GeXSC); } public static function updateBasicWithUniqueCheck($wa91I, $GeXSC) { goto GvlPT; YgmBJ: return Response::generate(0, 'ok'); goto CJz4F; kt2wA: foreach (array('username' => '用户名', 'phone' => '手机', 'email' => '邮箱') as $QGYmu => $Zm_La) { if (isset($GeXSC[$QGYmu])) { goto GLo8E; GLo8E: if (empty($GeXSC[$QGYmu])) { $GeXSC[$QGYmu] = null; continue; } goto P_xe0; D3Gq_: if (count($M6ZFe) == 1) { if ($M6ZFe[0]['id'] != $wa91I) { return Response::generate(-1, $Zm_La . '重复'); } } goto lsF5t; P6p1J: if (count($M6ZFe) > 1) { return Response::generate(-1, $Zm_La . '重复'); } goto D3Gq_; P_xe0: $M6ZFe = ModelUtil::all('member_user', array($QGYmu => $GeXSC[$QGYmu])); goto P6p1J; lsF5t: } } goto U3zbY; GvlPT: if (empty($GeXSC)) { return Response::generate(0, 'ok'); } goto kt2wA; U3zbY: self::update($wa91I, $GeXSC); goto YgmBJ; CJz4F: } public static function login($eM5tA = '', $deRjP = '', $ZYL8t = '', $N7mFY = '') { goto JxA4D; Ogvm2: if ($ZYL8t) { if (!FormatUtil::isEmail($ZYL8t)) { return Response::generate(-3, '邮箱格式不正确'); } $LJw3u = array('email' => $ZYL8t); } else { if ($deRjP) { if (!preg_match('/(^1[0-9]{10}$)/', $deRjP)) { return Response::generate(-4, '手机格式不正确'); } $LJw3u = array('phone' => $deRjP); } else { if ($eM5tA) { if (strpos($eM5tA, '@') !== false) { return Response::generate(-5, '用户名格式不正确'); } $LJw3u = array('username' => $eM5tA); } } } goto fJYWT; J3qQF: $deRjP = trim($deRjP); goto fgW11; XTBfO: if (!($ZYL8t || $deRjP || $eM5tA)) { return Response::generate(-1, '所有登录字段均为空'); } goto S3u1Z; eVCYE: return Response::generateSuccessData($w45m7); goto bwxib; gX1Yd: switch ($w45m7['status']) { case MemberStatus::FORBIDDEN: return Response::generateError(-8, '登录失败:当前用户已被禁用'); } goto eVCYE; ag2NG: MemberUserLoginAttemptEvent::fire($w45m7['id'], Request::ip(), AgentUtil::getUserAgent()); goto CVn0k; JxA4D: $ZYL8t = trim($ZYL8t); goto J3qQF; fJYWT: $w45m7 = ModelUtil::get('member_user', $LJw3u); goto cVWIk; fgW11: $eM5tA = trim($eM5tA); goto XTBfO; CVn0k: if ($w45m7['password'] != EncodeUtil::md5WithSalt($N7mFY, $w45m7['passwordSalt'])) { MemberUserLoginFailedEvent::fire($w45m7['id'], $w45m7['username'], Request::ip(), AgentUtil::getUserAgent()); return Response::generate(-7, '登录失败:用户名或密码错误'); } goto gX1Yd; S3u1Z: if (!$N7mFY) { return Response::generate(-2, '密码为空'); } goto Ogvm2; cVWIk: if (empty($w45m7)) { return Response::generate(-6, '登录失败:用户名或密码错误'); } goto ag2NG; bwxib: } public static function autoSetUsernameNickname($MqkYF, $zZagK) { goto U8htI; U8htI: $edX0q = 6; goto C2FpY; C2FpY: if (preg_match('/\\{.*\\}/', $zZagK)) { goto iMPCC; Uw_fd: $TbleL = array('{Phone}' => $w45m7['phone'], '{Phone4}' => substr($w45m7['phone'], 7), '{Uid}' => $w45m7['id']); goto FmfcE; FmfcE: $zZagK = str_replace(array_keys($TbleL), array_values($TbleL), $zZagK); goto n8gYx; n8gYx: $edX0q = 0; goto UKcMR; iMPCC: $w45m7 = self::get($MqkYF); goto Uw_fd; UKcMR: } goto z5JA5; z5JA5: self::suggestUsernameNickname($MqkYF, $zZagK, $edX0q); goto J5zaS; J5zaS: } public static function getSuggestUsernameNickname($aVm4X) { goto Ih0aN; Ih0aN: $zZagK = $aVm4X . Str::random(1); goto hHCZJ; nIn3c: return $zZagK . Str::random(10); goto Lx7R6; hHCZJ: for ($l3Jim = 0; $l3Jim < 20; $l3Jim++) { $n17gu = ModelUtil::model('member_user')->where(array('username' => $zZagK))->orWhere(array('nickname' => $zZagK))->first(); if (empty($n17gu)) { return $zZagK; } $zZagK = $zZagK . Str::random(1); } goto nIn3c; Lx7R6: } private static function suggestUsernameNickname($MqkYF, $JAbBw = '用户', $edX0q = 6) { goto oRgVt; oRgVt: if ($edX0q > 0) { $zZagK = $JAbBw . RandomUtil::string($edX0q); } else { $zZagK = $JAbBw; } goto bekms; bekms: for ($l3Jim = 0; $l3Jim < 20; $l3Jim++) { $n17gu = ModelUtil::model('member_user')->where(array('username' => $zZagK))->orWhere(array('nickname' => $zZagK))->first(); if (empty($n17gu)) { break; } $zZagK = $zZagK . Str::random(1); } goto aPajI; aPajI: ModelUtil::update('member_user', $MqkYF, array('username' => $zZagK, 'nickname' => $zZagK)); goto kGaLe; kGaLe: } public static function registerUsernameQuick($eM5tA) { goto M_gCE; M_gCE: $UmCq1 = $eM5tA; goto Ez7ht; Ez7ht: for ($l3Jim = 0; $l3Jim < 10; $l3Jim++) { $BEdDh = self::register($UmCq1, '', '', '', true); if ($BEdDh['code']) { $UmCq1 = $UmCq1 . Str::random(1); } else { return $BEdDh; } } goto He67R; He67R: return Response::generateError('注册失败'); goto rJx0Y; rJx0Y: } public static function register($eM5tA = '', $deRjP = '', $ZYL8t = '', $N7mFY = '', $uQRX4 = false) { goto Xv8Qj; dW2eb: $pIByQ = Str::random(16); goto T4D0P; T4D0P: $w45m7 = ModelUtil::insert('member_user', array('status' => MemberStatus::NORMAL, 'username' => $eM5tA, 'email' => $ZYL8t, 'phone' => $deRjP, 'password' => $uQRX4 ? null : EncodeUtil::md5WithSalt($N7mFY, $pIByQ), 'passwordSalt' => $uQRX4 ? null : $pIByQ, 'isDeleted' => false)); goto Z49hD; JdfgW: if (!$uQRX4) { if (empty($N7mFY) || strlen($N7mFY) < 6) { return Response::generate(-3, '密码不合法'); } } goto dW2eb; AGWKN: if ($deRjP) { $BEdDh = self::uniqueCheck('phone', $deRjP); if ($BEdDh['code']) { return $BEdDh; } } else { $deRjP = null; } goto mXJWb; Xv8Qj: $ZYL8t = trim($ZYL8t); goto F1HRu; FII0O: if ($ZYL8t) { $BEdDh = self::uniqueCheck('email', $ZYL8t); if ($BEdDh['code']) { return $BEdDh; } } else { $ZYL8t = null; } goto AGWKN; mXJWb: if ($eM5tA) { goto wGDtX; wGDtX: $BEdDh = self::uniqueCheck('username', $eM5tA); goto aRdPq; dL7p3: if (Str::contains($eM5tA, '@')) { return Response::generate(-1, '用户名不能包含特殊字符'); } goto HGynL; aRdPq: if ($BEdDh['code']) { return $BEdDh; } goto wYb_4; HGynL: if (preg_match('/^[0-9]{11}$/', $eM5tA)) { return Response::generate(-1, '用户名不能为纯数字'); } goto XiGWo; wYb_4: if (strlen($eM5tA) < modstart_config('Member_UsernameMinLength', 3)) { return Response::generate(-1, '用户名至少3个字符'); } goto dL7p3; XiGWo: } else { $eM5tA = null; } goto JdfgW; Voy_u: if (!($ZYL8t || $deRjP || $eM5tA)) { return Response::generate(-1, '所有注册字段均为空'); } goto FII0O; Gkh1N: $eM5tA = trim($eM5tA); goto Voy_u; Z49hD: return Response::generate(0, 'ok', $w45m7); goto ykQNW; F1HRu: $deRjP = trim($deRjP); goto Gkh1N; ykQNW: } public static function uniqueCheck($S3IJB, $WZC9G, $xCUXn = 0) { goto YbKT5; l23MU: $Fu5yi = array('username' => '用户名', 'email' => '邮箱', 'phone' => '手机号'); goto GdCYQ; dobRk: return Response::generate(-2, $Fu5yi[$S3IJB] . '已经被占用'); goto wjXI0; uXDay: $w45m7 = ModelUtil::get('member_user', array($S3IJB => $WZC9G)); goto eb6tp; HBlAR: switch ($S3IJB) { case 'email': if (!FormatUtil::isEmail($WZC9G)) { return Response::generate(-1, '邮箱格式不正确'); } break; case 'phone': if (!preg_match('/(^1[0-9]{10}$)/', $WZC9G)) { return Response::generate(-1, '手机格式不正确'); } break; case 'username': if (strpos($WZC9G, '@') !== false) { return Response::generate(-1, '用户名格式不正确'); } break; case 'nickname': break; default: return Response::generate(-1, '未能识别的类型' . $S3IJB); } goto uXDay; YbKT5: $WZC9G = trim($WZC9G); goto HBlAR; GdCYQ: if ($xCUXn == $w45m7['id']) { return Response::generate(0, 'ok'); } goto dobRk; eb6tp: if (empty($w45m7)) { return Response::generate(0, 'ok'); } goto l23MU; wjXI0: } public static function getByUsername($eM5tA) { return ModelUtil::get('member_user', array('username' => $eM5tA)); } public static function getByEmail($ZYL8t) { return ModelUtil::get('member_user', array('email' => $ZYL8t)); } public static function getByPhone($deRjP) { return ModelUtil::get('member_user', array('phone' => $deRjP)); } public static function changeNickname($MqkYF, $YCRAF) { goto Hd4XI; zOyHO: return Response::generate(0, 'ok'); goto FDesj; Hd4XI: $BEdDh = self::uniqueCheck('nickname', $YCRAF, $MqkYF); goto OOqe6; dRYeM: ModelUtil::update('member_user', $MqkYF, array('nickname' => $YCRAF)); goto zOyHO; OOqe6: if (Response::isError($BEdDh)) { return $BEdDh; } goto dRYeM; FDesj: } public static function changePassword($MqkYF, $QzdXs, $dZkcJ = null, $L2AQ6 = false) { goto QuCVb; Af2Tc: $w45m7 = ModelUtil::get('member_user', array('id' => $MqkYF)); goto VZnws; QuCVb: if (!$L2AQ6 && empty($dZkcJ)) { return Response::generate(-1, '旧密码不能为空'); } goto Af2Tc; VZnws: if (empty($w45m7)) { return Response::generate(-1, '用户不存在'); } goto vnRnr; vw5BX: $pIByQ = Str::random(16); goto GyIPa; iiuoN: if (!$L2AQ6 && EncodeUtil::md5WithSalt($dZkcJ, $w45m7['passwordSalt']) != $w45m7['password']) { return Response::generate(-1, '旧密码不正确'); } goto vw5BX; GyIPa: ModelUtil::update('member_user', array('id' => $w45m7['id']), array('passwordSalt' => $pIByQ, 'password' => EncodeUtil::md5WithSalt($QzdXs, $pIByQ))); goto iKO3N; vnRnr: if (empty($QzdXs)) { return Response::generate(-1, '新密码为空'); } goto iiuoN; iKO3N: return Response::generate(0, 'ok'); goto SIyDa; SIyDa: } public static function setAvatar($qpQex, $Uu0Kg, $Bbc8G = 'jpg') { goto QGjOv; IwlSr: $wTHD1 = DataManager::upload('image', 'U' . $qpQex . '_AvatarMiddle.' . $Bbc8G, $UaMyp); goto YnExi; QGjOv: $w45m7 = self::get($qpQex); goto i56Nk; i56Nk: if (empty($w45m7)) { return Response::generate(-1, '用户不存在'); } goto OQIKn; OQIKn: if (empty($Uu0Kg)) { return Response::generate(-1, '图片数据为空'); } goto Qt1Vd; Ak2hw: if ($BEdDh['code']) { goto fScjH; fScjH: DataManager::deleteById($Kt8w3['data']['id']); goto eLWpv; eLWpv: DataManager::deleteById($wTHD1['data']['id']); goto WFY80; WFY80: if ($Kt8w3['code']) { return Response::generate(-1, '头像存储失败（' . $BEdDh['msg'] . '）'); } goto cYTdF; cYTdF: } goto vvpVz; Mxnml: $Kt8w3 = DataManager::upload('image', 'U' . $qpQex . '_AvatarBig.' . $Bbc8G, $VZBvp); goto bAv5d; bAv5d: if ($Kt8w3['code']) { return Response::generate(-1, '头像存储失败（' . $Kt8w3['msg'] . '）'); } goto IwlSr; wPNzw: return Response::generateSuccess(); goto gSD3l; Qt1Vd: $VZBvp = (string) Image::make($Uu0Kg)->resize(400, 400)->encode($Bbc8G, 75); goto nzCiW; FXcvs: $BEdDh = DataManager::upload('image', 'U_' . $qpQex . '_Avatar.' . $Bbc8G, $SWu8S); goto Ak2hw; nzCiW: $UaMyp = (string) Image::make($Uu0Kg)->resize(200, 200)->encode($Bbc8G, 75); goto Vi89m; vvpVz: if (class_exists('ModStart\\Data\\Event\\DataFileUploadedEvent')) { DataFileUploadedEvent::forgetParam('imageCompressIgnore'); DataFileUploadedEvent::forgetParam('imageWatermarkIgnore'); } goto ibqxT; Vi89m: $SWu8S = (string) Image::make($Uu0Kg)->resize(50, 50)->encode($Bbc8G, 75); goto L3tMu; ibqxT: self::update($w45m7['id'], array('avatarBig' => $Kt8w3['data']['fullPath'], 'avatarMedium' => $wTHD1['data']['fullPath'], 'avatar' => $BEdDh['data']['fullPath'])); goto wPNzw; YnExi: if ($wTHD1['code']) { DataManager::deleteById($Kt8w3['data']['id']); if ($Kt8w3['code']) { return Response::generate(-1, '头像存储失败（' . $wTHD1['msg'] . '）'); } } goto FXcvs; L3tMu: if (class_exists('ModStart\\Data\\Event\\DataFileUploadedEvent')) { DataFileUploadedEvent::setParam('imageCompressIgnore', true); DataFileUploadedEvent::setParam('imageWatermarkIgnore', true); } goto Mxnml; gSD3l: } public static function findUsers($rsIbC) { goto f6KXv; f6KXv: if (empty($rsIbC)) { return array(); } goto cQrhy; cQrhy: $twLM3 = array(); goto OGpx9; NPOaa: return $twLM3; goto aj7Ve; ZUaYG: foreach ($HUANX as &$wv9SM) { $twLM3[$wv9SM->id] = $wv9SM->toArray(); } goto NPOaa; OGpx9: $HUANX = ModelUtil::model('member_user')->whereIn('id', $rsIbC)->get(); goto ZUaYG; aj7Ve: } public static function filterUserIds($rsIbC) { goto woybv; UF8_8: $TbleL = array(); goto X_hZQ; X_hZQ: $HUANX = ModelUtil::model('member_user')->whereIn('id', $rsIbC)->get(array('id')); goto siPvJ; siPvJ: foreach ($HUANX as &$wv9SM) { $TbleL[$wv9SM->id] = true; } goto THYF5; THYF5: return array_keys($TbleL); goto fvAVe; woybv: if (empty($rsIbC)) { return array(); } goto UF8_8; fvAVe: } public static function mergeMemberUsers(&$v39Ud, $ZVfG7 = 'memberUserId', $mKYuF = '_memberUser') { ModelUtil::join($v39Ud, $ZVfG7, $mKYuF, 'member_user', 'id'); } public static function mergeMemberUserBasics(&$v39Ud, $ZVfG7 = 'memberUserId', $mKYuF = '_memberUser', $r3lK5 = null) { $r3lK5 = self::processBasicFields($r3lK5); if (is_array($v39Ud)) { ModelUtil::join($v39Ud, $ZVfG7, $mKYuF, 'member_user', 'id'); foreach ($v39Ud as $nJFbs => $NIxlc) { goto jeiDT; jeiDT: if (empty($NIxlc[$mKYuF])) { continue; } goto CWUmD; u5AIY: $v39Ud[$nJFbs][$mKYuF] = $w45m7; goto HNFmv; CWUmD: $w45m7 = ArrayUtil::keepKeys($NIxlc[$mKYuF], $r3lK5); goto TjymX; Nuary: if (empty($w45m7['avatar'])) { $w45m7['avatar'] = AssetsUtil::fixFull('asset/image/avatar.svg'); } else { $w45m7['avatar'] = AssetsUtil::fixFull($w45m7['avatar']); } goto u5AIY; TjymX: if (empty($w45m7['nickname'])) { $w45m7['nickname'] = $w45m7['username']; } goto Nuary; HNFmv: } } else { ModelUtil::joinItems($v39Ud, $ZVfG7, $mKYuF, 'member_user', 'id'); foreach ($v39Ud as $REa1I) { goto n7KQh; cF40h: $w45m7 = ArrayUtil::keepKeys($REa1I->{$mKYuF}, $r3lK5); goto lfJMa; n7KQh: if (empty($REa1I->{$mKYuF})) { continue; } goto cF40h; ASt4b: if (empty($w45m7['avatar'])) { $w45m7['avatar'] = AssetsUtil::fixFull('asset/image/avatar.svg'); } else { $w45m7['avatar'] = AssetsUtil::fixFull($w45m7['avatar']); } goto figuo; figuo: $REa1I->{$mKYuF} = $w45m7; goto PBxLv; lfJMa: if (empty($w45m7['nickname'])) { $w45m7['nickname'] = $w45m7['username']; } goto ASt4b; PBxLv: } } } public static function insert($GeXSC) { return ModelUtil::insert('member_user', $GeXSC); } public static function getIdByOauth($Mm7Ly, $qFGW9) { goto EGi6S; g4lRD: return intval($nq5ti['memberUserId']); goto Adm82; bYuoy: if (empty($nq5ti)) { return 0; } goto g4lRD; EGi6S: $nq5ti = ModelUtil::get('member_oauth', array('type' => $Mm7Ly, 'openId' => $qFGW9)); goto bYuoy; Adm82: } public static function getIdByOauthAndCheck($Mm7Ly, $qFGW9) { goto g4_2h; JhvCv: MemberUtil::forgetOauth($Mm7Ly, $qFGW9); goto aZrBI; aZrBI: return 0; goto PnMsl; uAYL3: if (self::get($MqkYF)) { return $MqkYF; } goto JhvCv; g4_2h: $MqkYF = self::getIdByOauth($Mm7Ly, $qFGW9); goto uAYL3; PnMsl: } public static function getOauthOpenId($MqkYF, $Mm7Ly) { goto EMT8a; UxfW0: $nq5ti = ModelUtil::get('member_oauth', $LJw3u); goto vhNda; vhNda: if (empty($nq5ti)) { return null; } goto UG36K; UG36K: return $nq5ti['openId']; goto flZVW; EMT8a: $LJw3u = array('memberUserId' => $MqkYF, 'type' => $Mm7Ly); goto UxfW0; flZVW: } public static function getOauth($MqkYF, $Mm7Ly) { $LJw3u = array('memberUserId' => $MqkYF, 'type' => $Mm7Ly); return ModelUtil::get('member_oauth', $LJw3u); } public static function listOauths($MqkYF) { return ModelUtil::all('member_oauth', array('memberUserId' => $MqkYF), array('*'), array('type', 'asc')); } public static function putOauth($MqkYF, $Mm7Ly, $qFGW9, $kkerk = array()) { goto TZurP; TZurP: $LJw3u = array('memberUserId' => $MqkYF, 'type' => $Mm7Ly); goto ZOmk4; ZOmk4: $nq5ti = ModelUtil::get('member_oauth', $LJw3u); goto zXRhR; zXRhR: if (empty($nq5ti)) { ModelUtil::insert('member_oauth', array_merge($LJw3u, array('openId' => $qFGW9), $kkerk)); } else { if ($nq5ti['openId'] != $qFGW9) { ModelUtil::update('member_oauth', array('id' => $nq5ti['id']), array_merge(array('openId' => $qFGW9), $kkerk)); } } goto VvfBl; VvfBl: } public static function forgetOauth($Mm7Ly, $qFGW9) { ModelUtil::delete('member_oauth', array('type' => $Mm7Ly, 'openId' => $qFGW9)); } public static function updateNewMessageStatus($MqkYF) { ModelUtil::update('member_user', array('id' => $MqkYF), array('newMessageCount' => ModelUtil::count('member_message', array('userId' => $MqkYF, 'status' => MemberMessageStatus::UNREAD)))); } public static function updateNewChatMsgStatus($MqkYF) { if (modstart_module_enabled('MemberChat')) { ModelUtil::update('member_user', array('id' => $MqkYF), array('newChatMsgCount' => ModelUtil::sum('member_chat', 'unreadMsgCount', array('memberUserId' => $MqkYF)))); } } public static function paginate($gETpv, $Wo30p, $InfBU = array()) { return ModelUtil::paginate('member_user', $gETpv, $Wo30p, $InfBU); } public static function updateStatus($xi417, $M0y01) { goto xYCuR; xYCuR: if (!is_array($xi417)) { $xi417 = array($xi417); } goto oznyZ; oznyZ: if (empty($xi417)) { return; } goto C2CjU; C2CjU: ModelUtil::model('member_user')->whereIn('id', $xi417)->update(array('status' => $M0y01)); goto jtDje; jtDje: } public static function delete($MqkYF) { goto Nb9ci; Nb9ci: $w45m7 = self::get($MqkYF); goto y5Ev5; IzZDE: ModelUtil::insert('member_deleted', array('id' => $w45m7['id'], 'username' => $w45m7['username'], 'phone' => $w45m7['phone'], 'email' => $w45m7['email'], 'content' => json_encode($KqFED, JSON_UNESCAPED_UNICODE))); goto Rk29I; Rk29I: ModelUtil::update('member_user', $MqkYF, array('deleteAtTime' => 0, 'isDeleted' => true, 'username' => null, 'phone' => null, 'email' => null)); goto GWpp7; ZPUfU: $KqFED['oauth'] = ArrayUtil::keepItemsKeys($FZm1s, array('type', 'openId', 'infoUsername', 'infoAvatar')); goto IzZDE; xJsF7: ModelUtil::transactionBegin(); goto zCmXJ; NQDld: $FZm1s = ModelUtil::all('member_oauth', array('memberUserId' => $w45m7['id'])); goto ZPUfU; zCmXJ: $KqFED = array(); goto NQDld; y5Ev5: BizException::throwsIfEmpty('用户不存在', $w45m7); goto xJsF7; GWpp7: ModelUtil::transactionCommit(); goto v82Y2; v82Y2: } }