<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Web\Controller; use Illuminate\Support\Facades\View; use ModStart\App\Web\Layout\WebConfigBuilder; use ModStart\App\Web\Layout\WebPage; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Core\Util\ArrayUtil; use ModStart\Core\Util\CRUDUtil; use ModStart\Field\AbstractField; use ModStart\Field\AutoRenderedFieldValue; use ModStart\Form\Form; use ModStart\Grid\Grid; use ModStart\Grid\GridFilter; use ModStart\Module\ModuleManager; use ModStart\Repository\Filter\RepositoryFilter; use Module\Member\Auth\MemberUser; use Module\Member\Support\MemberLoginCheck; class MemberAddressController extends MemberFrameController implements MemberLoginCheck { private $api; public function __construct() { parent::__construct(); $this->api = app(\Module\Member\Api\Controller\MemberAddressController::class); } public function index(WebPage $gETpv) { goto b1_W7; godeU: $rWlsS->useSimple(function (AbstractField $QGYmu, $REa1I, $x1Lvn) { return AutoRenderedFieldValue::makeView('module::Member.View.pc.memberAddress.item', array('item' => $REa1I)); }); goto gjgRY; nTljb: $rWlsS->repositoryFilter(function (RepositoryFilter $qM7YH) { $qM7YH->where(array('memberUserId' => MemberUser::id())); }); goto jWo_H; jWo_H: $rWlsS->disableCUD()->disableItemOperate()->canAdd(true)->urlAdd(action('\\' . __CLASS__ . '@add'))->addDialogSize(array('60%', '80%')); goto godeU; gjgRY: $rWlsS->title('地址'); goto oP_oz; zlgun: list($Mi0Iq, $GmKGX) = $this->viewPaths('memberAddress.index'); goto wA9Fe; oP_oz: if (Request::isPost()) { return $rWlsS->request(); } goto zlgun; b1_W7: $rWlsS = Grid::make('member_address'); goto nTljb; wA9Fe: return $gETpv->view($Mi0Iq)->pageTitle('我的地址')->body($rWlsS); goto B_KX7; B_KX7: } private function doAddEdit() { goto NKzKq; vSVim: return $cv5kq->perform(ArrayUtil::keepKeys($NZ_6d, array('name', 'phone', 'area', 'detail', 'post')), function (Form $Yfg4L) use($wa91I) { $GeXSC = $Yfg4L->dataForming(); if ($wa91I) { ModelUtil::update('member_address', $wa91I, $GeXSC); } else { $GeXSC['memberUserId'] = MemberUser::id(); ModelUtil::insert('member_address', $GeXSC); } return Response::redirect(CRUDUtil::jsDialogCloseAndParentGridRefresh()); }); goto aDwuy; z78pO: $NZ_6d = null; goto gN1jU; MobWf: $cv5kq->text('name', '姓名')->required(); goto qMUD5; zk_vy: $cv5kq->useDialog(); goto a8_2a; a8_2a: $cv5kq->pageTitle(($wa91I ? '修改' : '增加') . '地址'); goto MobWf; BBNsI: $cv5kq->text('post', '邮政编码'); goto vSVim; gN1jU: if ($wa91I) { $NZ_6d = ModelUtil::get('member_address', array('id' => $wa91I, 'memberUserId' => MemberUser::id())); BizException::throwsIfEmpty('地址不存在', $NZ_6d); } goto iDPZz; NKzKq: $wa91I = CRUDUtil::id(); goto z78pO; qMUD5: $cv5kq->text('phone', '手机号')->required(); goto cq7GC; uy2IE: $cv5kq->textarea('detail', '详细地址')->required(); goto BBNsI; iDPZz: $cv5kq = app(WebConfigBuilder::class); goto zk_vy; cq7GC: if (ModuleManager::isModuleEnabled('Area')) { $cv5kq->areaChina('area', '省市地区')->required(); } else { $Qvp1e = '<div class=\'tw-bg-gray-200 tw-rounded tw-px-2\'>省市地区需要依赖 <a href=\'https://modstart.com/m/Area\' target=\'_blank\'>Area</a> 模块</div>'; $cv5kq->html('area', '省市地区')->html($Qvp1e)->addable(true)->required(); } goto uy2IE; aDwuy: } public function add() { return $this->doAddEdit(); } public function edit() { return $this->doAddEdit(); } public function delete() { goto CzIg0; t5xLn: BizException::throwsIfEmpty('地址不存在', $NZ_6d); goto rdaSe; L6TQP: return Response::redirect(CRUDUtil::jsGridRefresh()); goto Uj6rj; rdaSe: ModelUtil::delete('member_address', $wa91I); goto L6TQP; y3JNr: $NZ_6d = ModelUtil::get('member_address', array('id' => $wa91I, 'memberUserId' => MemberUser::id())); goto t5xLn; CzIg0: $wa91I = CRUDUtil::id(); goto y3JNr; Uj6rj: } }