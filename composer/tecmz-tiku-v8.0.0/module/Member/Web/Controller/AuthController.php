<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Web\Controller; use Illuminate\Support\Facades\Input; use Illuminate\Support\Facades\Session; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Module\ModuleBaseController; use Module\Member\Auth\MemberUser; class AuthController extends ModuleBaseController { private $api; public function __construct() { $this->api = app(\Module\Member\Api\Controller\AuthController::class); } public function login() { goto YyGFV; lBOgX: $a78Dc = $bz1sB->getInteger('dialog'); goto v1Cyc; v1Cyc: $UYUrz = $bz1sB->getTrimString('redirect', modstart_web_url('member')); goto vLqPY; S_wfm: $this->api->checkRedirectSafety($UYUrz); goto kBOb1; kBOb1: if (modstart_config('ssoClientEnable', false)) { goto D37ue; Voww3: if ($a78Dc) { return Response::send(0, '', '', '[js]parent.location.href=' . json_encode($BEdDh['data']['redirect']) . ';'); } goto o65bA; DwKeQ: Session::put('ssoClientRedirect', $UYUrz); goto Voww3; tZE5Q: if ($BEdDh['code']) { return Response::send(-1, $BEdDh['msg']); } goto DwKeQ; lOaHf: $BEdDh = $this->api->ssoClientPrepare(); goto tZE5Q; D37ue: Input::merge(array('client' => Request::domainUrl() . '/sso/client')); goto lOaHf; o65bA: return Response::send(0, null, null, $BEdDh['data']['redirect']); goto JTtQG; JTtQG: } goto Hg56G; xO33q: if ($a78Dc) { $Jc268['dialog'] = $a78Dc; } goto S_wfm; qcUIj: $Mi0Iq = 'login'; goto UjNvQ; Hg56G: if (Request::isPost()) { goto bUO2M; KiO0A: return Response::send(0, '', '', $UYUrz); goto U2LI0; g3EHD: if (Response::isError($BEdDh)) { return Response::sendFromGenerate($BEdDh); } goto I5wZE; I5wZE: if ($a78Dc) { return Response::send(0, '', '', '[js]parent.location.href=' . json_encode($UYUrz) . ';'); } goto KiO0A; bUO2M: $BEdDh = $this->api->login(); goto g3EHD; U2LI0: } goto pbIqy; OB0MX: return $this->view($Mi0Iq, $Jc268); goto ot1am; YyGFV: $bz1sB = InputPackage::buildFromInput(); goto lBOgX; UjNvQ: if ($a78Dc) { $Mi0Iq = 'loginDialog'; } goto OB0MX; pbIqy: if (modstart_config('Member_LoginPhoneEnable', false)) { $lAB1A = modstart_config('Member_LoginDefault', 'default'); if ('phone' == $lAB1A) { $XgKhb = $bz1sB->getBoolean('force', false); if (!$XgKhb) { return Response::redirect(modstart_web_url('login/phone', $Jc268)); } } } goto qcUIj; vLqPY: $Jc268 = array('redirect' => $UYUrz); goto xO33q; ot1am: } public function loginCaptcha() { return $this->api->loginCaptchaRaw(); } public function loginPhone() { goto rVyBi; iKGU4: $UYUrz = $bz1sB->getTrimString('redirect', modstart_web_url('member')); goto kRP9B; rVyBi: $bz1sB = InputPackage::buildFromInput(); goto S35ZF; S35ZF: $a78Dc = $bz1sB->getInteger('dialog'); goto iKGU4; p4d4p: $Mi0Iq = 'loginPhone'; goto bCtzu; uos2V: if ($a78Dc) { $Jc268['dialog'] = $a78Dc; } goto RYzW3; uLM_z: return $this->view($Mi0Iq, $Jc268); goto KHZWF; oEFxI: if (Request::isPost()) { goto fiO2J; zUNr_: return Response::send(0, null, null, $UYUrz); goto J8jUk; fiO2J: $BEdDh = $this->api->loginPhone(); goto A2IEw; P94Sy: if ($a78Dc) { return Response::send(0, '', '', '[js]parent.location.href=' . json_encode($UYUrz) . ';'); } goto zUNr_; A2IEw: if ($BEdDh['code']) { return Response::send(-1, $BEdDh['msg']); } goto P94Sy; J8jUk: } goto p4d4p; RYzW3: $this->api->checkRedirectSafety($UYUrz); goto oEFxI; kRP9B: $Jc268 = array('redirect' => $UYUrz); goto uos2V; bCtzu: if ($a78Dc) { $Mi0Iq = 'loginPhoneDialog'; } goto uLM_z; KHZWF: } public function loginPhoneCaptcha() { return $this->api->loginPhoneCaptchaRaw(); } public function loginPhoneVerify() { return Response::sendFromGenerate($this->api->loginPhoneVerify()); } public function logout() { goto tl1_7; hq_aP: if ($BEdDh['code']) { return Response::send(-1, $BEdDh['msg']); } goto zbeUZ; zbeUZ: $bz1sB = InputPackage::buildFromInput(); goto Ft7ne; eneQm: if (modstart_config('ssoClientEnable', false) && modstart_config('ssoClientLogoutSyncEnable', false)) { goto s2Mwr; gxnK8: return Response::send(0, null, null, $BEdDh['data']['redirect']); goto V91nh; X2T7h: $BEdDh = $this->api->ssoClientLogoutPrepare(); goto PVZkw; kaTmy: Session::put('ssoLogoutRedirect', $UYUrz); goto gxnK8; s2Mwr: Input::merge(array('domainUrl' => Request::domainUrl())); goto X2T7h; PVZkw: if ($BEdDh['code']) { return Response::send(-1, $BEdDh['msg']); } goto kaTmy; V91nh: } goto kFSGS; EpD1F: return Response::redirect($UYUrz); goto fviw2; REmew: $UYUrz = $bz1sB->getTrimString('redirect', modstart_web_url('')); goto EpD1F; Ft7ne: Session::forget('memberUserId'); goto REmew; lDCdc: $UYUrz = $bz1sB->getTrimString('redirect', modstart_web_url('')); goto Hdh2O; tl1_7: $bz1sB = InputPackage::buildFromInput(); goto lDCdc; Hdh2O: $this->api->checkRedirectSafety($UYUrz); goto eneQm; kFSGS: $BEdDh = $this->api->logout(); goto hq_aP; fviw2: } public function register() { goto AWmJs; VQdZC: if ($a78Dc) { $Mi0Iq = 'registerDialog'; } goto c3XQP; sL3NH: $a78Dc = $bz1sB->getInteger('dialog'); goto eYWVS; oZ3lx: if ($a78Dc) { $Jc268['dialog'] = $a78Dc; } goto a99LU; a99LU: if (Request::isPost()) { goto M2gbu; xfpaD: return Response::send(0, '', '', $OuCnz); goto frQ44; M2gbu: $BEdDh = $this->api->register(); goto NKHJH; NKHJH: if ($BEdDh['code']) { if ($bz1sB->getTrimString('captcha')) { return Response::send(-1, $BEdDh['msg'], null, '[js]$("[data-captcha]").click()'); } return Response::send(-1, $BEdDh['msg']); } goto l8Mnx; l8Mnx: $OuCnz = modstart_web_url('login', $Jc268); goto xfpaD; frQ44: } goto IIvJU; RaCcT: $Jc268 = array('redirect' => $UYUrz); goto oZ3lx; ipFql: $Mi0Iq = 'register'; goto VQdZC; c3XQP: return $this->view($Mi0Iq, $Jc268); goto y7wPe; IIvJU: if (modstart_config('Member_RegisterPhoneEnable', false)) { $QUOgg = modstart_config('Member_RegisterDefault', 'default'); if ('phone' == $QUOgg) { $XgKhb = $bz1sB->getBoolean('force', false); if (!$XgKhb) { return Response::redirect(modstart_web_url('register/phone', $Jc268)); } } } goto ipFql; eYWVS: $UYUrz = $bz1sB->getTrimString('redirect', modstart_web_url('member')); goto RaCcT; AWmJs: $bz1sB = InputPackage::buildFromInput(); goto sL3NH; y7wPe: } public function registerPhone() { goto NjqZo; rm_eF: $this->api->checkRedirectSafety($UYUrz); goto K8BTn; Fy8oe: $a78Dc = $bz1sB->getInteger('dialog'); goto yWYEV; I04cO: if ($a78Dc) { $Mi0Iq = 'registerPhoneDialog'; } goto W993w; xlt5t: $Mi0Iq = 'registerPhone'; goto I04cO; LApX9: $Jc268 = array('redirect' => $UYUrz); goto R0SwK; K8BTn: if (Request::isPost()) { goto zLdwK; zLdwK: $BEdDh = $this->api->registerPhone(); goto QuLDH; QuLDH: if ($BEdDh['code']) { return Response::send(-1, $BEdDh['msg']); } goto ViNss; ViNss: return Response::send(0, null, null, $UYUrz); goto UulLc; UulLc: } goto xlt5t; W993w: return $this->view($Mi0Iq, $Jc268); goto Y4VVC; yWYEV: $UYUrz = $bz1sB->getTrimString('redirect', modstart_web_url('member')); goto LApX9; R0SwK: if ($a78Dc) { $Jc268['dialog'] = $a78Dc; } goto rm_eF; NjqZo: $bz1sB = InputPackage::buildFromInput(); goto Fy8oe; Y4VVC: } public function registerEmailVerify() { return Response::sendFromGenerate($this->api->registerEmailVerify()); } public function registerPhoneVerify() { return Response::sendFromGenerate($this->api->registerPhoneVerify()); } public function registerCaptcha() { return $this->api->registerCaptchaRaw(); } public function registerCaptchaVerify() { goto mu8Ps; lWIU9: return Response::send(0, $BEdDh['msg']); goto PoDj9; aNbyq: if ($BEdDh['code']) { return Response::send(-1, $BEdDh['msg'], null, '[js]$("[data-captcha]").click()'); } goto lWIU9; mu8Ps: $BEdDh = $this->api->registerCaptchaVerify(); goto aNbyq; PoDj9: } public function retrieve() { goto sD659; YBoaj: $UYUrz = $bz1sB->getTrimString('redirect', modstart_web_url('member')); goto HtTlp; sD659: $bz1sB = InputPackage::buildFromInput(); goto YBoaj; HtTlp: return $this->view('retrieve', array('redirect' => $UYUrz)); goto F3tc1; F3tc1: } public function retrievePhone() { goto x91h5; VllhU: return $this->view('retrievePhone', array('redirect' => $UYUrz)); goto U7WTE; Qo_x5: $UYUrz = $bz1sB->getTrimString('redirect', modstart_web_url('member')); goto V0o9p; V0o9p: if (Request::isPost()) { goto Q6CKH; WcN6G: return Response::send(0, $BEdDh['msg'], null, modstart_web_url('retrieve') . '/reset?redirect=' . urlencode($UYUrz)); goto zfL4F; Q6CKH: $BEdDh = $this->api->retrievePhone(); goto zDEtU; zDEtU: if ($BEdDh['code']) { return Response::send(-1, $BEdDh['msg']); } goto WcN6G; zfL4F: } goto VllhU; x91h5: $bz1sB = InputPackage::buildFromInput(); goto Qo_x5; U7WTE: } public function retrievePhoneVerify() { return Response::sendFromGenerate($this->api->retrievePhoneVerify()); } public function retrieveEmail() { goto Wm5ya; Ihmwl: if (Request::isPost()) { goto Z83p8; Z83p8: $BEdDh = $this->api->retrieveEmail(); goto akvEv; akvEv: if ($BEdDh['code']) { return Response::send(-1, $BEdDh['msg']); } goto NrpGs; NrpGs: return Response::send(0, $BEdDh['msg'], null, modstart_web_url('retrieve') . '/reset?redirect=' . urlencode($UYUrz)); goto uesR4; uesR4: } goto XUbQu; RPVdO: $UYUrz = $bz1sB->getTrimString('redirect', modstart_web_url('member')); goto Ihmwl; XUbQu: return $this->view('retrieveEmail', array('redirect' => $UYUrz)); goto cXg0c; Wm5ya: $bz1sB = InputPackage::buildFromInput(); goto RPVdO; cXg0c: } public function retrieveEmailVerify() { return Response::sendFromGenerate($this->api->retrieveEmailVerify()); } public function retrieveCaptcha() { return $this->api->retrieveCaptchaRaw(); } public function retrieveReset() { goto J8Sup; R38IN: if ($BEdDh['code']) { return Response::send(-1, $BEdDh['msg']); } goto mVRFn; J8Sup: $bz1sB = InputPackage::buildFromInput(); goto cnBfQ; mVRFn: return $this->view('retrieveReset', array('redirect' => $UYUrz, 'memberUser' => $BEdDh['data']['memberUser'])); goto rmU87; SYwOD: if (Request::isPost()) { goto SaXaW; bkgsX: if ($BEdDh['code']) { return Response::send(-1, $BEdDh['msg']); } goto WE9iB; SaXaW: $BEdDh = $this->api->retrieveReset(); goto bkgsX; WE9iB: return Response::send(0, $BEdDh['msg'], null, $UYUrz); goto MqMj2; MqMj2: } goto IUxUr; cnBfQ: $UYUrz = $bz1sB->getTrimString('redirect', modstart_web_url('member')); goto SYwOD; IUxUr: $BEdDh = $this->api->retrieveResetInfo(); goto R38IN; rmU87: } public function oauthLogin($Mm7Ly = null) { goto MDUYe; sjvFT: Session::put('oauthRedirect', $UYUrz); goto yaOY1; lgym1: if ($BEdDh['code']) { return Response::send(-1, $BEdDh['msg']); } goto sjvFT; MDUYe: $bz1sB = InputPackage::buildFromInput(); goto evU4Z; m8PNm: $UYUrz = $bz1sB->getTrimString('redirect', modstart_web_url('member')); goto SYVg7; yaOY1: return Response::redirect($BEdDh['data']['redirect']); goto tCRnx; evU4Z: $Mi0Iq = $bz1sB->getBoolean('view', false); goto bDnGS; slrlk: $BEdDh = $this->api->oauthLogin($Mm7Ly, $YHayk); goto lgym1; bDnGS: if ($Mi0Iq) { Session::put('oauthLoginView', true); } goto m8PNm; oJl6b: $YHayk = Request::domainUrl() . '/oauth_callback_' . $Mm7Ly; goto slrlk; SYVg7: $this->api->checkRedirectSafety($UYUrz); goto oJl6b; tCRnx: } public function oauthCallback($Mm7Ly = null) { goto UDmw9; u7uu_: if ($Mi0Iq) { goto GC6cc; CxDPT: Session::put('oauthViewOpenId_' . $Mm7Ly, $ZOoxE['openid']); goto Ssba4; GC6cc: $UYUrz = Session::get('oauthRedirect', modstart_web_url('member')); goto wyrlN; wyrlN: $ZOoxE = Session::get('oauthUserInfo'); goto CxDPT; Ssba4: return Response::redirect($UYUrz); goto Q1lHo; Q1lHo: } goto vlpTx; snSbZ: if ($BEdDh['code']) { return Response::sendFromGenerate($BEdDh); } goto wYO73; qG5Lq: Session::forget('oauthLoginView'); goto u7uu_; vlpTx: return Response::redirect(Request::domainUrl() . '/oauth_bind_' . $Mm7Ly); goto HoL42; wYO73: $Mi0Iq = Session::get('oauthLoginView', false); goto qG5Lq; pj2Hn: $BEdDh = $this->api->oauthCallback($Mm7Ly, $YHayk); goto snSbZ; UDmw9: $YHayk = Request::domainUrl() . '/oauth_callback_' . $Mm7Ly; goto pj2Hn; HoL42: } public function oauthBind($Mm7Ly = null) { goto Zrolp; XCvxr: if (MemberUser::isLogin()) { goto v9SXw; JSpDP: Session::forget('oauthRedirect'); goto Kw081; bJkFm: if ($BEdDh['code']) { return Response::send(-1, $BEdDh['msg']); } goto JSpDP; Kw081: return Response::send(0, '绑定成功', null, $UYUrz); goto sNvLV; v9SXw: $BEdDh = $this->api->oauthBind($Mm7Ly); goto bJkFm; sNvLV: } goto aoMoy; w5ylN: $this->api->checkRedirectSafety($UYUrz); goto k_jK3; gOh66: $ZOoxE = Session::get('oauthUserInfo', array()); goto W_Y5v; aoMoy: return $this->view('oauthBind', array('oauthUserInfo' => $ZOoxE, 'redirect' => $UYUrz)); goto QNXs8; eaFae: if ($BEdDh['data']['memberUserId'] > 0) { Session::forget('oauthRedirect'); return Response::redirect($UYUrz); } goto XCvxr; W_Y5v: $BEdDh = $this->api->oauthTryLogin($Mm7Ly); goto EzhmP; k_jK3: if (Request::isPost()) { goto qGdwe; LJRFS: $BEdDh = $this->api->oauthBind($Mm7Ly); goto tsLjz; qGdwe: $bz1sB = InputPackage::buildFromInput(); goto LJRFS; naKm7: Session::forget('oauthRedirect'); goto I3uO3; tsLjz: if ($BEdDh['code']) { if ($bz1sB->getTrimString('captcha')) { return Response::send(-1, $BEdDh['msg'], null, '[js]$("[data-captcha]").click()'); } return Response::send(-1, $BEdDh['msg']); } goto naKm7; I3uO3: return Response::send(0, $BEdDh['msg'], null, $UYUrz); goto vezzh; vezzh: } goto gOh66; Zrolp: $UYUrz = Session::get('oauthRedirect', modstart_web_url('member')); goto w5ylN; EzhmP: if ($BEdDh['code']) { return Response::send(-1, $BEdDh['msg']); } goto eaFae; QNXs8: } public function oauthBindCaptcha() { return $this->api->oauthBindCaptchaRaw(); } public function oauthBindCaptchaVerify() { goto MkSRN; s__qf: if ($BEdDh['code']) { return Response::send(-1, $BEdDh['msg'], null, '[js]$("[data-captcha]").click()'); } goto yKRVe; yKRVe: return Response::send(0, $BEdDh['msg']); goto Us6FZ; MkSRN: $BEdDh = $this->api->oauthBindCaptchaVerify(); goto s__qf; Us6FZ: } public function oauthBindEmailVerify() { return Response::sendFromGenerate($this->api->oauthBindEmailVerify()); } public function oauthBindPhoneVerify() { return Response::sendFromGenerate($this->api->oauthBindPhoneVerify()); } public function oauthProxy() { return $this->view('oauthProxy'); } public function ssoClient() { goto IcKfm; IcKfm: $BEdDh = $this->api->ssoClient(); goto Vym08; Vym08: if ($BEdDh['code']) { return Response::send(-1, $BEdDh['msg']); } goto w6KqL; lichr: return Response::send(0, null, null, $UYUrz); goto tIOQn; w6KqL: $UYUrz = Session::get('ssoClientRedirect', modstart_web_url('member')); goto lichr; tIOQn: } public function ssoServer() { goto zDbw7; zDbw7: $bz1sB = InputPackage::buildFromInput(); goto mWsSk; PiIr3: $psAM3 = '/sso/server_success?' . http_build_query(array('client' => $bz1sB->getTrimString('client'), 'domainUrl' => Request::domainUrl())); goto OoMDJ; HM0CL: if ($BEdDh['code']) { return Response::send(-1, $BEdDh['msg']); } goto PiIr3; OoMDJ: if ($BEdDh['data']['isLogin']) { return Response::send(0, null, null, $psAM3); } goto DZx_U; mWsSk: $BEdDh = $this->api->ssoServer(); goto HM0CL; DZx_U: return Response::send(0, null, null, modstart_web_url('login') . '?' . http_build_query(array('redirect' => $psAM3))); goto bR4V2; bR4V2: } public function ssoServerSuccess() { goto t6PvC; hrOGt: if ($BEdDh['code']) { return Response::send(-1, $BEdDh['msg']); } goto WroFH; t6PvC: $BEdDh = $this->api->ssoServerSuccess(); goto hrOGt; WroFH: return Response::send(0, null, null, $BEdDh['data']['redirect']); goto cfU3X; cfU3X: } public function ssoServerLogout() { goto MlY_2; KElCp: if ($BEdDh['code']) { return Response::send(-1, $BEdDh['msg']); } goto y8db9; MlY_2: $bz1sB = InputPackage::buildFromInput(); goto yl7kR; yl7kR: $BEdDh = $this->api->ssoServerLogout(); goto KElCp; B3JVk: return Response::send(0, null, null, $UYUrz); goto qA5BJ; y8db9: $UYUrz = $bz1sB->getTrimString('redirect', modstart_web_url('')); goto B3JVk; qA5BJ: } public function ssoClientLogout() { goto WREdL; dqL9f: $UYUrz = Session::get('ssoLogoutRedirect', modstart_web_url('')); goto khrZl; WREdL: $BEdDh = $this->api->ssoClientLogout(); goto WOJcB; WOJcB: if ($BEdDh['code']) { return Response::send(-1, $BEdDh['msg']); } goto dqL9f; khrZl: return Response::send(0, null, null, $UYUrz); goto Nn_12; Nn_12: } }