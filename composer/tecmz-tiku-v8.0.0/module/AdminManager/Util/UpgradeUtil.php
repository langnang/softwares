<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\AdminManager\Util; use App\Constant\AppConstant; use Chumper\Zipper\Zipper; use Illuminate\Support\Facades\Artisan; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Response; use ModStart\Core\Util\CurlUtil; use ModStart\Core\Util\FileUtil; use ModStart\ModStart; class UpgradeUtil { const REMOTE_BASE = 'https://modstart.com'; private static function baseRequest($lYtoi, $GeXSC = array(), $HUlap = null) { return CurlUtil::postJSONBody(self::REMOTE_BASE . $lYtoi, $GeXSC, array('header' => array('api-token' => $HUlap, 'X-Requested-With' => 'XMLHttpRequest'))); } public static function latest() { goto qnxSC; qnxSC: $BEdDh = self::baseRequest('/api/app/latest', array('app' => AppConstant::APP, 'version' => AppConstant::VERSION)); goto BTiHI; BTiHI: BizException::throwsIfResponseError($BEdDh); goto xZhBq; xZhBq: return $BEdDh['data']; goto SbJU8; SbJU8: } public static function downloadPackage($HUlap, $rwsHh, $FUMHt, $bssXV) { goto iTqy4; iTqy4: $BEdDh = self::baseRequest('/api/app/download_package', array('app' => $rwsHh, 'fromVersion' => $FUMHt, 'toVersion' => $bssXV), $HUlap); goto RfqPQ; UxVxj: BizException::throwsIfEmpty('安装包获取失败', $GeXSC); goto zGxRb; nHEBx: file_put_contents($Qob5Q, $HKlGd); goto obDGU; ISze9: $GeXSC = CurlUtil::getRaw($ZD7Jf); goto UxVxj; EJRbC: $Qob5Q = FileUtil::generateLocalTempPath('json'); goto nHEBx; a0iub: BizException::throwsIf('文件MD5校验失败', md5_file($xZIda) != $JiJ0N); goto EJRbC; lUh11: $JiJ0N = $BEdDh['data']['packageMd5']; goto iR1Bn; RfqPQ: BizException::throwsIfResponseError($BEdDh); goto tAOWo; tAOWo: $ZD7Jf = $BEdDh['data']['package']; goto lUh11; obDGU: return Response::generateSuccessData(array('diffContentFile' => $Qob5Q, 'package' => $xZIda, 'packageSize' => filesize($xZIda))); goto s4WKc; r_aT0: file_put_contents($xZIda, $GeXSC); goto a0iub; zGxRb: $xZIda = FileUtil::generateLocalTempPath('zip'); goto r_aT0; iR1Bn: $HKlGd = $BEdDh['data']['diffContent']; goto ISze9; s4WKc: } public static function upgradePackage($ZD7Jf, $Qob5Q) { goto IGo2J; OTaJI: BizException::throwsIf('调用 php artisan migrate 失败', 0 != $knCM0); goto Y67RF; f5DdB: BizException::throwsIf('调用 php artisan modstart:module-install-all 失败', 0 != $knCM0); goto Lx1pp; aNVB9: $h6nbW = new Zipper(); goto tTB1O; zotuo: FileUtil::safeCleanLocalTemp($Qob5Q); goto ng0xW; Wq_3f: $eeenH = array(); goto UmYPX; suCha: try { $knCM0 = Artisan::call('migrate'); } catch (\Exception $knlzD) { $knCM0 = -1; } goto OTaJI; xmYgy: ModStart::clearCache(); goto suCha; ng0xW: return Response::generateSuccessData(array('logs' => $gn4HX)); goto I2xbr; H_nUW: if (!empty($HKlGd['update'])) { goto s402W; LwBiG: $gn4HX[] = ''; goto N4Zty; s402W: $gn4HX[] = '修改文件：'; goto JfDBQ; JfDBQ: foreach ($HKlGd['update'] as $dc3Q5) { goto LwyQn; OhdpV: $gn4HX[] = "> {$dc3Q5}"; goto tooqk; LwyQn: $KqFED = $h6nbW->getFileContent($dc3Q5); goto smA7C; smA7C: FileUtil::write(base_path($dc3Q5), $KqFED); goto OhdpV; tooqk: } goto LwBiG; N4Zty: } goto GWADl; VGnJK: if (!empty($HKlGd['update'])) { $eeenH = array_merge($eeenH, $HKlGd['update']); } goto nqLFL; tTB1O: $h6nbW->make($ZD7Jf); goto jDXUB; Lx1pp: FileUtil::safeCleanLocalTemp($ZD7Jf); goto zotuo; nqLFL: $BEdDh = FileUtil::filePathWritableCheck($eeenH); goto pZn6i; IGo2J: BizException::throwsIf('package不存在', !file_exists($ZD7Jf)); goto QX2KE; yQ6Wc: $h6nbW->close(); goto xmYgy; UmYPX: if (!empty($HKlGd['add'])) { $eeenH = array_merge($eeenH, $HKlGd['add']); } goto VGnJK; QX2KE: BizException::throwsIf('diffContentFile不存在', !file_exists($Qob5Q)); goto KaSiZ; KaSiZ: $HKlGd = @json_decode(file_get_contents($Qob5Q), true); goto uXqQE; uXqQE: BizException::throwsIf('diffContent为空', empty($HKlGd)); goto Wq_3f; GWADl: if (!empty($HKlGd['delete'])) { goto OWHPr; qS359: foreach ($HKlGd['delete'] as $dc3Q5) { if (file_exists($Elm_b = base_path($dc3Q5))) { @unlink($Elm_b); $gn4HX[] = "> {$dc3Q5}"; } } goto FTOWM; FTOWM: $gn4HX[] = ''; goto RgKfD; OWHPr: $gn4HX[] = '删除文件：'; goto qS359; RgKfD: } goto yQ6Wc; jDXUB: $gn4HX = array(); goto QdVdj; Y67RF: $knCM0 = Artisan::call('modstart:module-install-all'); goto f5DdB; pZn6i: BizException::throwsIfResponseError($BEdDh); goto aNVB9; QdVdj: if (!empty($HKlGd['add'])) { goto IXtqv; rTj8m: foreach ($HKlGd['add'] as $dc3Q5) { goto dIMz5; dIMz5: $KqFED = $h6nbW->getFileContent($dc3Q5); goto wcOpF; wcOpF: FileUtil::write(base_path($dc3Q5), $KqFED); goto pS2Fs; pS2Fs: $gn4HX[] = "> {$dc3Q5}"; goto N0_0s; N0_0s: } goto ec1ez; IXtqv: $gn4HX[] = '新增文件：'; goto rTj8m; ec1ez: $gn4HX[] = ''; goto pah_R; pah_R: } goto H_nUW; I2xbr: } }