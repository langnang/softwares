<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Payment\Common\Cmb; use GuzzleHttp\Client; use Payment\Common\BaseData; use Payment\Common\BaseStrategy; use Payment\Common\CmbConfig; use Payment\Common\PayException; use Payment\Config; abstract class CmbBaseStrategy implements BaseStrategy { protected $config; protected $reqData; public function __construct(array $qc0K6) { try { $this->config = new CmbConfig($qc0K6); } catch (PayException $knlzD) { throw $knlzD; } } public function handle(array $GeXSC) { goto zshkB; W3vyP: $this->reqData->setSign(); goto V0F8i; zshkB: $FjIu5 = $this->getBuildDataClass(); goto n07zD; V0F8i: $GeXSC = $this->reqData->getData(); goto Aua1R; n07zD: try { $this->reqData = new $FjIu5($this->config, $GeXSC); } catch (PayException $knlzD) { throw $knlzD; } goto W3vyP; Aua1R: return $this->retData($GeXSC); goto GxzL5; GxzL5: } protected function retData(array $BEdDh) { goto U576V; b1pNH: return $sx3MN; goto IjWFo; U576V: $hBfCc = json_encode($BEdDh, JSON_UNESCAPED_UNICODE); goto Bo3S8; Bo3S8: $sx3MN = array('url' => $this->config->getewayUrl, 'name' => CmbConfig::REQ_FILED_NAME, 'value' => $hBfCc); goto b1pNH; IjWFo: } protected function sendReq($hBfCc) { goto a0W6F; JXEdX: $R2bnh = $GeXSC['rspData']; goto GBrmw; i2Wov: if ($tYsZE->getStatusCode() != '200') { throw new PayException('网络发生错误，请稍后再试curl返回码：' . $tYsZE->getReasonPhrase()); } goto FLHX5; FLHX5: $VhHmv = $tYsZE->getBody()->getContents(); goto kj7mq; WdMok: return $R2bnh; goto oh1Q5; kj7mq: $GeXSC = json_decode($VhHmv, true); goto FzCpN; a0W6F: $QkJ1i = new Client(array('timeout' => '10.0')); goto Z2QSZ; GnvPi: $tYsZE = $QkJ1i->request('POST', $this->config->getewayUrl, $m7iz2); goto i2Wov; Z2QSZ: $m7iz2 = array('headers' => array('content-type' => 'multipart/form-data'), 'body' => $hBfCc, 'http_errors' => false); goto GnvPi; L9sgl: if (!$gSChU) { throw new PayException('微信返回数据被篡改。请检查网络是否安全！'); } goto JXEdX; FzCpN: $gSChU = $this->verifySign($GeXSC); goto L9sgl; GBrmw: if ($R2bnh['rspCode'] !== CmbConfig::SUCC_TAG) { throw new PayException('招商返回错误提示：' . $R2bnh['rspMsg']); } goto WdMok; oh1Q5: } protected function getTradeStatus($M0y01) { switch ($M0y01) { case '0': return Config::TRADE_STATUS_SUCC; case '1': case '2': case '4': case '7': case '8': default: return Config::TRADE_STATUS_FAILD; } } protected function verifySign(array $eypYa) { return true; } }