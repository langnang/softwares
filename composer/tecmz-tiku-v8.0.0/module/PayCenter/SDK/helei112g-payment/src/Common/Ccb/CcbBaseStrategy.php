<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Payment\Common\Cmb; use GuzzleHttp\Client; use Payment\Common\BaseData; use Payment\Common\BaseStrategy; use Payment\Common\CmbConfig; use Payment\Common\PayException; use Payment\Config; abstract class CcbBaseStrategy implements BaseStrategy { protected $config; protected $reqData; public function __construct(array $qc0K6) { try { $this->config = new CcbConfig($qc0K6); } catch (PayException $knlzD) { throw $knlzD; } } public function handle(array $GeXSC) { goto cVEQ8; y5nIn: try { $this->reqData = new $FjIu5($this->config, $GeXSC); } catch (PayException $knlzD) { throw $knlzD; } goto wigXC; cVEQ8: $FjIu5 = $this->getBuildDataClass(); goto y5nIn; fFNQR: $GeXSC = $this->reqData->getData(); goto cyqXL; wigXC: $this->reqData->setSign(); goto fFNQR; cyqXL: return $this->retData($GeXSC); goto bW0at; bW0at: } protected function retData(array $BEdDh) { goto ZsEiZ; hc2H_: return $sx3MN; goto vQdz0; t7aMT: $sx3MN = array('url' => $this->config->getewayUrl, 'name' => CcbConfig::REQ_FILED_NAME, 'value' => $hBfCc); goto hc2H_; ZsEiZ: $hBfCc = json_encode($BEdDh, JSON_UNESCAPED_UNICODE); goto t7aMT; vQdz0: } protected function sendReq($hBfCc) { goto vcILf; OhjtH: $gSChU = $this->verifySign($GeXSC); goto TJUAp; wQ9OQ: $tYsZE = $QkJ1i->request('POST', $this->config->getewayUrl, $m7iz2); goto CZwzl; H1tRn: $GeXSC = json_decode($VhHmv, true); goto OhjtH; vcILf: $QkJ1i = new Client(array('timeout' => '10.0')); goto WcvmQ; VUaEX: return $R2bnh; goto jgG1K; CZwzl: if ($tYsZE->getStatusCode() != '200') { throw new PayException('网络发生错误，请稍后再试curl返回码：' . $tYsZE->getReasonPhrase()); } goto forxW; forxW: $VhHmv = $tYsZE->getBody()->getContents(); goto H1tRn; WcvmQ: $m7iz2 = array('body' => $hBfCc, 'http_errors' => false); goto wQ9OQ; iBLSY: if ($R2bnh['rspCode'] !== CmbConfig::SUCC_TAG) { throw new PayException('招商返回错误提示：' . $R2bnh['rspMsg']); } goto VUaEX; TJUAp: if (!$gSChU) { throw new PayException('微信返回数据被篡改。请检查网络是否安全！'); } goto a7Xjv; a7Xjv: $R2bnh = $GeXSC['rspData']; goto iBLSY; jgG1K: } protected function getTradeStatus($M0y01) { switch ($M0y01) { case '0': return Config::TRADE_STATUS_SUCC; case '1': case '2': case '4': case '7': case '8': default: return Config::TRADE_STATUS_FAILD; } } protected function verifySign(array $eypYa) { return true; } }