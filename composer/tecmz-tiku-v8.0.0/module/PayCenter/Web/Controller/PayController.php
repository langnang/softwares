<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\PayCenter\Web\Controller; use Illuminate\Support\Facades\Session; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Module\ModuleBaseController; use Module\PayCenter\Type\PayOrderStatus; use Module\PayCenter\Util\PayOrderUtil; class PayController extends ModuleBaseController { private $api; public function __construct() { $this->api = app(\Module\PayCenter\Api\Controller\PayController::class); } public function index() { goto nZJ9E; nZJ9E: $ISUiy = Response::tryGetData($this->api->info()); goto z9bUj; iQReP: return $this->view('pay.index', array('order' => $IfVKl, 'autoClickPayType' => $JIZXX)); goto gypmc; liHpO: if ($DO0wP >= 0 && $DO0wP <= 0) { goto PZoti; PZoti: $BEdDh = PayOrderUtil::autoPay($IfVKl['biz'], $IfVKl['bizId'], 0); goto sDATr; sDATr: BizException::throwsIfResponseError($BEdDh); goto XiUp8; alF5f: return Response::send(0, '订单金额为0.00，自动支付成功', null, $UYUrz); goto vnC1h; XiUp8: $UYUrz = empty($BEdDh['data']['order']['redirect']) ? modstart_web_url('') : $BEdDh['data']['order']['redirect']; goto alF5f; vnC1h: } goto yPO0k; z9bUj: $IfVKl = $ISUiy['order']; goto P7BIB; ygCMJ: Session::forget('autoClickPayType'); goto iQReP; CNYqb: $DO0wP = floatval($ISUiy['order']['feeTotal']); goto liHpO; yPO0k: $JIZXX = Session::get('autoClickPayType', null); goto ygCMJ; P7BIB: if (Request::isPost()) { return Response::jsonFromGenerate($this->api->submit($IfVKl, $ISUiy['orderSecretId'])); } goto CNYqb; gypmc: } public function watch() { goto bKxEP; bKxEP: $ISUiy = Response::tryGetData($this->api->info()); goto wiL2d; wiL2d: $IfVKl = $ISUiy['order']; goto H0Jd4; H0Jd4: switch ($IfVKl['status']) { case PayOrderStatus::NEW_ORDER: case PayOrderStatus::CREATED: return Response::generate(0, null, array('status' => 'new')); case PayOrderStatus::PAYED: return Response::generate(0, null, array('status' => 'payed')); case PayOrderStatus::CLOSED: return Response::generate(0, null, array('status' => 'expired')); default: return Response::generate(-1, 'order status error'); } goto pWkih; pWkih: } }