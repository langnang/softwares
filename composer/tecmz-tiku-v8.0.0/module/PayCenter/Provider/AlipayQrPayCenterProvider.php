<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\PayCenter\Provider; use Carbon\Carbon; use Illuminate\Support\Facades\View; use Illuminate\Support\Str; use ModStart\Admin\Layout\AdminConfigBuilder; use ModStart\Core\Input\Response; use ModStart\Module\ModuleClassLoader; use Module\PayCenter\Type\PayOrderStatus; use Module\PayCenter\Util\AlipayUtil; use Module\PayCenter\Util\PayOrderUtil; use Payment\Client\Charge; use Payment\Client\Notify; use Payment\Config; class AlipayQrPayCenterProvider extends AbstractPayCenterProvider { const NAME = 'alipay_qr'; public function name() { return self::NAME; } public function title() { return '支付宝当面付'; } public function enable() { return boolval(modstart_config('payAlipayQrOn', false)); } public function init() { ModuleClassLoader::addNamespaceIfMissing('Payment', __DIR__ . '/../SDK/helei112g-payment/src'); } public function adminConfig(AdminConfigBuilder $cv5kq) { goto x9FNz; Yq6v_: $cv5kq->textarea('payAlipayQrRSAPrivateKey', '应用私钥RSA2(SHA256)')->help('复制 -----BEGIN RSA PRIVATE KEY----- 和 -----END RSA PRIVATE KEY----- 中间的部分'); goto NauR3; d2K8F: $cv5kq->formClass('wide'); goto K2NvC; x9FNz: $cv5kq->switch('payAlipayQrOn', '开启'); goto lMwoa; NauR3: $cv5kq->display('_empty_', '')->content('<span class="ub-text-danger">如果您还没开通支付宝收款，请 <a href="https://tecmz.com/article/payapply" target="_blank">联系我们</a> 协助申请</span>'); goto d2K8F; lMwoa: $cv5kq->text('payAlipayQrAppId', 'AppId')->help('如 '); goto FYJxX; FYJxX: $cv5kq->textarea('payAlipayQrAliPublicKey', '支付宝公钥')->help('如 '); goto Yq6v_; K2NvC: } private function config() { return array('use_sandbox' => false, 'app_id' => modstart_config()->getWithEnv('payAlipayQrAppId'), 'sign_type' => 'RSA2', 'ali_public_key' => modstart_config()->getWithEnv('payAlipayQrAliPublicKey'), 'rsa_private_key' => modstart_config()->getWithEnv('payAlipayQrRSAPrivateKey'), 'limit_pay' => array(), 'notify_url' => action('\\Module\\PayCenter\\Web\\Controller\\NotifyController@index', array('payType' => self::name())), 'return_url' => action('\\Module\\PayCenter\\Web\\Controller\\ReturnController@index', array('payType' => self::name())), 'return_raw' => true); } public function onSubmit($XdWpe, $l9M__, $InfBU = array()) { goto Tj2xA; ywavp: try { $kjWci = Charge::run(Config::ALI_CHANNEL_QR, $qc0K6, $iJW2y); } catch (\Exception $knlzD) { return Response::generate(-1, '创建支付错误(' . $knlzD->getMessage() . ')'); } goto aIAEw; g0fMs: $GeXSC = array(); goto Lbky_; Lbky_: $GeXSC['payCodeUrl'] = $kjWci; goto MHJ3d; lbbAQ: $iJW2y = array('subject' => Str::limit(AlipayUtil::filterSpecialChars($XdWpe['body']), 200), 'body' => Str::limit(AlipayUtil::filterSpecialChars($XdWpe['body']), 100), 'order_no' => config('pay.payOrderOutTradeNoPrefix') . '_' . $XdWpe['id'], 'timeout_express' => time() + 3600 * 24, 'amount' => $XdWpe['feeTotal'], 'return_param' => '', 'goods_type' => '0', 'store_id' => '', 'qr_mod' => ''); goto ywavp; MHJ3d: $GeXSC['successRedirect'] = $XdWpe['redirect']; goto uaOtw; aIAEw: PayOrderUtil::update($XdWpe['id'], array('status' => PayOrderStatus::CREATED, 'payType' => $l9M__, 'timePayCreated' => Carbon::now())); goto g0fMs; uaOtw: return Response::generate(0, 'ok', $GeXSC); goto FZhbO; Tj2xA: $qc0K6 = $this->config(); goto lbbAQ; FZhbO: } public function onNotify($l9M__, $bz1sB, $oG0tD = array()) { $qc0K6 = $this->config(); return Notify::run(Config::ALI_CHARGE, $qc0K6, new AlipayQrPayNotify()); } public function webRender($oG0tD) { return View::make('module::PayCenter.View.inc.alipayQr', $oG0tD)->render(); } }