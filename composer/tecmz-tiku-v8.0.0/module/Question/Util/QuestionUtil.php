<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Question\Util; use Illuminate\Support\Facades\DB; use ModStart\Core\Dao\ModelManageUtil; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Response; use ModStart\Core\Type\TypeUtil; use ModStart\Core\Util\ArrayUtil; use ModStart\Core\Util\HtmlUtil; use ModStart\Core\Util\TagUtil; use ModStart\Module\ModuleManager; use Module\Question\Type\QuestionStatus; use Module\Question\Type\QuestionType; use Module\Vendor\Provider\SiteUrl\SiteUrlProvider; class QuestionUtil { const QUESTION_CACHE_PREFIX = 'question:'; public static function paramEncode($oUKOQ, $vSByv, $S3IJB, $YFOa3, $TO6f4) { $oG0tD = array($oUKOQ, $vSByv, $S3IJB, $YFOa3, $TO6f4); return base64_encode(json_encode($oG0tD)); } public static function paramDecode($oG0tD) { goto YR37u; LEOC2: $WZC9G = array('catId' => isset($oG0tD[0]) ? $oG0tD[0] : null, 'chapterId' => isset($oG0tD[1]) ? $oG0tD[1] : null, 'type' => isset($oG0tD[2]) ? $oG0tD[2] : null, 'tagIds' => isset($oG0tD[3]) ? $oG0tD[3] : null, 'keywords' => isset($oG0tD[4]) ? $oG0tD[4] : null); goto tdL1_; tdL1_: return $WZC9G; goto V9qLj; YR37u: $oG0tD = @base64_decode($oG0tD); goto biUIn; biUIn: $oG0tD = @json_decode($oG0tD, true); goto LEOC2; V9qLj: } public static function text($hd5k9, $m7iz2 = array(), $pCem1 = array()) { goto tZzXu; DNcN6: foreach ($m7iz2 as $InfBU) { $qSGKk[] = HtmlUtil::text($InfBU['option']); } goto EkstK; EkstK: return join('
', $qSGKk); goto UfRYs; tZzXu: $qSGKk = array(); goto ncxNp; ncxNp: $qSGKk[] = HtmlUtil::text($hd5k9['question']); goto DNcN6; UfRYs: } public static function textLine($hd5k9) { return '[' . TypeUtil::name(QuestionType::class, $hd5k9['type']) . ']' . HtmlUtil::text($hd5k9['question']); } public static function isDuplicated($hd5k9, $m7iz2 = array(), $pCem1 = array()) { $pcfGC = self::text($hd5k9, $m7iz2); return ModelUtil::exists('question', array('questionText' => $pcfGC)); } public static function isEnable() { return modstart_config('moduleQuestionEnable', false) && !ModuleManager::getModuleConfigBoolean('Question', 'viewDisable', false); } public static function disabledResponse() { return Response::sendError('题目功能未开启'); } public static function isQuestionDeletableForAdmin($WuEXg, $M9BiD = 0) { goto m1Hoc; PVYjD: if (!$hd5k9) { return Response::generate(-1, "题目不存在(ID={$WuEXg})"); } goto JL00N; VCmzo: if (ModuleManager::isModuleInstalled('Paper')) { if (ModelUtil::exists('paper_exam_question', array('questionId' => $WuEXg))) { return Response::generate(-1, "题目已在考卷中不可删除(ID={$WuEXg})"); } if (ModelUtil::exists('paper_exam_question', array('questionId' => $WuEXg))) { return Response::generate(-1, "题目已被考试不可删除(ID={$WuEXg})"); } } goto ioO4k; m1Hoc: $hd5k9 = ModelUtil::get('question', $WuEXg); goto PVYjD; ioO4k: return true; goto DeOgv; JL00N: if ($M9BiD >= 0) { BizException::throwsIf('无操作权限', $hd5k9['adminUserId'] != $M9BiD); } goto VCmzo; DeOgv: } public static function isQuestionDeletable($WuEXg, $MqkYF = 0) { goto q6Ftq; XDyLx: return true; goto UCPW0; BZPo0: if ($MqkYF >= 0) { BizException::throwsIf('无操作权限', $hd5k9['memberUserId'] != $MqkYF); } goto PZUAP; q6Ftq: $hd5k9 = ModelUtil::get('question', $WuEXg); goto WeVBF; WeVBF: if (!$hd5k9) { return Response::generate(-1, "题目不存在(ID={$WuEXg})"); } goto BZPo0; PZUAP: if (ModuleManager::isModuleInstalled('Paper')) { if (ModelUtil::exists('paper_exam_question', array('questionId' => $WuEXg))) { return Response::generate(-1, "题目已在考卷中不可删除(ID={$WuEXg})"); } if (ModelUtil::exists('paper_exam_question', array('questionId' => $WuEXg))) { return Response::generate(-1, "题目已被考试不可删除(ID={$WuEXg})"); } } goto XDyLx; UCPW0: } public static function filterQuestionData($dqC_A) { goto AHSGp; adC2o: return array($dqC_A, $JoZVT); goto gBZG1; AHSGp: $JoZVT = $dqC_A; goto efsW1; pE06a: if (!empty($dqC_A['items'])) { $dqC_A['items'] = array_map(function ($REa1I) { if (!empty($REa1I['options'])) { $REa1I['options'] = ArrayUtil::keepItemsKeys($REa1I['options'], array('id', 'option', '_key')); } $REa1I['answer'] = null; $REa1I['analysis'] = null; return $REa1I; }, $dqC_A['items']); } goto gxh5T; gxh5T: if (!empty($dqC_A['options'])) { $dqC_A['options'] = ArrayUtil::keepItemsKeys($dqC_A['options'], array('id', 'option', '_key')); } goto VLL_8; efsW1: $dqC_A = ArrayUtil::keepKeys($dqC_A, array('question', 'options', 'items')); goto pE06a; VLL_8: $dqC_A['answer'] = null; goto B62ck; B62ck: $dqC_A['analysis'] = null; goto adC2o; gBZG1: } public static function deleteQuestion($WuEXg, $UzuaQ = true) { goto VsGj9; OB9zh: ModelUtil::delete('question_tag_map', array('questionId' => $WuEXg)); goto B3lk_; a83UW: $hd5k9 = ModelUtil::get('question', $WuEXg); goto lR5eS; H0xsL: ModelUtil::delete('question_analysis', array('questionId' => $WuEXg)); goto qVS40; lR5eS: ModelUtil::delete('question', array('id' => $WuEXg)); goto dogXN; VsGj9: if ($UzuaQ) { $cPIIQ = ModelUtil::all('question', array('parentId' => $WuEXg)); if (!empty($cPIIQ)) { foreach ($cPIIQ as $ZXH8V) { self::deleteQuestion($ZXH8V['parentId'], false); } } } goto a83UW; qVS40: ModelUtil::delete('question_answer', array('questionId' => $WuEXg)); goto Yg6NK; dogXN: ModelUtil::delete('question_option', array('questionId' => $WuEXg)); goto H0xsL; B3lk_: if ($hd5k9) { SiteUrlProvider::delete(modstart_web_url('question/view/' . $hd5k9['alias'])); } goto XGQr2; Yg6NK: if (modstart_module_enabled('QuestionEnhance')) { ModelUtil::delete('question_comment', array('questionId' => $WuEXg)); if (ModelManageUtil::hasTable('question_correct')) { ModelUtil::delete('question_correct', array('questionId' => $WuEXg)); } } goto OB9zh; XGQr2: } public static function buildQuestionMap($WuEXg, $YFOa3) { goto DMqcz; NBDmF: $GhxTq = array_map(function ($RgY2C) use($WuEXg) { return array('tagId' => $RgY2C, 'questionId' => $WuEXg); }, $YFOa3); goto DC2dj; DC2dj: ModelUtil::insertAll('question_tag_map', $GhxTq); goto IaWpl; DMqcz: ModelUtil::delete('question_tag_map', array('questionId' => $WuEXg)); goto NBDmF; IaWpl: } public static function get($wa91I) { return ModelUtil::get('question', $wa91I); } public static function getQuestion($wKi71) { return ModelUtil::get('question', array('alias' => $wKi71)); } public static function getQuestionData($WuEXg, $BO4Bm = null) { goto giTaJ; giTaJ: $GeXSC = array(); goto BqjpM; Y71Qu: return $GeXSC; goto ok4Vq; LhLUi: switch ($hd5k9['type']) { case QuestionType::SINGLE_CHOICE: case QuestionType::MULTI_CHOICES: case QuestionType::TRUE_FALSE: goto YYrZg; YYrZg: $GeXSC['options'] = ModelUtil::all('question_option', array('questionId' => $hd5k9['id']), array('*'), array('id', 'asc')); goto JAxCb; JAxCb: $GeXSC['options'] = array_build($GeXSC['options'], function ($nJFbs, $NIxlc) { $NIxlc['_key'] = chr(ord('A') + $nJFbs); return array($nJFbs, $NIxlc); }); goto ffEHX; ffEHX: break; goto cJcm2; cJcm2: case QuestionType::FILL: $GeXSC['answers'] = ModelUtil::all('question_answer', array('questionId' => $hd5k9['id']), array('*'), array('id', 'asc')); break; case QuestionType::TEXT: $GeXSC['answer'] = ModelUtil::get('question_answer', array('questionId' => $hd5k9['id'])); break; case QuestionType::GROUP: goto uxAdv; ZICUE: foreach ($hNwME as $WyIMU) { goto XIYr2; XIYr2: $REa1I = array(); goto k0okk; fJ645: $REa1I['itemCount'] = 1; goto OHR6C; OHR6C: $REa1I['question'] = $WyIMU; goto kaHNU; rE5MS: $GeXSC['items'][] = $REa1I; goto NnTRf; k0okk: $REa1I['itemNumber'] = $b7vh8; goto fJ645; kaHNU: switch ($WyIMU['type']) { case QuestionType::SINGLE_CHOICE: case QuestionType::MULTI_CHOICES: case QuestionType::TRUE_FALSE: goto JyUnQ; EPVhv: break; goto ym_Uo; JyUnQ: $REa1I['options'] = ModelUtil::all('question_option', array('questionId' => $WyIMU['id']), array('*'), array('id', 'asc')); goto JaGWs; JaGWs: $REa1I['options'] = array_build($REa1I['options'], function ($nJFbs, $NIxlc) { $NIxlc['_key'] = chr(ord('A') + $nJFbs); return array($nJFbs, $NIxlc); }); goto Ns2yk; Ns2yk: $b7vh8++; goto EPVhv; ym_Uo: case QuestionType::FILL: goto x43dY; DDZrp: $REa1I['itemCount'] = count($REa1I['answers']); goto rkbcq; x43dY: $REa1I['answers'] = ModelUtil::all('question_answer', array('questionId' => $WyIMU['id']), array('*'), array('id', 'asc')); goto DDZrp; zWO2p: break; goto oTxxv; rkbcq: $b7vh8 += $REa1I['itemCount']; goto zWO2p; oTxxv: case QuestionType::TEXT: goto iIPra; iIPra: $REa1I['answer'] = ModelUtil::get('question_answer', array('questionId' => $WyIMU['id'])); goto NCcBv; NCcBv: $b7vh8++; goto MdoSp; MdoSp: break; goto QEDIu; QEDIu: } goto rE5MS; NnTRf: } goto Y_XNv; Y_XNv: break; goto hZkV9; riWOf: $GeXSC['items'] = array(); goto MO4p_; uxAdv: $hNwME = ModelUtil::all('question', array('parentId' => $hd5k9['id']), array('*'), array('id', 'asc')); goto riWOf; MO4p_: $b7vh8 = 1; goto ZICUE; hZkV9: } goto Y71Qu; fto5W: $GeXSC['analysis'] = ModelUtil::get('question_analysis', array('questionId' => $hd5k9['id'])); goto LhLUi; fXElP: if (empty($hd5k9)) { return null; } goto piadw; piadw: $GeXSC['question'] = $hd5k9; goto fto5W; BqjpM: if (null === $BO4Bm) { $hd5k9 = ModelUtil::get('question', array('id' => $WuEXg)); } else { $hd5k9 = ModelUtil::get('question', array('alias' => $BO4Bm)); } goto fXElP; ok4Vq: } public static function questionClick($WuEXg) { ModelUtil::update('question', array('id' => $WuEXg), array('clickCount' => DB::raw('clickCount+1'))); } public static function paginateQuestionAll($gETpv, $Wo30p, $InfBU = array()) { goto HajfD; bkno7: return $BfEFC; goto vrgjp; Il9WI: $BfEFC = ModelUtil::paginate('question', $gETpv, $Wo30p, $InfBU); goto ilCeF; asyc5: foreach ($BfEFC['records'] as &$REa1I) { $REa1I['tag'] = TagUtil::string2Array($REa1I['tag']); $REa1I['tag'] = TagUtil::mapInfo($REa1I['tag'], $GjTvT); } goto bkno7; ilCeF: $GjTvT = QuestionTagUtil::getMap(); goto asyc5; HajfD: $InfBU['where']['parentId'] = 0; goto Il9WI; vrgjp: } public static function paginateQuestion($oUKOQ, $gETpv, $Wo30p, $InfBU = array()) { goto P13HF; WgwIN: $InfBU['where']['parentId'] = 0; goto vDh2L; XLk2c: foreach ($BfEFC['records'] as &$REa1I) { $REa1I['tag'] = TagUtil::string2Array($REa1I['tag']); $REa1I['tag'] = TagUtil::mapInfo($REa1I['tag'], $GjTvT); } goto BtIE_; BtIE_: return $BfEFC; goto i9bvk; vDh2L: $InfBU['where']['status'] = QuestionStatus::VERIFY_SUCCESS; goto LhxBh; GoXx9: $GjTvT = QuestionTagUtil::getMap(); goto XLk2c; P13HF: $InfBU['where']['catId'] = $oUKOQ; goto WgwIN; LhxBh: $BfEFC = ModelUtil::paginate('question', $gETpv, $Wo30p, $InfBU); goto GoXx9; i9bvk: } public static function listLatestQuestion($oUKOQ, $BpA16 = 10) { goto YqxaR; WEFN_: return $BfEFC['records']; goto kvI54; oYVZr: $InfBU['order'] = array('id', 'desc'); goto Byj5S; YqxaR: $InfBU = array(); goto oYVZr; Byj5S: $BfEFC = QuestionUtil::paginateQuestion($oUKOQ, 1, $BpA16, $InfBU); goto WEFN_; kvI54: } public static function listQuestions($Da1nS) { goto oO0Fk; acz15: foreach ($C0r1E as &$REa1I) { $REa1I['tag'] = TagUtil::string2Array($REa1I['tag']); $REa1I['tag'] = TagUtil::mapInfo($REa1I['tag'], $GjTvT); } goto GA_37; GA_37: return $C0r1E; goto QGLmL; XBS_k: $C0r1E = ModelUtil::allInWithOrder('question', 'id', $Da1nS); goto cXWnT; oO0Fk: if (empty($Da1nS)) { return array(); } goto XBS_k; cXWnT: $GjTvT = QuestionTagUtil::getMap(); goto acz15; QGLmL: } public static function listQuestionsSimple($Da1nS) { if (empty($Da1nS)) { return array(); } return ModelUtil::allInWithOrder('question', 'id', $Da1nS); } public static function increaseQuestionTestCount($WuEXg) { ModelUtil::model('question')->where(array('id' => $WuEXg))->increment('testCount'); } public static function increaseQuestionPassCount($WuEXg) { ModelUtil::model('question')->where(array('id' => $WuEXg))->increment('passCount'); } public static function hasContent($eZv6D) { $eZv6D = trim(HtmlUtil::text($eZv6D)); return !empty($eZv6D); } public static function parseAnswerInfo($dqC_A, $TRBWK) { goto Van3d; geGem: $yifft = null; goto EpLk2; EpLk2: switch ($dqC_A['question']['type']) { case QuestionType::SINGLE_CHOICE: case QuestionType::TRUE_FALSE: goto lMUFy; lMUFy: foreach ($dqC_A['options'] as $x1Lvn => $InfBU) { if ($InfBU['isAnswer']) { $yifft = chr(ord('A') + $x1Lvn); break; } } goto hDcJ1; hDcJ1: if (!empty($yifft)) { $y0LLK = true; if ($yifft == $TRBWK) { $YWcdv = true; } } goto V_QXS; V_QXS: break; goto J2CJd; J2CJd: case QuestionType::MULTI_CHOICES: goto f5931; H_sN9: break; goto DTCWi; hWvCW: foreach ($dqC_A['options'] as $x1Lvn => $InfBU) { if ($InfBU['isAnswer']) { $yifft[] = chr(ord('A') + $x1Lvn); } } goto AsG23; NCjF1: $yifft = array(); goto hWvCW; AsG23: if (json_encode($yifft) == json_encode($TRBWK)) { $YWcdv = true; } goto H_sN9; f5931: $y0LLK = true; goto NCjF1; DTCWi: case QuestionType::FILL: goto n2pwO; QRPmM: break; goto aXeuy; n2pwO: $yifft = array(); goto ynR8_; ynR8_: foreach ($dqC_A['answers'] as $REa1I) { $yifft[] = $REa1I['answer']; } goto QRPmM; aXeuy: case QuestionType::TEXT: $yifft = $dqC_A['answer']['answer']; break; } goto rTQ1u; rTQ1u: return array('judge' => $y0LLK, 'correct' => $YWcdv, 'answer' => $yifft); goto vazVQ; VWZTs: $YWcdv = false; goto geGem; Van3d: $y0LLK = false; goto VWZTs; vazVQ: } public static function mergeQuestionBasic(&$v39Ud) { ModelUtil::join($v39Ud, 'questionId', '_question', 'question'); foreach ($v39Ud as $nJFbs => $NZ_6d) { goto yLSJl; sOYvT: $v39Ud[$nJFbs]['_question'] = ArrayUtil::keepKeys($NZ_6d['_question'], array('alias', 'question', 'type')); goto VRhQ5; VRhQ5: $v39Ud[$nJFbs]['_question']['_title'] = HtmlUtil::text($hd5k9['question'], 100); goto fK0CH; yLSJl: $hd5k9 = $v39Ud[$nJFbs]['_question']; goto sOYvT; fK0CH: } } public static function filterExistsIds($Da1nS) { goto fZUBh; fZUBh: if (empty($Da1nS)) { return array(); } goto nwn_C; vT9os: return ArrayUtil::flatItemsByKey($NB8L2, 'id'); goto D4ASM; nwn_C: $NB8L2 = ModelUtil::allIn('question', 'id', $Da1nS, array('id')); goto vT9os; D4ASM: } }