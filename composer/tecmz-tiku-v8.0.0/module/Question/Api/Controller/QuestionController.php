<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Question\Api\Controller; use Illuminate\Routing\Controller; use Illuminate\Support\Facades\Session; use ModStart\Core\Dao\ModelManageUtil; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Core\Util\HtmlUtil; use ModStart\Core\Util\PageHtmlUtil; use ModStart\Core\Util\TagUtil; use Module\Member\Auth\MemberUser; use Module\Member\Auth\MemberVip; use Module\Member\Util\MemberVipUtil; use Module\Question\Model\Question; use Module\Question\Type\QuestionStatus; use Module\Question\Type\QuestionType; use Module\Question\Util\QuestionCatUtil; use Module\Question\Util\QuestionChapterUtil; use Module\Question\Util\QuestionMemberVipQuotaUtil; use Module\Question\Util\QuestionTagUtil; use Module\Question\Util\QuestionUtil; use Module\Question\Util\SuperSearchUtil; use Module\QuestionEnhance\Util\QuestionErrorsUtil; use Module\QuestionEnhance\Util\QuestionFavUtil; use Module\QuestionEnhance\Util\QuestionNoteUtil; use Module\Vendor\Provider\Ocr\OcrProvider; class QuestionController extends Controller { protected function tagGroupsToSql($FuT2O) { if (!empty($FuT2O)) { goto UF13G; tzZni: foreach ($FuT2O as $FPRpI => $YFOa3) { goto sQ8IF; MduOd: $h1hLN = join(',', $YFOa3); goto US2ht; zGJJa: $w6tFT++; goto MF92O; sQ8IF: if (empty($YFOa3)) { continue; } goto MduOd; US2ht: if (empty($LR9kk)) { $LR9kk = "\nSELECT questionId,tagId FROM {$XjZXS}\nWHERE questionId IN (\n    SELECT questionId FROM {$XjZXS}\n    WHERE tagId IN ({$h1hLN})\n    GROUP BY questionId\n)\n"; } else { $LR9kk = str_replace('
', '
    ', $LR9kk); $LR9kk = "\nSELECT questionId,tagId FROM {$XjZXS}\nWHERE questionId IN (\n    SELECT questionId FROM\n    (\n        {$LR9kk}\n    ) t{$w6tFT}\n    WHERE tagId IN ({$h1hLN})\n    GROUP BY questionId\n)\n"; } goto zGJJa; MF92O: } goto el96n; cTFIo: $w6tFT = 0; goto tzZni; UF13G: $XjZXS = ModelManageUtil::table('question_tag_map'); goto Z8QJw; i0EvX: return $LR9kk; goto LGFUc; el96n: $LR9kk .= ' GROUP BY questionId'; goto i0EvX; Z8QJw: $LR9kk = ''; goto cTFIo; LGFUc: } return null; } protected function tagIdToGroups($oJdE8) { goto gdTIU; k9M7p: foreach ($oJdE8 as $RgY2C) { goto L4P22; z2Z9l: if (empty($FuT2O[$KZekU[$RgY2C]])) { $FuT2O[$KZekU[$RgY2C]] = array(); } goto wyvRP; L4P22: if (empty($KZekU[$RgY2C])) { continue; } goto z2Z9l; wyvRP: $FuT2O[$KZekU[$RgY2C]][] = intval($RgY2C); goto AnO6K; AnO6K: } goto utqDM; utqDM: return $FuT2O; goto gsmHD; WaGml: $FuT2O = array(); goto k9M7p; gdTIU: $KZekU = QuestionTagUtil::groupTagMap(); goto WaGml; gsmHD: } protected $listOrder = null; protected $listMinId = -1; protected $listMaxId = -1; public function lists() { goto TyhTm; fpNNp: $S3IJB = $tfe0V->getInteger('type'); goto VJ9nN; a1BCF: Session::put('QuestionViewParam', QuestionUtil::paramEncode($ArUDb ? $ArUDb['id'] : 0, $vSByv, $S3IJB, $oJdE8, $TO6f4)); goto i70v4; zOEyt: if (empty($this->listOrder)) { $this->listOrder = array('id', 'desc'); } goto LtnPx; BUbrY: $gETpv = min($bz1sB->getInteger('page', 1), $Z9dd2); goto fpNNp; l3iLn: $vSByv = $tfe0V->getInteger('chapterId'); goto j5inF; bxSvy: $CUpaH = false; goto TqsXi; x1apS: if (empty($TO6f4)) { $TO6f4 = $bz1sB->getTrimString('keywords'); } goto zOEyt; gyn2S: $C0r1E = $BfEFC['records']; goto lPnXv; CF8EK: $xSF0s = join(' ', $ehyd6); goto iR7wM; j5inF: $ZG3Gn = array(); goto uhdfC; iR7wM: $ehyd6[] = '第' . $gETpv . '页'; goto Yz9ha; uhdfC: if ($vSByv) { $ZG3Gn = QuestionChapterUtil::childrenIds($ArUDb['id'], $vSByv); $NuYRV = QuestionChapterUtil::get($vSByv); } goto bxSvy; LZIN6: $bz1sB = InputPackage::buildFromInput(); goto ckvjq; WbKl0: if (empty($tfe0V->all())) { $tfe0V = $bz1sB->getJsonAsInput('search'); } goto O9MzC; TqsXi: $oJdE8 = $tfe0V->getStringSeparatedArray('tagId'); goto x5Bl3; BVRvw: if (empty($qhOVL)) { goto Y_qdp; Oov2J: $hlYz_ = $JtdAh->paginate($Wo30p, array('*'), 'page', $gETpv)->toArray(); goto WWgeS; HQb5p: if (!empty($ZG3Gn)) { $JtdAh->whereIn('chapterId', $ZG3Gn); } goto lPtVn; M7AiM: if ($this->listMinId >= 0) { $JtdAh->where('id', '>', $this->listMinId); } goto CRqgp; lPtVn: $LR9kk = $this->tagGroupsToSql($FuT2O); goto LipJ1; CRqgp: if (!empty($ArUDb)) { $JtdAh->where(array('catId' => $ArUDb['id'])); } goto Fimp_; e4pqn: if ($this->listMaxId >= 0) { $JtdAh->where('id', '<', $this->listMaxId); } goto M7AiM; Y_qdp: $JtdAh = Question::where(array('isOpen' => true, 'parentId' => 0))->orderBy($this->listOrder[0], $this->listOrder[1]); goto e4pqn; LipJ1: if (!empty($LR9kk)) { $JtdAh->whereRaw('id IN ( SELECT t.questionId AS id FROM (' . $LR9kk . ') AS t )'); } goto b2qrS; b2qrS: if ($TO6f4) { $JtdAh->where('questionText', 'like', '%' . $TO6f4 . '%'); } goto Oov2J; Fimp_: if ($S3IJB) { $JtdAh->where(array('type' => $S3IJB)); } goto HQb5p; WWgeS: $BfEFC = array('records' => $hlYz_['data'], 'total' => $hlYz_['total']); goto bEUyf; bEUyf: } else { goto UyCIh; zcP5X: if (!empty($ArUDb)) { $JtdAh[] = array('catId' => array('eq' => $ArUDb['id'])); } goto DW2qc; f3ITr: if ($this->listMinId >= 0) { $JtdAh[] = array('id' => array('gt' => $this->listMinId)); } goto zcP5X; XK7MX: if (!empty($FuT2O)) { foreach ($FuT2O as $YFOa3) { $JtdAh[] = array('tags' => array('in' => $YFOa3)); } } goto WB6Eb; UyCIh: $JtdAh = array(array('isOpen' => array('eq' => 1)), array('parentId' => array('eq' => 0))); goto AL7uU; u9iIk: $BfEFC['records'] = QuestionUtil::listQuestionsSimple($K7M07); goto m8q9O; AL7uU: if ($this->listMaxId >= 0) { $JtdAh[] = array('id' => array('lt' => $this->listMaxId)); } goto f3ITr; uagvC: $K7M07 = array_map(function ($uoZJl) { return $uoZJl['id']; }, $BfEFC['records']); goto u9iIk; RyPr8: if (!empty($ZG3Gn)) { $JtdAh[] = array('chapterId' => array('in' => $ZG3Gn)); } goto XK7MX; WB6Eb: if ($TO6f4) { $JtdAh[] = array('questionText' => array('like' => $TO6f4)); } goto YL6Oo; DW2qc: if ($S3IJB) { $JtdAh[] = array('type' => array('eq' => $S3IJB)); } goto RyPr8; YL6Oo: $BfEFC = $qhOVL->search('question_question', $gETpv, $Wo30p, $JtdAh, $this->listOrder); goto uagvC; m8q9O: } goto gyn2S; b4SkP: foreach ($C0r1E as $l3Jim => $hd5k9) { goto TByta; TByta: $C0r1E[$l3Jim]['_title'] = HtmlUtil::text($hd5k9['question'], 100); goto W_2uf; W_2uf: $C0r1E[$l3Jim]['_correctRate'] = $hd5k9['testCount'] > 0 ? sprintf('%d%%', $hd5k9['passCount'] * 100 / $hd5k9['testCount']) : '-'; goto chKD5; HFDy_: $C0r1E[$l3Jim]['tag'] = TagUtil::mapInfo($hd5k9['tag'], $GjTvT); goto nARdn; chKD5: $hd5k9['tag'] = TagUtil::string2Array($hd5k9['tag']); goto HFDy_; nARdn: } goto cKoZG; cKoZG: $ehyd6 = array(); goto qvjKY; i70v4: return Response::generateSuccessData(array('total' => $BfEFC['total'], 'records' => $C0r1E, 'page' => $gETpv, 'pageSize' => $Wo30p, 'cat' => $ArUDb, 'selectedTags' => $hzhgt, 'selectedTagIds' => $oJdE8, 'keywords' => $TO6f4, 'type' => $S3IJB, 'chapter' => $NuYRV, 'tags' => QuestionTagUtil::groupTags($ArUDb['id']), 'selectedTagOverSize' => $CUpaH, 'pageTitle' => $ehyd6, 'pageKeywords' => $xSF0s, 'pageDescription' => $XkPD4, 'pageHtml' => $GOMtc)); goto sPgdS; yemxq: $TO6f4 = $tfe0V->getTrimString('keywords'); goto x1apS; bNXfd: $GOMtc = PageHtmlUtil::render($BfEFC['total'], $Wo30p, $gETpv, '?' . Request::mergeQueries(array('page' => array('{page}')))); goto a1BCF; PWxx7: $hzhgt = QuestionTagUtil::listByIds($oJdE8); goto yemxq; ckvjq: $tfe0V = $bz1sB->getAsInput('search'); goto WbKl0; x5Bl3: if (empty($oJdE8)) { $oJdE8 = $tfe0V->getIntegerArray('tagIds'); } goto df2U3; a6DAi: $FuT2O = $this->tagIdToGroups($oJdE8); goto PWxx7; df2U3: if (count($oJdE8) > 5) { goto W2y9j; Suftj: $CUpaH = true; goto K0di4; W2y9j: $oJdE8 = array_chunk($oJdE8, 5); goto j_9Ko; j_9Ko: $oJdE8 = $oJdE8[0]; goto Suftj; K0di4: } goto a6DAi; VJ9nN: $NuYRV = null; goto l3iLn; Yz9ha: $ehyd6 = join(' ', $ehyd6); goto uq26o; l84Hx: $Z9dd2 = modstart_config()->getInteger('moduleQuestionMaxPage', 20); goto BUbrY; uq26o: $XkPD4 = $ehyd6; goto bNXfd; GY0Tt: if (!empty($hzhgt)) { foreach ($hzhgt as $umqi1) { $ehyd6[] = $umqi1['title']; } } goto CF8EK; lPnXv: $BfEFC['total'] = min($BfEFC['total'], $Z9dd2 * $Wo30p); goto cf28h; qvjKY: if ($TO6f4) { $ehyd6[] = '搜索"' . $TO6f4 . '"'; } goto GY0Tt; TyhTm: if (!QuestionUtil::isEnable()) { return QuestionUtil::disabledResponse(); } goto LZIN6; HCUt1: $Wo30p = 10; goto l84Hx; cf28h: $GjTvT = QuestionTagUtil::getMap(); goto b4SkP; LtnPx: $qhOVL = SuperSearchUtil::provider(); goto BVRvw; O9MzC: $ArUDb = QuestionCatUtil::getShowing($bz1sB->getInteger('catId')); goto HCUt1; sPgdS: } public function get() { goto dEs2g; oJWsf: InputPackage::mergeToInputAll($PRab8, 'search'); goto OJtnu; R5_90: InputPackage::mergeToInput('pageSize', 1); goto J27ni; d9nlO: $this->listMaxId = -1; goto s94cF; OJtnu: InputPackage::mergeToInput('page', 1); goto R5_90; ACL7_: $dqC_A['question']['tag'] = TagUtil::string2Array($dqC_A['question']['tag']); goto vAjub; ySGo9: $eypYa = Response::tryGetData($this->lists()); goto PfHNI; eGcDX: $eypYa = Response::tryGetData($this->lists()); goto eMf70; MfzbO: return Response::generateSuccessData(array('questionData' => $dqC_A, 'previousQuestion' => $WyBOR, 'nextQuestion' => $bks2P, 'param' => $oG0tD, 'cat' => QuestionCatUtil::getShowing($dqC_A['question']['catId']))); goto woHOA; BFTHp: $wKi71 = $bz1sB->getTrimString('alias'); goto NhTgM; t9mbk: if (empty($dqC_A)) { return Response::generateError('题目不存在'); } goto pRqCX; HaMxj: $this->listMinId = -1; goto CsPk5; PfHNI: if (!empty($eypYa['records'])) { $WyBOR = $eypYa['records'][0]; } goto HaMxj; orOJe: switch ($dqC_A['question']['status']) { case QuestionStatus::VERIFYING: case QuestionStatus::VERIFY_FAIL: goto wzl6F; KGOQh: BizException::throwsIf('题目审核中', MemberUser::id() != $dqC_A['question']['memberUserId']); goto t_fBP; wzl6F: BizException::throwsIf('题目审核中', MemberUser::isNotLogin()); goto KGOQh; t_fBP: break; goto ERqM7; ERqM7: } goto dhcHR; Ev3Nx: $bks2P = null; goto jYkZn; zxhGX: $WyBOR = null; goto Ev3Nx; SCeTY: InputPackage::mergeToInputAll($PRab8); goto oJWsf; UgevS: list($dqC_A, $JoZVT) = QuestionUtil::filterQuestionData($dqC_A); goto MfzbO; jYkZn: $oG0tD = Session::get('QuestionViewParam'); goto k3LF3; dEs2g: if (!QuestionUtil::isEnable()) { return QuestionUtil::disabledResponse(); } goto Vhf1Y; vAjub: $dqC_A['question']['tag'] = TagUtil::mapInfo($dqC_A['question']['tag'], QuestionTagUtil::getMap()); goto orOJe; k3LF3: $PRab8 = QuestionUtil::paramDecode($oG0tD); goto iCh4H; NhTgM: $dqC_A = QuestionUtil::getQuestionData(null, $wKi71); goto t9mbk; dhcHR: QuestionUtil::questionClick($dqC_A['question']['id']); goto T_ou6; pRqCX: BizException::throwsIf('题目未公开', !$dqC_A['question']['isOpen']); goto ACL7_; eMf70: if (!empty($eypYa['records'])) { $bks2P = $eypYa['records'][0]; } goto UgevS; T_ou6: if ($bz1sB->getBoolean('moreInfo')) { if (modstart_module_enabled('QuestionEnhance')) { goto r74tH; oS5Af: $dqC_A['question']['_note'] = QuestionNoteUtil::getMemberNoteByQuestionId(MemberUser::id(), $dqC_A['question']['id']); goto TiDYA; r74tH: $dqC_A['question']['_fav'] = QuestionFavUtil::getFav(MemberUser::id(), $dqC_A['question']['id']); goto ONvY4; ONvY4: $dqC_A['question']['_errors'] = QuestionErrorsUtil::getErrors(MemberUser::id(), $dqC_A['question']['id']); goto oS5Af; TiDYA: } } goto zxhGX; iCh4H: if (empty($PRab8['catId'])) { $PRab8['catId'] = $dqC_A['question']['catId']; } goto SCeTY; Vhf1Y: $bz1sB = InputPackage::buildFromInput(); goto BFTHp; CsPk5: $this->listMaxId = $dqC_A['question']['id']; goto F4hxc; J27ni: $this->listMinId = $dqC_A['question']['id']; goto d9nlO; s94cF: $this->listOrder = array('id', 'asc'); goto ySGo9; F4hxc: $this->listOrder = array('id', 'desc'); goto eGcDX; woHOA: } public function latest() { return $this->lists(); } public function answerProcess($oG0tD = array()) { goto n4dhL; ck8Pz: if (MemberVipUtil::isEnable()) { if ($dqC_A['question']['type'] != QuestionType::GROUP) { if ($oG0tD['checkQuota']) { goto dWPqc; dWPqc: $jFABH = MemberVip::get(); goto xbmHD; DpnYx: QuestionMemberVipQuotaUtil::questionViewPut(MemberUser::id(), $dqC_A['question']['id']); goto AosPq; xbmHD: if (empty($jFABH)) { return Response::generateError('您的会员不存在，点击立即开通', null, modstart_web_url('member_vip')); } goto SSgOl; SSgOl: if (QuestionMemberVipQuotaUtil::questionViewCountToday(MemberUser::id()) >= $jFABH['quotaQuestionViewDaily']) { return Response::generateError('您每天最多只能看' . $jFABH['quotaQuestionViewDaily'] . '个题目，立即升级会员', null, modstart_web_url('member_vip')); } goto DpnYx; AosPq: } } else { foreach ($dqC_A['items'] as $REa1I) { if (!QuestionMemberVipQuotaUtil::questionViewed(MemberUser::id(), $REa1I['question']['id'])) { return Response::generateError('当前题目组的所有问题未查看完成，不能查看题目组解析'); } } } } goto Zt5r3; Ngqtd: $wKi71 = $bz1sB->getTrimString('alias'); goto NWi66; aq17R: $yifft = $bz1sB->get('answer'); goto quvJZ; DnGzP: if ($qN12k['judge']) { QuestionUtil::increaseQuestionTestCount($dqC_A['question']['id']); if ($qN12k['correct']) { QuestionUtil::increaseQuestionPassCount($dqC_A['question']['id']); } else { if (modstart_module_enabled('QuestionEnhance')) { QuestionErrorsUtil::put(MemberUser::id(), $dqC_A['question']['catId'], $dqC_A['question']['id']); } } } goto K2Iin; PanpR: $dqC_A = QuestionUtil::getQuestionData(null, $wKi71); goto muqUV; NWi66: if (!MemberUser::id()) { return Response::generateError('请先登录'); } goto PanpR; n4dhL: if (!isset($oG0tD['checkQuota'])) { $oG0tD['checkQuota'] = true; } goto uN9Ch; uN9Ch: $bz1sB = InputPackage::buildFromInput(); goto Ngqtd; Zt5r3: $bz1sB = InputPackage::buildFromInput(); goto aq17R; K2Iin: list($dqC_A, $JoZVT) = QuestionUtil::filterQuestionData($dqC_A); goto l1ju5; l1ju5: $dqC_A['analysis'] = $JoZVT['analysis']; goto dqFgC; muqUV: if (empty($dqC_A)) { return Response::generateError('题目不存在'); } goto RhehJ; dqFgC: return Response::generateSuccessData(array('answer' => $yifft, 'questionData' => $dqC_A, 'answerInfo' => $qN12k)); goto CNNfH; quvJZ: $qN12k = QuestionUtil::parseAnswerInfo($dqC_A, $yifft); goto DnGzP; RhehJ: BizException::throwsIf('题目未公开', !$dqC_A['question']['isOpen']); goto ck8Pz; CNNfH: } public function answer() { if (!QuestionUtil::isEnable()) { return QuestionUtil::disabledResponse(); } return $this->answerProcess(); } public function cat() { goto vIaE0; vIaE0: $bz1sB = InputPackage::buildFromInput(); goto PjAHg; PjAHg: $oUKOQ = $bz1sB->getInteger('catId'); goto fdJhz; fdJhz: $ArUDb = QuestionCatUtil::getShowing($oUKOQ); goto B46FF; B46FF: return Response::generateSuccessData(array('cat' => $ArUDb)); goto mhmDS; mhmDS: } public function catOrDefault() { goto HAaT8; a6zSo: if (!$oUKOQ) { $oUKOQ = QuestionCatUtil::firstShowingId(); } goto t_sTW; t_sTW: $ArUDb = QuestionCatUtil::getShowing($oUKOQ); goto joI23; joI23: return Response::generateSuccessData(array('cat' => $ArUDb, 'chapterTree' => QuestionChapterUtil::allTree($ArUDb['id']), 'tags' => QuestionTagUtil::groupTags($ArUDb['id']))); goto D9qp4; HAaT8: $bz1sB = InputPackage::buildFromInput(); goto iPKc6; iPKc6: $oUKOQ = $bz1sB->getInteger('catId'); goto a6zSo; D9qp4: } public function catList() { return Response::generateSuccessData(array('cats' => QuestionCatUtil::allShowing())); } public function searchOcr() { goto oqfX2; R1OyH: $iUjyb = $bz1sB->getTrimString('format'); goto BlLsF; oqfX2: $bz1sB = InputPackage::buildFromInput(); goto jnvFn; L48eT: return Response::generateSuccessData(array('text' => $eZv6D)); goto p8at2; jnvFn: $btkNZ = $bz1sB->getBase64File('imageData'); goto R1OyH; rvwDS: $qhOVL = OcrProvider::get(modstart_config('Question_SearchOcrProvider')); goto AfyE9; AfyE9: BizException::throwsIfEmpty('请配置OCR搜题驱动', $qhOVL); goto TdhJP; BlLsF: BizException::throwsIfEmpty('图片为空', $btkNZ); goto DOFzc; TdhJP: $eZv6D = $qhOVL->getText($btkNZ, $iUjyb); goto L48eT; DOFzc: BizException::throwsIfEmpty('图片格式为空', $iUjyb); goto rvwDS; p8at2: } }