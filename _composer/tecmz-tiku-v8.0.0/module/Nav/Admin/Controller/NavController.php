<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Nav\Admin\Controller; use Illuminate\Routing\Controller; use ModStart\Admin\Concern\HasAdminQuickCRUD; use ModStart\Admin\Layout\AdminCRUDBuilder; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Type\TypeUtil; use ModStart\Field\AbstractField; use ModStart\Field\AutoRenderedFieldValue; use ModStart\Field\Type\FieldRenderMode; use ModStart\Form\Form; use ModStart\ModStart; use ModStart\Repository\Filter\ScopeFilter; use ModStart\Support\Concern\HasFields; use Module\Nav\Type\NavOpenType; use Module\Nav\Type\NavPosition; use Module\Nav\Util\NavUtil; class NavController extends Controller { use HasAdminQuickCRUD; protected function crud(AdminCRUDBuilder $cv5kq) { goto KNv5U; cIGkU: $cv5kq->scopeDefault(NavPosition::first()); goto Ed2MR; Ed2MR: $cv5kq->hookSaved(function (Form $Yfg4L) { $REa1I = $Yfg4L->item(); if ($REa1I->pid > 0) { $mRfS1 = ModelUtil::get('nav', $REa1I->pid); ModelUtil::update('nav', $REa1I->id, array('position' => $mRfS1['position'])); } })->hookChanged(function (Form $Yfg4L) { NavUtil::clearCache(); })->canBatchDelete(true)->asTree('id', 'pid', 'sort', 'name')->treeMaxLevel(2)->title('导航'); goto r5nrN; KNv5U: if ($cv5kq->mode() == AdminCRUDBuilder::MODE_FORM) { goto HDcJF; Gcuw2: ModStart::scriptFile('module/Nav/Admin/Controller/NavEdit.js'); goto P20jy; vqCpF: foreach (ModelUtil::all('nav', array('pid' => 0), array('*')) as $REa1I) { $U0mOh[$REa1I['id']] = TypeUtil::name(NavPosition::class, $REa1I['position']) . ' > ' . $REa1I['name']; } goto VoYj6; HDcJF: $U0mOh = array(); goto vqCpF; VoYj6: ModStart::script('window.__navPositionMap=' . json_encode($U0mOh) . ';'); goto Gcuw2; P20jy: } goto sxtSE; sxtSE: $cv5kq->init('nav')->field(function ($cv5kq) { $cv5kq->id('id', 'ID'); $cv5kq->select('position', '位置')->optionType(NavPosition::class)->hookRendering(function (AbstractField $QGYmu, $REa1I, $x1Lvn) { switch ($QGYmu->renderMode()) { case FieldRenderMode::DETAIL: case FieldRenderMode::GRID: if ($REa1I->pid) { return AutoRenderedFieldValue::make(''); } return AutoRenderedFieldValue::make(TypeUtil::name(NavPosition::class, $REa1I->position)); } }); $cv5kq->text('name', '名称'); $cv5kq->icon('icon', '图标')->help('部分主题支持图标显示'); $cv5kq->link('link', '链接'); $cv5kq->switch('enable', '启用')->optionsYesNo()->gridEditable(true)->defaultValue(true); $cv5kq->radio('openType', '打开方式')->optionType(NavOpenType::class)->defaultValue(NavOpenType::CURRENT_WINDOW); $cv5kq->display('created_at', L('Created At'))->listable(false); $cv5kq->display('updated_at', L('Updated At'))->listable(false); }); goto ROEGz; ROEGz: foreach (NavPosition::getList() as $Mlv3V => $WZC9G) { $cv5kq->scopeFilter($Mlv3V, $WZC9G, function (ScopeFilter $qM7YH) use($Mlv3V) { return $qM7YH->where('position', $Mlv3V); }); } goto cIGkU; r5nrN: } }