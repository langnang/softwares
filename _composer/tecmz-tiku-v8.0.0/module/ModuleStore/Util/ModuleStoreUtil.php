<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\ModuleStore\Util; use Chumper\Zipper\Zipper; use Illuminate\Support\Facades\Cache; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Response; use ModStart\Core\Util\CurlUtil; use ModStart\Core\Util\FileUtil; use ModStart\Core\Util\VersionUtil; use ModStart\ModStart; use ModStart\Module\ModuleManager; class ModuleStoreUtil { const REMOTE_BASE = 'https://modstart.com'; public static function remoteModuleData() { goto Exnpa; Exnpa: $bz1sB = InputPackage::buildFromInput(); goto pO9e0; pE7x_: return Cache::remember('ModuleStore_Modules:' . $MqkYF, 60, function () use($dwfkT) { $rwsHh = 'cms'; if (class_exists('\\App\\Constant\\AppConstant')) { $rwsHh = \App\Constant\AppConstant::APP; } $BEdDh = CurlUtil::getJSONData(self::REMOTE_BASE . '/api/store/module', array('app' => $rwsHh, 'api_token' => $dwfkT)); return $BEdDh; }); goto ivipc; pO9e0: $MqkYF = $bz1sB->getInteger('memberUserId'); goto a65hD; a65hD: $dwfkT = $bz1sB->getTrimString('apiToken'); goto pE7x_; ivipc: } public static function all() { goto oCTpr; R0KQo: if (!empty($hlYz_['data']['modules'])) { foreach ($hlYz_['data']['modules'] as $Nj365) { goto AG6JG; qVKkW: $he5d7[$Nj365['name']] = $Nj365; goto QAhj0; AG6JG: $Nj365['_isLocal'] = false; goto GU8vO; qn27C: $Nj365['_hasConfig'] = false; goto qVKkW; pgXbF: $Nj365['_isSystem'] = false; goto qn27C; GU8vO: $Nj365['_isInstalled'] = false; goto W83VT; W83VT: $Nj365['_isEnabled'] = false; goto AetM1; AetM1: $Nj365['_localVersion'] = null; goto pgXbF; QAhj0: } } goto N0NMd; klBWg: $GvWPe = array(); goto zvi1V; ibWjs: if (!empty($hlYz_['data']['categories'])) { $kHkRp = $hlYz_['data']['categories']; } goto klBWg; zvi1V: if (!empty($hlYz_['data']['types'])) { $GvWPe = $hlYz_['data']['types']; } goto zuob8; zuob8: $he5d7 = array(); goto R0KQo; ibsnp: $kHkRp = array(); goto ibWjs; EWnLg: return array('storeConfig' => $OyuSu, 'categories' => $kHkRp, 'types' => $GvWPe, 'modules' => array_values($he5d7)); goto rxEN1; oCTpr: $OyuSu = array('disable' => config('env.MS_MODULE_STORE_DISABLE', false)); goto GwuKR; N0NMd: foreach (ModuleManager::listModules() as $nq5ti => $qc0K6) { $kkerk = ModuleManager::getModuleBasic($nq5ti); if (isset($he5d7[$nq5ti])) { goto RVjh0; kOuyO: $he5d7[$nq5ti]['_isSystem'] = $qc0K6['isSystem']; goto XQBM3; ZLvp0: $he5d7[$nq5ti]['_isEnabled'] = $qc0K6['enable']; goto ptk51; RVjh0: $he5d7[$nq5ti]['_isInstalled'] = $qc0K6['isInstalled']; goto ZLvp0; XQBM3: $he5d7[$nq5ti]['_hasConfig'] = !empty($kkerk['config']); goto PoJTM; ptk51: $he5d7[$nq5ti]['_localVersion'] = $kkerk['version']; goto kOuyO; PoJTM: } else { $he5d7[$nq5ti] = array('id' => 0, 'name' => $nq5ti, 'title' => $kkerk['title'], 'cover' => null, 'categoryId' => null, 'latestVersion' => $kkerk['version'], 'releases' => array(), 'url' => null, 'isFee' => false, 'priceSuper' => null, 'priceSuperEnable' => false, 'priceYear' => null, 'priceYearEnable' => false, 'description' => $kkerk['description'], '_isLocal' => true, '_isInstalled' => $qc0K6['isInstalled'], '_isEnabled' => $qc0K6['enable'], '_localVersion' => $kkerk['version'], '_isSystem' => $qc0K6['isSystem'], '_hasConfig' => !empty($kkerk['config'])); } } goto EWnLg; GwuKR: $hlYz_ = self::remoteModuleData(); goto ibsnp; rxEN1: } private static function baseRequest($lYtoi, $GeXSC, $HUlap) { return CurlUtil::postJSONBody(self::REMOTE_BASE . $lYtoi, $GeXSC, array('header' => array('api-token' => $HUlap, 'X-Requested-With' => 'XMLHttpRequest'))); } public static function checkPackage($HUlap, $FgRrl, $alp6f) { goto UndGx; pCVtT: if (empty($qc0K6['env'])) { $qc0K6['env'] = array('laravel5'); } goto sni1R; UkQcF: return Response::generateSuccessData(array('requires' => $mRWA_, 'errorCount' => count(array_filter($mRWA_, function ($vY60h) { return !$vY60h['success']; })), 'packageSize' => $WxB3P)); goto pEb2t; uy3rw: BizException::throwsIfResponseError($BEdDh); goto xsgP9; zhb57: $WxB3P = $BEdDh['data']['packageSize']; goto B4fYR; xsgP9: $qc0K6 = $BEdDh['data']['config']; goto zhb57; UndGx: $BEdDh = self::baseRequest('/api/store/module_info', array('module' => $FgRrl, 'version' => $alp6f), $HUlap); goto uy3rw; B4fYR: $mRWA_ = array(); goto y0_JU; sni1R: if (method_exists(ModuleManager::class, 'getEnv')) { $dmoAp = ModuleManager::getEnv(); BizException::throwsIf(L('Module %s:%s compatible with env %s, current is %s', $FgRrl, $qc0K6['version'], join(',', $qc0K6['env']), $dmoAp), !in_array($dmoAp, $qc0K6['env'])); } goto UkQcF; pyrpv: if (!empty($qc0K6['require'])) { foreach ($qc0K6['require'] as $CviJZ) { goto sVAq0; alaMT: if (ModuleManager::isModuleInstalled($nq5ti)) { goto v3E4y; lgq1Q: if (!$CviJZ['success']) { $CviJZ['resolve'] = '请使用版本 ' . htmlspecialchars($NIxlc) . " 的模块 <a href='https://modstart.com/m/{$nq5ti}' class='ub-text-white tw-underline' target='_blank'>{$nq5ti}</a>"; } goto YDtlm; qV2YJ: $CviJZ['success'] = VersionUtil::match($mTw11['version'], $NIxlc); goto lgq1Q; v3E4y: $mTw11 = ModuleManager::getModuleBasic($nq5ti); goto UnJP2; UnJP2: BizException::throwsIfEmpty("获取模块 {$nq5ti} 信息失败", $mTw11); goto qV2YJ; YDtlm: } else { $CviJZ['success'] = false; $CviJZ['resolve'] = "请先安装 {$CviJZ['name']} <a href='https://modstart.com/m/{$nq5ti}' class='ub-text-white tw-underline' target='_blank'>[点击查看]</a>"; } goto aL1e3; AThYl: $CviJZ = array('name' => "<a href='https://modstart.com/m/{$nq5ti}' class='ub-text-white tw-underline' target='_blank'>{$nq5ti}</a>:" . htmlspecialchars($NIxlc), 'success' => true, 'resolve' => null); goto alaMT; aL1e3: $mRWA_[] = $CviJZ; goto WGF4Y; sVAq0: list($nq5ti, $NIxlc) = VersionUtil::parse($CviJZ); goto AThYl; WGF4Y: } } goto pCVtT; y0_JU: if (!empty($qc0K6['modstartVersion'])) { goto ts4bu; vItjk: $mRWA_[] = $CviJZ; goto G3h07; k0_uE: if (!$CviJZ['success']) { $CviJZ['resolve'] = '请使用 MSCore' . $qc0K6['modstartVersion'] . ' 的版本'; } goto vItjk; ts4bu: $CviJZ = array('name' => '<a href=\'https://modstart.com/download\' class=\'ub-text-white tw-underline\' target=\'_blank\'>MSCore</a>:' . htmlspecialchars($qc0K6['modstartVersion']), 'success' => VersionUtil::match(ModStart::$version, $qc0K6['modstartVersion']), 'resolve' => null); goto k0_uE; G3h07: } goto pyrpv; pEb2t: } public static function downloadPackage($HUlap, $FgRrl, $alp6f) { goto x7zeA; x9Y1x: BizException::throwsIfResponseError($BEdDh); goto h5UEa; kqxwr: $xZIda = FileUtil::generateLocalTempPath('zip'); goto v_AKu; v6xFN: BizException::throwsIfEmpty('安装包获取失败', $GeXSC); goto kqxwr; J6Qzt: $JiJ0N = $BEdDh['data']['packageMd5']; goto v4dtB; h5UEa: $ZD7Jf = $BEdDh['data']['package']; goto J6Qzt; x7zeA: $BEdDh = self::baseRequest('/api/store/module_package', array('module' => $FgRrl, 'version' => $alp6f), $HUlap); goto x9Y1x; v4dtB: $AfbuP = $BEdDh['data']['licenseKey']; goto hToP3; hToP3: $GeXSC = CurlUtil::getRaw($ZD7Jf); goto v6xFN; TzlY0: return Response::generateSuccessData(array('package' => $xZIda, 'licenseKey' => $AfbuP, 'packageSize' => filesize($xZIda))); goto F24UP; S6g7H: BizException::throwsIf('文件MD5校验失败', md5_file($xZIda) != $JiJ0N); goto TzlY0; v_AKu: file_put_contents($xZIda, $GeXSC); goto S6g7H; F24UP: } public static function cleanDownloadedPackage($ZD7Jf) { FileUtil::safeCleanLocalTemp($ZD7Jf); } public static function unpackModule($FgRrl, $ZD7Jf, $AfbuP) { goto RG_P4; Vp0HK: if (file_exists($h6N3f)) { goto vmVAO; EuLU8: BizException::throwsIf('备份模块旧文件失败', !file_exists($qd6lu)); goto EFQvy; vmVAO: $hm8RX = '_delete_.' . date('Ymd_His') . '.' . $FgRrl; goto qTzUG; iOo1D: try { rename($h6N3f, $qd6lu); } catch (\Exception $knlzD) { BizException::throws("备份模块 {$FgRrl} 到 {$hm8RX} 失败（确保模块中所有文件和目录已关闭）"); } goto EuLU8; kN4wF: $qd6lu = base_path("module/{$hm8RX}"); goto iOo1D; qTzUG: BizException::throwsIf('模块目录 module/' . $FgRrl . ' 不正常，请手动删除', !is_dir($h6N3f)); goto kN4wF; EFQvy: $V8m5o[] = "备份模块 {$FgRrl} 到 {$hm8RX}"; goto uR2WS; uR2WS: } goto gcr0D; ydGe3: $h6nbW = new Zipper(); goto fu8QS; RG_P4: $V8m5o = array(); goto hwUUi; BK4oW: BizException::throwsIfResponseError($BEdDh); goto U785T; WdIrx: return Response::generateSuccessData($V8m5o); goto AR3qh; YDD0R: file_put_contents($h6N3f . '/license.json', json_encode(array('licenseKey' => $AfbuP))); goto Eyxq3; jy8Am: $h6nbW->extractTo($h6N3f); goto TV1zP; yJYGB: if ($h6nbW->contains($FgRrl . '/config.json')) { $h6nbW->folder($FgRrl . ''); } goto jy8Am; Eyxq3: self::cleanDownloadedPackage($ZD7Jf); goto WdIrx; TV1zP: $h6nbW->close(); goto ajYTs; hwUUi: BizException::throwsIf('文件不存在 ' . $ZD7Jf, empty($ZD7Jf) || !file_exists($ZD7Jf)); goto a4XQL; ajYTs: BizException::throwsIf('解压失败', !file_exists($h6N3f . '/config.json')); goto YDD0R; gcr0D: BizException::throwsIf('模块目录 module/' . $FgRrl . ' 不正常，请手动删除', file_exists($h6N3f)); goto ydGe3; U785T: $h6N3f = base_path('module/' . $FgRrl); goto Vp0HK; a4XQL: $BEdDh = FileUtil::filePathWritableCheck(array('module/._write_check_')); goto BK4oW; fu8QS: $h6nbW->make($ZD7Jf); goto yJYGB; AR3qh: } public static function removeModule($FgRrl, $alp6f) { goto vuUgn; hDedw: $qd6lu = base_path("module/{$hm8RX}"); goto ZAJn6; HlQny: $hm8RX = '_delete_.' . date('Ymd_His') . '.' . $FgRrl; goto hDedw; ZAJn6: try { rename($h6N3f, $qd6lu); } catch (\Exception $knlzD) { BizException::throws("移除模块 {$FgRrl} 到 {$hm8RX} 失败，请确保模块 {$FgRrl} 中没有文件正在被使用"); } goto AuNLW; Uaeju: BizException::throwsIf('模块目录不存在 ', !file_exists($h6N3f)); goto Wdubn; Wdubn: BizException::throwsIf('模块目录 module/' . $FgRrl . ' 不正常，请手动删除', !is_dir($h6N3f)); goto HlQny; LDUb2: return Response::generateSuccessData(array()); goto jTtg4; vuUgn: $h6N3f = base_path('module/' . $FgRrl); goto Uaeju; AuNLW: BizException::throwsIf('模块目录备份失败', !file_exists($qd6lu)); goto LDUb2; jTtg4: } }