<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Payment\Notify; use Payment\Common\CmbConfig; use Payment\Common\PayException; use Payment\Config; use Payment\Utils\ArrayUtil; use Payment\Utils\RsaEncrypt; class CmbNotify extends NotifyStrategy { public function __construct(array $qc0K6) { try { $this->config = new CmbConfig($qc0K6); } catch (PayException $knlzD) { throw $knlzD; } } public function getNotifyData() { goto IyJNi; oqMLN: return $eypYa; goto oNEOX; IyJNi: $GeXSC = empty($_POST) ? $_GET : $_POST; goto FTr45; FTr45: if (empty($GeXSC) || !is_array($GeXSC)) { return false; } goto xC6xy; xC6xy: $eypYa = json_decode($GeXSC[CmbConfig::REQ_FILED_NAME], true); goto oqMLN; oNEOX: } public function checkNotifyData(array $GeXSC) { goto XiMg_; n4a2q: $GtgYE = $GeXSC['sign']; goto XKohc; PV2UT: if ($A5QIh === 'RSA') { $KHNS_ = new RsaEncrypt($this->config->rsaPubKey); return $KHNS_->rsaVerify($V3tE3, $GtgYE); } else { return false; } goto CWS1d; XiMg_: $A5QIh = strtoupper($GeXSC['signType']); goto n4a2q; VL28E: $V3tE3 = ArrayUtil::createLinkstring($vjyaQ); goto PV2UT; XKohc: $vjyaQ = ArrayUtil::arraySort($GeXSC['noticeData']); goto VL28E; CWS1d: } protected function getRetData(array $GeXSC) { goto zUqjv; zUqjv: $nnmDH = $GeXSC['noticeData']; goto K0tds; Dwlfa: return $eypYa; goto v_Jpt; bPYrd: if ($this->config->returnRaw) { $GeXSC['channel'] = $ghw00; return $GeXSC; } elseif ($ULaAs === CmbConfig::NOTICE_PAY) { $eypYa = array('amount' => $nnmDH['amount'], 'channel' => $ghw00, 'date' => $nnmDH['date'], 'order_no' => $nnmDH['orderNo'], 'trade_state' => Config::TRADE_STATUS_SUCC, 'transaction_id' => $nnmDH['bankSerialNo'], 'time_end' => date('Y-m-d H:i:s', strtotime($nnmDH['dateTime'])), 'discount_fee' => $nnmDH['discountAmount'], 'card_type' => $nnmDH['cardType'], 'return_param' => $nnmDH['merchantPara'], 'discount_flag' => $nnmDH['discountFlag'], 'notice_no' => $nnmDH['noticeSerialNo']); } elseif ($ULaAs === CmbConfig::NOTICE_SIGN) { $eypYa = array('user_id' => $nnmDH['userID'], 'no_pwd_pay' => $nnmDH['noPwdPay'], 'notice_no' => $nnmDH['noticeSerialNo'], 'agr_no' => $nnmDH['agrNo'], 'rsp_msg' => $nnmDH['rspMsg'], 'return_param' => $nnmDH['noticePara'], 'user_pid_hash' => $nnmDH['userPidHash'], 'user_pid_type' => $nnmDH['userPidType'], 'channel' => $ghw00); } else { $eypYa = $nnmDH; } goto Dwlfa; Cz181: if ($ULaAs === CmbConfig::NOTICE_PAY) { $ghw00 = Config::CMB_CHARGE; } elseif ($ULaAs === CmbConfig::NOTICE_SIGN) { $ghw00 = Config::CMB_BIND; } else { $ghw00 = 'other'; } goto bPYrd; K0tds: $ULaAs = $nnmDH['noticeType']; goto Cz181; v_Jpt: } protected function replyNotify($gSChU, $klZBn = 'OK') { if ($gSChU) { header('HTTP/1.1 200 OK'); return $klZBn; } else { header('HTTP/1.1 503 Service Unavailable'); return $klZBn; } } }