<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\PayCenter\Api\Controller; use Illuminate\Routing\Controller; use Illuminate\Support\Facades\Session; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Core\Util\AgentUtil; use ModStart\Module\ModuleManager; use Module\Member\Auth\MemberUser; use Module\PayCenter\Biz\PayCenterBiz; use Module\PayCenter\Type\PayType; use Module\PayCenter\Util\PayOrderUtil; use Module\PayCenter\Util\PayUtil; class PayController extends Controller { public function config() { goto ZZQEV; f2oYI: $qc0K6['wechatMobileEnable'] = PayUtil::isWechatEnable() && AgentUtil::isWechat(); goto q53Za; KQcaI: $qc0K6['alipayEnable'] = PayUtil::isAlipayEnable(); goto f2oYI; xmFzh: return Response::generateSuccessData($qc0K6); goto TRSnx; lxoKY: $qc0K6['device'] = AgentUtil::device(); goto xmFzh; q53Za: $qc0K6['wedchatEnable'] = PayUtil::isWechatEnable() && !AgentUtil::isWechat(); goto lxoKY; ZZQEV: $qc0K6 = array(); goto KQcaI; TRSnx: } public function info() { goto SKasu; SKasu: $bz1sB = InputPackage::buildFromInput(); goto FQA6f; JcDxH: return Response::generateSuccessData(array('orderSecretId' => $HKhEA, 'disabledPayTypes' => $JZdoy, 'order' => array('id' => $IfVKl['id'], 'status' => $IfVKl['status'], 'body' => $IfVKl['body'], 'redirect' => $IfVKl['redirect'], 'feeTotal' => $IfVKl['feeTotal'], 'biz' => $IfVKl['biz'], 'bizId' => $IfVKl['bizId']))); goto YUHk1; g1Pmh: BizException::throwsIfEmpty('订单不存在', $IfVKl); goto W8I2E; W8I2E: $PeuNd = PayCenterBiz::get($IfVKl['biz']); goto F3nUj; vl4KU: $IfVKl = PayOrderUtil::getOrder($HKhEA); goto g1Pmh; RNNlV: if ($PeuNd) { $JZdoy = $PeuNd->disabledPayTypes(); } goto JcDxH; F3nUj: $JZdoy = null; goto RNNlV; FQA6f: $HKhEA = $bz1sB->getTrimString('order'); goto vl4KU; YUHk1: } public function submit($IfVKl = null, $HKhEA = null) { goto MVz9x; seY1_: if (!PayUtil::isPayEnable($l9M__)) { return Response::generateError('支付方式未开启'); } goto JWZlE; tPCPd: $InfBU['device'] = $yA_IS; goto pbwqK; EXFlY: if (empty($IfVKl)) { goto H33Xq; H33Xq: $HKhEA = $bz1sB->getTrimString('order'); goto IZX4F; IZX4F: $IfVKl = PayOrderUtil::getOrder($HKhEA); goto UkZCm; UkZCm: BizException::throwsIfEmpty('订单不存在', $IfVKl); goto ynUyh; ynUyh: } goto CpNch; kZ11L: if (empty($l9M__)) { return Response::generateError('支付方式错误'); } goto seY1_; EG2Z6: if (!in_array($l9M__, $TjZyr, true)) { $loXJu = modstart_config()->getWithEnv('payDisableText'); if ($loXJu) { return Response::generateError($loXJu); } } goto RAPGF; MVz9x: $bz1sB = InputPackage::buildFromInput(); goto EXFlY; RAPGF: $yA_IS = $bz1sB->getTrimString('device'); goto HXGvQ; pbwqK: switch ($l9M__) { case PayType::ALIPAY: $InfBU['alipay_wap'] = AgentUtil::isMobile(); return PayOrderUtil::createPay($IfVKl['id'], $l9M__, $InfBU); case PayType::ALIPAY_WEB: case PayType::ALIPAY_MOBILE: return PayOrderUtil::createPay($IfVKl['id'], $l9M__, $InfBU); case PayType::MEMBER_MONEY: goto VN1Ua; VN1Ua: BizException::throwsIf('用户未登录', MemberUser::isNotLogin()); goto mYYLd; TIxFG: return PayOrderUtil::createPay($IfVKl['id'], $l9M__, $InfBU); goto uZkxM; mYYLd: $InfBU['memberUserId'] = MemberUser::id(); goto TIxFG; uZkxM: case PayType::WECHAT: goto pMHrv; t7v37: return Response::jsonFromGenerate($BEdDh); goto o99zr; pMHrv: $BEdDh = PayOrderUtil::createPay($IfVKl['id'], $l9M__, $InfBU); goto irlfW; irlfW: if (isset($BEdDh['data'])) { $BEdDh['data']['payWatchUrl'] = modstart_web_url('pay/watch', array('order' => $HKhEA)); } goto t7v37; o99zr: case PayType::WECHAT_APP: return PayOrderUtil::createPay($IfVKl['id'], $l9M__, $InfBU); case PayType::WECHAT_MOBILE: goto uoRLI; uoRLI: BizException::throwsIf('未安装 用户授权登录(MemberOauth) 模块', !ModuleManager::isModuleEnabled('MemberOauth')); goto I5tGg; AKMFP: return PayOrderUtil::createPay($IfVKl['id'], $l9M__, $InfBU); goto nQ21C; cHjk3: $InfBU['openId'] = $qFGW9; goto AKMFP; I5tGg: $qFGW9 = Session::get('oauthViewOpenId_wechatmobile'); goto y31Fl; y31Fl: if (empty($qFGW9)) { Session::put('autoClickPayType', 'wechat_mobile'); return Response::json(-1, null, array('needOauthLogin' => true), modstart_web_url('oauth_login_wechatmobile') . '?view=true&silence=true&redirect=' . urlencode(Request::currentPageUrl())); } goto cHjk3; nQ21C: case PayType::WECHAT_H5: return PayOrderUtil::createPay($IfVKl['id'], $l9M__, $InfBU); case PayType::WECHAT_MINI_PROGRAM: goto lQr25; d9oNq: $InfBU['openId'] = $qFGW9; goto ihjzp; lQr25: BizException::throwsIf('未安装 用户授权登录(MemberOauth) 模块', !ModuleManager::isModuleEnabled('MemberOauth')); goto wmqSA; wmqSA: $qFGW9 = Session::get('oauthViewOpenId_wechatminiprogram'); goto ob0bZ; ob0bZ: if (empty($qFGW9)) { return Response::json(-1, null, array('needOauthLogin' => true)); } goto d9oNq; ihjzp: return PayOrderUtil::createPay($IfVKl['id'], $l9M__, $InfBU); goto eWRcw; eWRcw: default: goto xyQAp; cnEZ8: return $BEdDh; goto jJdIn; cYpDG: if (Response::isSuccess($BEdDh)) { $BEdDh['data']['payWatchUrl'] = modstart_web_url('pay/watch', array('order' => $HKhEA)); } goto cnEZ8; qHLWT: BizException::throwsIfEmpty('支付提供者返回异常', $BEdDh); goto cYpDG; xyQAp: $BEdDh = PayOrderUtil::createPay($IfVKl['id'], $l9M__, $InfBU); goto qHLWT; jJdIn: } goto F5Clj; HXGvQ: $InfBU = array(); goto tPCPd; JWZlE: $TjZyr = array(PayType::MEMBER_MONEY); goto EG2Z6; CpNch: $l9M__ = $bz1sB->getType('type', PayType::class, null); goto kZ11L; F5Clj: } }