<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\PayCenter\Web\Controller; use Illuminate\Routing\Controller; use Illuminate\Support\Facades\Input; use Illuminate\Support\Facades\Log; use Illuminate\Support\Facades\Request; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Response; use Module\PayCenter\Provider\PayCenterProvider; use Module\PayCenter\Type\PayType; use Module\PayCenter\Util\PayOrderUtil; class ReturnController extends Controller { public function index($l9M__ = '') { $bz1sB = InputPackage::buildFromInput(); switch ($l9M__) { case PayType::ALIPAY: goto TDT8b; TDT8b: PayOrderUtil::initAlipay(); goto zJf0U; yOb1M: return Response::send(-1, '支付失败'); goto ey5i1; zJf0U: if (!app('alipay.web')->verify()) { Log::info('PayCenter.ReturnController - alipay return - query data verification fail - ' . json_encode(array('data' => Request::getQueryString()))); return Response::send(-1, '支付失败:-1'); } goto LIuan; LIuan: switch (Input::get('trade_status')) { case 'TRADE_SUCCESS': case 'TRADE_FINISHED': goto e89p2; DTBCC: $BEdDh = PayOrderUtil::handleOrderPay(PayType::ALIPAY, $I7OQF, array('payOrderId' => $f3szF)); goto oI0fs; oI0fs: if ($BEdDh['code']) { return Response::send(-1, '支付失败:' . $BEdDh['msg']); } goto k_wGW; MXndp: Log::info('PayCenter.ReturnController - alipay return - data verification success - ' . json_encode(array('out_trade_no' => $I7OQF, 'trade_no' => $f3szF))); goto DTBCC; k_wGW: $UYUrz = empty($BEdDh['data']['order']['redirect']) ? null : $BEdDh['data']['order']['redirect']; goto Y1B37; NBtLs: $f3szF = $bz1sB->getTrimString('trade_no'); goto MXndp; Y1B37: if (null === $UYUrz) { return Response::send(0, '支付成功'); } else { return Response::send(0, null, null, $UYUrz); } goto qd3hQ; e89p2: $I7OQF = $bz1sB->getTrimString('out_trade_no'); goto NBtLs; qd3hQ: } goto yOb1M; ey5i1: case PayType::ALIPAY_WEB: case PayType::ALIPAY_MOBILE: goto RAjTB; RAjTB: $I7OQF = $bz1sB->getTrimString('out_trade_no'); goto uoLRw; AOLug: BizException::throwsIfResponseError($BEdDh); goto LcNkl; LcNkl: return Response::redirect($BEdDh['data']['order']['redirect']); goto S1KNP; uoLRw: $BEdDh = PayOrderUtil::getOrderByOutTradeNo($I7OQF); goto AOLug; S1KNP: default: goto EMgZF; LcHZP: BizException::throwsIfEmpty('PayTypeProviderEmpty - ' . $l9M__, $qhOVL); goto AX7T_; AX7T_: return $qhOVL->onReturn($l9M__, $bz1sB->all()); goto RBgKG; EMgZF: $qhOVL = PayCenterProvider::get($l9M__); goto LcHZP; RBgKG: } } }