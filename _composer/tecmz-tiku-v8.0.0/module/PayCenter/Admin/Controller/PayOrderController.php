<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\PayCenter\Admin\Controller; use Illuminate\Routing\Controller; use Illuminate\Support\Facades\Log; use ModStart\Admin\Auth\AdminPermission; use ModStart\Admin\Concern\HasAdminQuickCRUD; use ModStart\Admin\Layout\AdminCRUDBuilder; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Response; use ModStart\Core\Util\CRUDUtil; use ModStart\Core\Util\EventUtil; use ModStart\Grid\Displayer\ItemOperate; use ModStart\Grid\GridFilter; use ModStart\Support\Concern\HasFields; use ModStart\Widget\TextAjaxRequest; use Module\PayCenter\Biz\PayCenterBiz; use Module\PayCenter\Events\OrderPayedEvent; use Module\PayCenter\Type\PayOrderStatus; use Module\PayCenter\Type\PayType; class PayOrderController extends Controller { use HasAdminQuickCRUD; protected function crud(AdminCRUDBuilder $cv5kq) { $cv5kq->init('pay_order')->field(function ($cv5kq) { $cv5kq->id('id', '结算单号'); $cv5kq->select('biz', '业务')->options(PayCenterBiz::allMap()); $cv5kq->text('bizId', '业务ID'); $cv5kq->type('status', '状态')->type(PayOrderStatus::class); $cv5kq->type('payType', '支付类型')->type(PayType::class); $cv5kq->currency('feeTotal', '金额'); $cv5kq->text('body', '内容'); $cv5kq->display('created_at', L('Created At')); $cv5kq->display('updated_at', L('Updated At'))->listable(false); })->gridFilter(function (GridFilter $qM7YH) { $qM7YH->eq('id', '支付ID'); $qM7YH->eq('biz', '业务')->select(PayCenterBiz::allMap()); $qM7YH->eq('status', '状态')->select(PayOrderStatus::class); $qM7YH->eq('payType', '支付类型')->select(PayType::class); })->operateFixed('right')->hookItemOperateRendering(function (ItemOperate $gs6sD) { $REa1I = $gs6sD->item(); switch ($REa1I->status) { case PayOrderStatus::PAYED: goto fw24i; fw24i: $gs6sD->push(TextAjaxRequest::danger('手动退款', action('\\' . __CLASS__ . '@refund', array('_id' => $REa1I->id)), '确定退款（需要线下人工处理）？')); goto PC5no; PC5no: if (!$REa1I->eventNotified) { $gs6sD->push(TextAjaxRequest::danger('重新触发事件', action('\\' . __CLASS__ . '@fireEvent', array('_id' => $REa1I->id)), '确定重新触发支付？')); } goto G02fG; G02fG: break; goto dyp9n; dyp9n: } })->disableCUD()->title('所有订单'); } public function refund() { goto J5irC; mKSwi: BizException::throwsIfEmpty('订单不存在', $IfVKl); goto am5ZP; Yswz2: $wa91I = CRUDUtil::id(); goto KgX30; am5ZP: BizException::throwsIf('订单状态错误', $IfVKl['status'] != PayOrderStatus::PAYED); goto yP3yf; J5irC: AdminPermission::demoCheck(); goto Yswz2; yP3yf: ModelUtil::update('pay_order', $IfVKl['id'], array('status' => PayOrderStatus::REFUND_SUCCESS)); goto DTV7S; DTV7S: return Response::redirect(CRUDUtil::jsGridRefresh()); goto HaUo1; KgX30: $IfVKl = ModelUtil::get('pay_order', $wa91I); goto mKSwi; HaUo1: } public function fireEvent() { goto zn8v5; fCzem: BizException::throwsIfEmpty('订单不存在', $IfVKl); goto Mukji; Ih6Fa: EventUtil::fire($yY11E); goto Oesnx; kXCGV: $yY11E->order = $IfVKl; goto Ih6Fa; zn8v5: AdminPermission::demoCheck(); goto WBhAj; yDD1E: $yY11E = new OrderPayedEvent(); goto L_8xC; WBhAj: $wa91I = CRUDUtil::id(); goto w2GGf; dED3j: $yY11E->bizId = $IfVKl['bizId']; goto kXCGV; L_8xC: $yY11E->biz = $IfVKl['biz']; goto dED3j; Oesnx: Log::info('PayCenter.FireEventFromAdmin.OrderPayedEvent - ' . json_encode($yY11E, JSON_UNESCAPED_UNICODE)); goto hDf50; hDf50: ModelUtil::update('pay_order', $IfVKl['id'], array('eventNotified' => true)); goto JJIw0; w2GGf: $IfVKl = ModelUtil::get('pay_order', $wa91I); goto fCzem; JJIw0: return Response::redirect(CRUDUtil::jsGridRefresh()); goto HW9bn; Mukji: BizException::throwsIf('订单状态错误', $IfVKl['status'] != PayOrderStatus::PAYED); goto yDD1E; HW9bn: } }