<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Api\Controller; use Illuminate\Routing\Controller; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Response; use ModStart\Core\Type\TypeUtil; use Module\Member\Auth\MemberUser; use Module\Member\Support\MemberLoginCheck; use Module\Member\Type\MemberMoneyCashType; use Module\Member\Util\MemberMoneyUtil; class MemberMoneyCashController extends Controller implements MemberLoginCheck { public function get() { goto UnL1A; ILaRX: $Gd9xh = modstart_config('Member_MoneyCashMin', 100); goto cWZXJ; UnL1A: $GpKvi = MemberMoneyUtil::getTotal(MemberUser::id()); goto ILaRX; cWZXJ: return Response::generateSuccessData(array('total' => $GpKvi, 'desc' => modstart_config('Member_MoneyCashDescription'), 'min' => sprintf('%0.2f', $Gd9xh), 'rate' => modstart_config('Member_MoneyCashTaxRate', 0), 'types' => TypeUtil::dump(MemberMoneyCashType::class), 'canCash' => $GpKvi >= $Gd9xh, 'defaultType' => MemberMoneyCashType::ALIPAY)); goto VphJO; VphJO: } public function calc() { goto hjy29; ePb0t: if ($HWmk2 < modstart_config('Member_MoneyCashMin', 100)) { return Response::generateError('最小提现金额为' . modstart_config('Member_MoneyCashMin', 100)); } goto m6HKL; hjy29: $bz1sB = InputPackage::buildFromInput(); goto M4MeB; uDoyw: $tSmTq = modstart_config('Member_MoneyCashTaxRate', 0); goto o9iYy; K5RZY: return Response::generateSuccessData(array('value' => $WZC9G)); goto UYIh8; m6HKL: $GpKvi = MemberMoneyUtil::getTotal(MemberUser::id()); goto bKlEU; M4MeB: $HWmk2 = $bz1sB->getDecimal('money'); goto ePb0t; JUps4: $WZC9G = bcdiv(bcmul($HWmk2, $tSmTq, 2), 100, 2); goto K5RZY; bKlEU: if ($HWmk2 > $GpKvi) { return Response::generateError('余额不足'); } goto uDoyw; o9iYy: $tSmTq = 100 - min(max($tSmTq, 0), 99); goto JUps4; UYIh8: } public function submit() { goto WimUf; ilJS6: switch ($S3IJB) { case MemberMoneyCashType::ALIPAY: goto SFXFe; Sxc9d: if (empty($SscAH)) { return Response::generate(-1, '支付宝姓名不能为空'); } goto UhaGF; SFXFe: $SscAH = $bz1sB->getTrimString('alipayRealname'); goto PIf1n; PIf1n: $U6A53 = $bz1sB->getTrimString('alipayAccount'); goto Sxc9d; UhaGF: if (empty($U6A53)) { return Response::generate(-1, '支付宝账号不能为空'); } goto RtkYo; RtkYo: break; goto anEvj; anEvj: default: return Response::generateError('支付类型错误'); } goto U9e4D; agyqn: $eINWC = bcdiv(bcmul($HWmk2, $tSmTq, 2), 100, 2); goto nfLCY; Wv0h7: $tSmTq = modstart_config('Member_MoneyCashTaxRate', 0); goto xBNAt; nfLCY: try { goto lCAVu; lCAVu: ModelUtil::transactionBegin(); goto wH4nB; wsvAQ: ModelUtil::transactionCommit(); goto fJYJJ; wH4nB: MemberMoneyUtil::cash(MemberUser::id(), $HWmk2, $eINWC, MemberMoneyCashType::ALIPAY, $SscAH, $U6A53); goto wsvAQ; fJYJJ: } catch (\Exception $knlzD) { ModelUtil::transactionRollback(); throw $knlzD; } goto x5r3E; aBFbE: if ($HWmk2 < modstart_config('Member_MoneyCashMin', 100)) { return Response::generate(-1, '提现金额至少为' . modstart_config('Member_MoneyCashMin', 100)); } goto uNRL9; xBNAt: $tSmTq = 100 - min(max($tSmTq, 0), 99); goto agyqn; U9e4D: $GpKvi = MemberMoneyUtil::getTotal(MemberUser::id()); goto Zg25h; Zg25h: if ($GpKvi < modstart_config('Member_MoneyCashMin', 100)) { return Response::generate(-1, '当前账户余额不满' . modstart_config('Member_MoneyCashMin', 100) . ',不能提现'); } goto Wv0h7; uNRL9: $S3IJB = $bz1sB->getType('type', MemberMoneyCashType::class); goto ilJS6; UK1gi: $bz1sB = InputPackage::buildFromInput(); goto gN7q2; x5r3E: return Response::generate(0, '提交成功', null, modstart_web_url('member_money/cash/log')); goto r37eD; WimUf: if (!modstart_config('Member_MoneyCashEnable', false)) { return Response::generateError('功能未开启'); } goto UK1gi; ThPoC: if ($HWmk2 < 0.01) { return Response::generate(-1, '提现金额不能为空'); } goto aBFbE; gN7q2: $HWmk2 = $bz1sB->getDecimal('money'); goto ThPoC; r37eD: } public function log() { goto xhBEe; xhBEe: $bz1sB = InputPackage::buildFromInput(); goto WJxFw; x8GZB: return Response::generateSuccessPaginate($bz1sB->getPage(), $bz1sB->getPageSize(), $BfEFC); goto tSwVr; WJxFw: $InfBU = array(); goto xbSZq; xbSZq: $BfEFC = MemberMoneyUtil::paginateCash(MemberUser::id(), $bz1sB->getPage(), $bz1sB->getPageSize(), $InfBU); goto x8GZB; tSwVr: } }