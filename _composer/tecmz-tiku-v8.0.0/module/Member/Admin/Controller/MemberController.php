<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Admin\Controller; use Illuminate\Routing\Controller; use ModStart\Admin\Auth\AdminPermission; use ModStart\Admin\Concern\HasAdminQuickCRUD; use ModStart\Admin\Layout\AdminConfigBuilder; use ModStart\Admin\Layout\AdminCRUDBuilder; use ModStart\Admin\Layout\AdminDialogPage; use ModStart\Core\Assets\AssetsUtil; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Core\Type\TypeUtil; use ModStart\Core\Util\ArrayUtil; use ModStart\Core\Util\ColorUtil; use ModStart\Core\Util\CRUDUtil; use ModStart\Core\Util\EventUtil; use ModStart\Core\Util\RandomUtil; use ModStart\Core\Util\TimeUtil; use ModStart\Field\AbstractField; use ModStart\Field\AutoRenderedFieldValue; use ModStart\Field\Type\FieldRenderMode; use ModStart\Form\Form; use ModStart\Grid\Displayer\ItemOperate; use ModStart\Grid\GridFilter; use ModStart\Module\ModuleManager; use ModStart\Repository\Filter\RepositoryFilter; use ModStart\Support\Concern\HasFields; use ModStart\Widget\TextDialogRequest; use Module\Member\Config\MemberAdminList; use Module\Member\Config\MemberOauth; use Module\Member\Events\MemberUserRegisteredEvent; use Module\Member\Provider\MemberAdminShowPanel\MemberAdminShowPanelProvider; use Module\Member\Type\Gender; use Module\Member\Type\MemberStatus; use Module\Member\Util\MemberGroupUtil; use Module\Member\Util\MemberMessageUtil; use Module\Member\Util\MemberUtil; use Module\Member\Util\MemberVipUtil; use Module\Vendor\QuickRun\Export\ExportHandle; class MemberController extends Controller { use HasAdminQuickCRUD; protected function crud(AdminCRUDBuilder $cv5kq) { $cv5kq->init('member_user')->field(function ($cv5kq) { $cv5kq->id('id', 'ID'); MemberAdminList::callGridField($cv5kq); $cv5kq->display('avatar', '头像')->hookRendering(function (AbstractField $QGYmu, $REa1I, $x1Lvn) { $PWKxK = AssetsUtil::fixOrDefault($REa1I->avatar, 'asset/image/avatar.svg'); $nhpnc = AssetsUtil::fixOrDefault($REa1I->avatarBig, 'asset/image/avatar.svg'); return AutoRenderedFieldValue::make("<a href='{$nhpnc}' class='tw-inline-block' data-image-preview>\n                        <img src='{$PWKxK}' class='tw-rounded-full tw-w-8 tw-h-8 tw-shadow'></a>"); }); $cv5kq->text('username', '用户名')->required()->ruleUnique('member_user')->hookRendering(function (AbstractField $QGYmu, $REa1I, $x1Lvn) { switch ($QGYmu->renderMode()) { case FieldRenderMode::GRID: case FieldRenderMode::DETAIL: return AutoRenderedFieldValue::make(TextDialogRequest::make('primary', htmlspecialchars($REa1I->username), modstart_admin_url('member/show', array('_id' => $REa1I->id)))->width('90%')->height('90%')->render()); break; } }); $cv5kq->text('email', '邮箱'); $cv5kq->text('phone', '手机'); $cv5kq->text('nickname', '昵称'); if (MemberOauth::hasEnableItems()) { $cv5kq->display('_oauth', '授权')->hookRendering(function (AbstractField $QGYmu, $REa1I, $x1Lvn) { $NZp5a = array(); $FaM3m = MemberUtil::listOauths($REa1I->id); foreach ($FaM3m as $T2tD4) { goto DWNc8; DWNc8: $WSsZd = null; goto p1hw4; WLcKn: if (empty($WSsZd)) { $WSsZd = ColorUtil::pick($T2tD4['type']); } goto FER2U; vxN42: $wyN7g = MemberOauth::getByOauthKey($T2tD4['type']); goto XRcMk; FER2U: $NZp5a[] = '<a style="color:' . $WSsZd . ';" href="javascript:;" data-tip-popover="' . $jTNJC . '"><i class="iconfont icon-dot"></i></a>'; goto G6ygx; p1hw4: $jTNJC = $T2tD4['type']; goto vxN42; XRcMk: if ($wyN7g) { $WSsZd = $wyN7g->color(); $jTNJC = $wyN7g->title(); } goto WLcKn; G6ygx: } return join('', $NZp5a); }); } $cv5kq->type('status', '状态')->type(MemberStatus::class, array(MemberStatus::NORMAL => 'success', MemberStatus::FORBIDDEN => 'danger'))->required(); if (ModuleManager::getModuleConfigBoolean('Member', 'groupEnable', false)) { $cv5kq->radio('groupId', '分组')->options(MemberGroupUtil::mapIdTitle())->required(); } if (ModuleManager::getModuleConfigBoolean('Member', 'vipEnable', false)) { $cv5kq->radio('vipId', 'VIP')->options(MemberVipUtil::mapTitle())->required(); $cv5kq->date('vipExpire', 'VIP过期'); } $cv5kq->display('registerIp', '注册IP'); $cv5kq->display('created_at', '注册时间'); $cv5kq->canBatchSelect(true); $cv5kq->batchOperatePrepend('<button class="btn" data-batch-confirm="确认禁用 %d 个用户？" data-batch-operate="' . modstart_admin_url('member/status_forbidden') . '"><i class="iconfont icon-warning"></i> 禁用</button>'); })->repositoryFilter(function (RepositoryFilter $qM7YH) { $qM7YH->where(array('isDeleted' => false)); })->gridFilter(function (GridFilter $qM7YH) { $qM7YH->eq('id', L('ID')); $qM7YH->like('username', '用户名'); $qM7YH->like('email', '邮箱')->autoHide(true); $qM7YH->like('phone', '手机')->autoHide(true); $qM7YH->eq('status', '状态')->autoHide(true)->select(MemberStatus::class); if (ModuleManager::getModuleConfigBoolean('Member', 'groupEnable', false)) { $qM7YH->eq('groupId', '分组')->autoHide(true)->select(MemberGroupUtil::mapIdTitle()); } if (ModuleManager::getModuleConfigBoolean('Member', 'vipEnable', false)) { $qM7YH->eq('vipId', 'VIP')->autoHide(true)->select(MemberVipUtil::mapTitle()); } })->operateFixed('right')->hookItemOperateRendering(function (ItemOperate $gs6sD) { $REa1I = $gs6sD->item(); $gs6sD->prepend(TextDialogRequest::make('primary', '用户信息', modstart_admin_url('member/show', array('_id' => $REa1I->id)))->width('90%')->height('90%')->render()); })->title('用户管理')->canShow(false)->canDelete(true)->canExport(ModuleManager::getModuleConfigBoolean('Member', 'exportEnable'))->textEdit('修改账号'); } public function add(AdminDialogPage $gETpv) { goto B_0ME; pNFaa: $Yfg4L->layoutPanel('基础（用户、手机、邮箱不能同时为空）', function (Form $Yfg4L) { $Yfg4L->text('username', '用户名'); $Yfg4L->text('phone', '手机'); $Yfg4L->text('email', '邮箱'); $Yfg4L->text('password', '初始密码')->defaultValue(RandomUtil::lowerString(8)); }); goto kUU6q; B_0ME: $Yfg4L = Form::make(''); goto pNFaa; G6aQq: $Yfg4L->showSubmit(false)->showReset(false); goto rjkSP; rjkSP: return $gETpv->pageTitle('创建用户')->body($Yfg4L)->handleForm($Yfg4L, function (Form $Yfg4L) { AdminPermission::demoCheck(); $GeXSC = $Yfg4L->dataForming(); $eM5tA = $GeXSC['username'] ? $GeXSC['username'] : null; $deRjP = $GeXSC['phone'] ? $GeXSC['phone'] : null; $ZYL8t = $GeXSC['email'] ? $GeXSC['email'] : null; $Qk0KA = ArrayUtil::keepKeys($GeXSC, array('nickname', 'groupId', 'status', 'vipId', 'vipExpire')); $BEdDh = MemberUtil::register($eM5tA, $deRjP, $ZYL8t, $GeXSC['password']); BizException::throwsIfResponseError($BEdDh); if (!empty($Qk0KA)) { if (isset($Qk0KA['vipExpire']) && TimeUtil::isDateEmpty($Qk0KA['vipExpire'])) { $Qk0KA['vipExpire'] = null; } MemberUtil::update($BEdDh['data']['id'], $Qk0KA); } EventUtil::fire(new MemberUserRegisteredEvent($BEdDh['data']['id'])); return Response::redirect(CRUDUtil::jsDialogCloseAndParentGridRefresh()); }); goto w0cNU; kUU6q: $Yfg4L->layoutPanel('高级', function (Form $Yfg4L) { $Yfg4L->text('nickname', '昵称'); $Yfg4L->radio('status', '状态')->optionType(MemberStatus::class)->defaultValue(MemberStatus::NORMAL); if (ModuleManager::getModuleConfigBoolean('Member', 'groupEnable', false)) { $Yfg4L->radio('groupId', '分组')->options(MemberGroupUtil::mapIdTitle())->required(); } if (ModuleManager::getModuleConfigBoolean('Member', 'vipEnable', false)) { $Yfg4L->radio('vipId', 'VIP')->options(MemberVipUtil::mapTitle())->required(); $Yfg4L->date('vipExpire', 'VIP过期'); } }); goto G6aQq; w0cNU: } public function edit(AdminDialogPage $gETpv) { goto yXEP9; V1slC: $Yfg4L->layoutPanel('高级', function (Form $Yfg4L) { $Yfg4L->text('nickname', '昵称'); $Yfg4L->radio('status', '状态')->optionType(MemberStatus::class)->defaultValue(MemberStatus::NORMAL); if (ModuleManager::getModuleConfigBoolean('Member', 'groupEnable', false)) { $Yfg4L->radio('groupId', '分组')->options(MemberGroupUtil::mapIdTitle())->required(); } if (ModuleManager::getModuleConfigBoolean('Member', 'vipEnable', false)) { $Yfg4L->radio('vipId', 'VIP')->options(MemberVipUtil::mapTitle())->required(); $Yfg4L->date('vipExpire', 'VIP过期')->help('VIP过期留空表示永久'); } }); goto zfEvK; yXEP9: $w45m7 = ModelUtil::get('member_user', CRUDUtil::id()); goto JYyUA; YsahD: if (Request::isPost()) { goto siAeW; siAeW: AdminPermission::demoCheck(); goto SYWsE; JarMZ: switch ($bz1sB->getTrimString('_action')) { case 'itemCellEdit': goto mFADh; zBZzs: return Response::generateSuccess(); goto vnE4H; clad8: switch ($bz1sB->getTrimString('column')) { case 'status': $tcTgP['status'] = $bz1sB->getInteger('value'); break; } goto tDl4i; mFADh: $tcTgP = array(); goto clad8; tDl4i: if (!empty($tcTgP)) { MemberUtil::update($w45m7['id'], $tcTgP); } goto zBZzs; vnE4H: } goto eFg89; SYWsE: $bz1sB = InputPackage::buildFromInput(); goto JarMZ; eFg89: } goto W2TVs; zfEvK: $Yfg4L->item($w45m7)->fillFields(); goto IjF7C; IjF7C: $Yfg4L->showSubmit(false)->showReset(false); goto iE0KF; low6S: $Yfg4L->layoutPanel('基础', function (Form $Yfg4L) { $Yfg4L->display('id', '用户ID')->addable(true); $Yfg4L->text('username', '用户名'); $Yfg4L->text('phone', '手机'); $Yfg4L->text('email', '邮箱'); }); goto V1slC; JYyUA: BizException::throwsIfEmpty('用户不存在', $w45m7); goto YsahD; iE0KF: return $gETpv->pageTitle('创建用户')->body($Yfg4L)->handleForm($Yfg4L, function (Form $Yfg4L) use($w45m7) { AdminPermission::demoCheck(); $GeXSC = $Yfg4L->dataForming(); $mTw11 = ArrayUtil::keepKeys($GeXSC, array('username', 'phone', 'email')); $Qk0KA = ArrayUtil::keepKeys($GeXSC, array('nickname', 'groupId', 'status', 'vipId', 'vipExpire')); $BEdDh = MemberUtil::updateBasicWithUniqueCheck($w45m7['id'], $mTw11); BizException::throwsIfResponseError($BEdDh); if (isset($Qk0KA['vipExpire']) && TimeUtil::isDateEmpty($Qk0KA['vipExpire'])) { $Qk0KA['vipExpire'] = null; } MemberUtil::update($w45m7['id'], $Qk0KA); return Response::redirect(CRUDUtil::jsDialogCloseAndParentGridRefresh()); }); goto UQhLy; W2TVs: $Yfg4L = Form::make(''); goto low6S; UQhLy: } public function select(AdminDialogPage $gETpv) { goto TV5Dr; TV5Dr: $rWlsS = $this->grid(); goto aiXOO; sHGhP: return $gETpv->pageTitle('选择用户')->body($rWlsS); goto WGB90; gqdZq: CRUDUtil::registerGridResource($rWlsS, '\\' . __CLASS__); goto Ktb3a; aiXOO: $rWlsS->disableCUD(); goto DOyVx; Ktb3a: if (Request::isPost()) { return $rWlsS->request(); } goto sHGhP; DOyVx: $rWlsS->canSingleSelectItem(true); goto gqdZq; WGB90: } public function search() { goto kB9o3; RqTrZ: $v39Ud = array_map(function ($REa1I) { return array('value' => intval($REa1I['id']), 'name' => htmlspecialchars(MemberUtil::viewName($REa1I)), 'avatar' => AssetsUtil::fixOrDefault($REa1I['avatar'], 'asset/image/avatar.svg')); }, $BfEFC['records']); goto Xhx0k; FW7O8: $BfEFC = MemberUtil::paginate(1, 10, $InfBU); goto RqTrZ; H203s: $InfBU = array(); goto mmY8c; Xhx0k: return Response::jsonSuccessData($v39Ud); goto Cw48d; mmY8c: $InfBU['whereOperate'] = array('username', 'like', "%{$TO6f4}%"); goto FW7O8; LEo7C: $TO6f4 = $bz1sB->getTrimString('keywords'); goto H203s; kB9o3: $bz1sB = InputPackage::buildFromInput(); goto LEo7C; Cw48d: } public function resetPassword(AdminConfigBuilder $cv5kq) { goto VYhP7; ARSCB: return $cv5kq; goto z76kE; oyCe4: $w45m7 = MemberUtil::get($wa91I); goto nbbjE; nbbjE: BizException::throwsIfEmpty('用户不存在', $w45m7); goto pOAp7; VYhP7: $wa91I = CRUDUtil::id(); goto oyCe4; pOAp7: $cv5kq->useDialog(); goto rEywv; HJLKV: $cv5kq->text('passwordNew', '新密码')->required()->defaultValue(RandomUtil::upperString(6)); goto SAjKx; rEywv: $cv5kq->pageTitle('重置密码'); goto HJLKV; SAjKx: if (Request::isPost()) { return $cv5kq->formRequest(function (Form $Yfg4L) use($w45m7) { AdminPermission::demoCheck(); $GeXSC = $Yfg4L->dataForming(); $BEdDh = MemberUtil::changePassword($w45m7['id'], $GeXSC['passwordNew'], null, true); BizException::throwsIfResponseError($BEdDh); return Response::redirect(CRUDUtil::jsDialogClose()); }); } goto ARSCB; z76kE: } public function sendMessage(AdminConfigBuilder $cv5kq) { goto U2QuI; Q9SCY: BizException::throwsIfEmpty('用户不存在', $w45m7); goto dZ_p9; v4HWY: $cv5kq->richHtml('content', '消息内容')->required(); goto htoKU; htoKU: if (Request::isPost()) { return $cv5kq->formRequest(function (Form $Yfg4L) use($w45m7) { AdminPermission::demoCheck(); $GeXSC = $Yfg4L->dataForming(); $BEdDh = MemberMessageUtil::send($w45m7['id'], $GeXSC['content']); BizException::throwsIfResponseError($BEdDh); return Response::redirect(CRUDUtil::jsDialogClose()); }); } goto H4t92; H4t92: return $cv5kq; goto MCg0U; Ip_tE: $w45m7 = MemberUtil::get($wa91I); goto Q9SCY; U2QuI: $wa91I = CRUDUtil::id(); goto Ip_tE; dZ_p9: $cv5kq->useDialog(); goto xTKkh; xTKkh: $cv5kq->pageTitle('发送消息'); goto v4HWY; MCg0U: } public function show() { goto hE2UN; oedbQ: return view('module::Member.View.admin.memberUser.show', array('record' => $NZ_6d, 'showPanelProviders' => $Xpsde)); goto p78U3; hE2UN: $NZ_6d = MemberUtil::get(CRUDUtil::id()); goto G3tRm; G3tRm: $Xpsde = MemberAdminShowPanelProvider::listAll(); goto oedbQ; p78U3: } public function delete() { goto e_gU2; e_gU2: AdminPermission::demoCheck(); goto AQdS6; AQdS6: MemberUtil::delete(CRUDUtil::id()); goto swJuo; swJuo: return Response::redirect(CRUDUtil::jsGridRefresh()); goto FWWvT; FWWvT: } public function statusForbidden() { goto TODmx; kfV_0: MemberUtil::updateStatus(CRUDUtil::ids(), MemberStatus::FORBIDDEN); goto ch6B0; TODmx: AdminPermission::demoCheck(); goto kfV_0; ch6B0: return Response::redirect(CRUDUtil::jsGridRefresh()); goto BLlVq; BLlVq: } public function export(ExportHandle $MV9do) { $sHr3L = array('ID', '用户名', '邮箱', '手机', '注册时间', '性别', '姓名', '签名'); return $MV9do->withPageTitle('导出用户信息')->withDefaultExportName('用户信息')->withHeadTitles($sHr3L)->handleFetch(function ($gETpv, $Wo30p, $UIWVa, $oG0tD) { $JtdAh = ModelUtil::model('member_user'); $JtdAh = $JtdAh->where(array('isDeleted' => false))->orderBy('id', 'desc'); foreach ($UIWVa as $ddgPr) { if (!empty($ddgPr['id']['eq'])) { $JtdAh = $JtdAh->where('id', $ddgPr['id']['eq']); } elseif (!empty($ddgPr['status']['eq'])) { $JtdAh = $JtdAh->where('status', $ddgPr['status']['eq']); } elseif (!empty($ddgPr['groupId']['eq'])) { $JtdAh = $JtdAh->where('groupId', $ddgPr['groupId']['eq']); } elseif (!empty($ddgPr['vipId']['eq'])) { $JtdAh = $JtdAh->where('vipId', $ddgPr['vipId']['eq']); } elseif (!empty($ddgPr['username']['like'])) { $JtdAh = $JtdAh->where('username', 'like', '%' . $ddgPr['username']['like'] . '%'); } elseif (!empty($ddgPr['email']['like'])) { $JtdAh = $JtdAh->where('email', 'like', '%' . $ddgPr['email']['like'] . '%'); } elseif (!empty($ddgPr['phone']['like'])) { $JtdAh = $JtdAh->where('phone', 'like', '%' . $ddgPr['phone']['like'] . '%'); } } $hlYz_ = $JtdAh->paginate($Wo30p, array('*'), 'page', $gETpv)->toArray(); $x6JEB = array(); foreach ($hlYz_['data'] as $REa1I) { goto RRHIO; TDmBc: $AIK5r[] = $REa1I['username']; goto FicXO; hPRZA: $AIK5r[] = $REa1I['signature']; goto JDs4i; RRHIO: $AIK5r = array(); goto tgp0a; tgp0a: $AIK5r[] = $REa1I['id']; goto TDmBc; IQO_V: $AIK5r[] = TypeUtil::name(Gender::class, $REa1I['gender']); goto rRFv3; FicXO: $AIK5r[] = $REa1I['email']; goto LeHMt; LeHMt: $AIK5r[] = $REa1I['phone']; goto FRpqg; JDs4i: $x6JEB[] = $AIK5r; goto lNSqt; rRFv3: $AIK5r[] = $REa1I['realname']; goto hPRZA; FRpqg: $AIK5r[] = $REa1I['created_at']; goto IQO_V; lNSqt: } return array('list' => $x6JEB, 'total' => $hlYz_['total']); })->performCommon(); } }