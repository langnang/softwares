<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Util; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Input\Response; use ModStart\Module\ModuleManager; use Module\Vendor\Cache\CacheUtil; class MemberVipUtil { public static function isEnable() { return ModuleManager::getModuleConfigBoolean('Member', 'vipEnable'); } public static function all() { return CacheUtil::rememberForever('MemberVipList', function () { return ModelUtil::all('member_vip_set', array(), array('*'), array('sort', 'asc')); }); } public static function update($wa91I, $GeXSC) { ModelUtil::update('member_vip_set', $wa91I, $GeXSC); self::clearCache(); } public static function map() { return CacheUtil::rememberForever('MemberVipMap', function () { $TbleL = array(); foreach (ModelUtil::all('member_vip_set', array(), array('*'), array('sort', 'asc')) as $REa1I) { $TbleL[intval($REa1I['id'])] = $REa1I; } return $TbleL; }); } public static function vipsByIds($G34RV) { goto USy18; USy18: $TbleL = self::map(); goto ZZycf; Hg2jf: foreach ($G34RV as $v0rpv) { if (isset($TbleL[$v0rpv])) { $zJeQE[] = $TbleL[$v0rpv]; } } goto LIz2X; LIz2X: return $zJeQE; goto NN7eg; ZZycf: $zJeQE = array(); goto Hg2jf; NN7eg: } public static function mapTitle() { return array_build(self::map(), function ($nJFbs, $NIxlc) { return array($nJFbs, $NIxlc['title']); }); } public static function getMemberVipById($MqkYF, $Mlv3V = null, $z5iar = null) { $w45m7 = MemberUtil::get($MqkYF); return self::getMemberVip($w45m7, $Mlv3V, $z5iar); } public static function getMemberVipByIdCached($MqkYF, $Mlv3V = null, $z5iar = null) { $w45m7 = MemberUtil::getCached($MqkYF); return self::getMemberVip($w45m7, $Mlv3V, $z5iar); } public static function getMemberVip($w45m7, $Mlv3V = null, $z5iar = null) { goto Xx94b; FPHL5: return isset($ZwEYi[$Mlv3V]) ? $ZwEYi[$Mlv3V] : $z5iar; goto m_MJH; Ry7ns: if (empty($ZwEYi)) { return null; } goto rWy2H; rWy2H: if (null === $Mlv3V) { return $ZwEYi; } goto FPHL5; Xx94b: if (!empty($w45m7['vipId']) && (empty($w45m7['vipExpire']) || strtotime($w45m7['vipExpire']) > time())) { $ZwEYi = self::get($w45m7['vipId']); } else { $ZwEYi = self::get(null); } goto Ry7ns; m_MJH: } public static function getDefaultVip() { foreach (self::map() as $v0rpv => $ZwEYi) { if (!empty($ZwEYi['isDefault'])) { return $ZwEYi; } } return null; } public static function get($v0rpv, $Mlv3V = null) { goto JWyqw; wmejB: if (null === $Mlv3V) { if (isset($TbleL[$v0rpv])) { return $TbleL[$v0rpv]; } return self::getDefaultVip(); } else { goto uw91m; ySHRw: $ZwEYi = self::getDefaultVip(); goto G5VR9; G5VR9: if (isset($ZwEYi[$Mlv3V])) { return $ZwEYi[$Mlv3V]; } goto aXnpb; uw91m: if (isset($TbleL[$v0rpv][$Mlv3V])) { return $TbleL[$v0rpv][$Mlv3V]; } goto ySHRw; aXnpb: } goto xCJyi; JWyqw: $TbleL = self::map(); goto wmejB; xCJyi: return null; goto wrCS3; wrCS3: } public static function calcPrice($qQkV0, $im92q, $S6yHO) { goto iBZAR; Fkor1: $fIp7f = 0; goto HaCUE; vOQE0: return Response::generate(0, 'ok', array('type' => $S3IJB, 'expire' => $B2WWU, 'price' => $fIp7f)); goto S8llw; Sybx1: $nehYE = $LXytS ? $LXytS['vipDays'] : 0; goto ZOm6q; HaCUE: $S3IJB = null; goto y7hmj; iBZAR: $zddc1 = self::get($qQkV0); goto Y4Sfq; HUhhV: $LXytS = self::get($S6yHO); goto rhDTc; Y4Sfq: $WgxSs = $zddc1 ? $zddc1['price'] : 0; goto f0STB; kKNwE: $mGti9 = strtotime($im92q) > 0 ? strtotime($im92q) : 0; goto fd76B; rhDTc: $ttU_b = $LXytS ? $LXytS['price'] : 0; goto Sybx1; f0STB: $jQMYS = $zddc1 ? $zddc1['vipDays'] : 0; goto HUhhV; y7hmj: if ($qQkV0 == $S6yHO) { goto Ho3Lj; zwRGE: $fIp7f = $LXytS['price']; goto Kh8R0; Ho3Lj: $S3IJB = '续费会员'; goto QgG6z; QgG6z: $B2WWU = date('Y-m-d', max($mGti9, time()) + $LXytS['vipDays'] * 24 * 3600); goto zwRGE; Kh8R0: } else { if ($mGti9 > 0) { goto r4x7t; EkMdn: $mTJq6 = $zddc1['vipDays']; goto w0Ezl; w0Ezl: $stnFc = $mTJq6 > 0 ? $zddc1['price'] * $BkuPz / $mTJq6 : 0; goto GYjG1; QmSw4: $fIp7f = $LXytS['price'] * (($CjHJg - time()) / (24 * 3600)) / $LXytS['vipDays']; goto G4peJ; r4x7t: $S3IJB = '变更会员'; goto FLtAz; GYjG1: $fIp7f = max(bcsub($fIp7f, $stnFc, 2), 0.01); goto F6riI; FLtAz: $CjHJg = max(time() + $LXytS['vipDays'] * 24 * 3600, $mGti9); goto BJMbR; BJMbR: $B2WWU = date('Y-m-d', $CjHJg); goto QmSw4; G4peJ: $BkuPz = max(0, intval(($mGti9 - time()) / (24 * 3600))); goto EkMdn; F6riI: } else { goto GS1Uc; dC2hC: $fIp7f = $LXytS['price']; goto drjq6; GS1Uc: $S3IJB = '新开会员'; goto LrRfw; LrRfw: $B2WWU = date('Y-m-d', time() + $LXytS['vipDays'] * 24 * 3600); goto dC2hC; drjq6: } } goto vOQE0; ZOm6q: if (empty($LXytS)) { return Response::generate(-1, '数据错误'); } goto kKNwE; fd76B: $B2WWU = null; goto Fkor1; S8llw: } public static function clearCache() { CacheUtil::forget('MemberVipList'); CacheUtil::forget('MemberVipMap'); } }