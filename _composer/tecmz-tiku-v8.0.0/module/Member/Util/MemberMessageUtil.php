<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Util; use Illuminate\Support\Facades\View; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Response; use Module\Member\Type\MemberMessageStatus; class MemberMessageUtil { public static function getUnreadMessageCount($qpQex) { if (empty($qpQex)) { return 0; } return ModelUtil::count('member_message', array('userId' => $qpQex, 'status' => MemberMessageStatus::UNREAD)); } public static function setMemberMessageRead($qpQex, $Da1nS = array()) { goto pEtI6; nwPf2: ModelUtil::model('member_message')->where(array('userId' => $qpQex))->whereIn('id', $Da1nS)->update(array('status' => MemberMessageStatus::READ)); goto aH9Cq; pEtI6: if (empty($Da1nS)) { return; } goto nwPf2; aH9Cq: foreach ($Da1nS as $wa91I) { self::updateMessageCount($wa91I); } goto lSNZ8; lSNZ8: } public function setMemberMessageReadAll($qpQex) { ModelUtil::model('member_message')->where(array('userId' => $qpQex))->update(array('status' => MemberMessageStatus::READ)); self::updateMessageCount($qpQex); } public static function updateMessageCount($qpQex) { MemberUtil::update($qpQex, array('messageCount' => self::getUnreadMessageCount($qpQex))); } public static function paginate($qpQex, $gETpv, $Wo30p, $InfBU = array()) { goto TOLly; ojfaU: foreach ($BfEFC['records'] as $NZ_6d) { goto THa3M; THa3M: $REa1I = array(); goto bvfvc; c6pHM: $REa1I['content'] = $NZ_6d['content']; goto cL8vc; bvfvc: $REa1I['id'] = $NZ_6d['id']; goto Wk36g; cL8vc: $REa1I['createTime'] = $NZ_6d['created_at']; goto tFes3; tFes3: $v39Ud[] = $REa1I; goto fCRJ2; JPcCP: $REa1I['fromId'] = $NZ_6d['fromId']; goto c6pHM; Wk36g: $REa1I['status'] = $NZ_6d['status']; goto JPcCP; fCRJ2: } goto u7ET9; TOLly: $InfBU['where']['userId'] = $qpQex; goto CGkXm; CGkXm: $BfEFC = ModelUtil::paginate('member_message', $gETpv, $Wo30p, $InfBU); goto Xn1qK; Xn1qK: $v39Ud = array(); goto ojfaU; u7ET9: return array('records' => $v39Ud, 'total' => $BfEFC['total']); goto ETjTR; ETjTR: } public static function delete($qpQex, $Da1nS = array()) { goto y09xo; R2tqd: if (!is_array($Da1nS)) { $Da1nS = array($Da1nS); } goto laujf; y09xo: if (empty($Da1nS)) { return; } goto R2tqd; CR7iS: self::updateMessageCount($qpQex); goto SXa7p; laujf: ModelUtil::model('member_message')->whereIn('id', $Da1nS)->where(array('userId' => $qpQex))->delete(); goto CR7iS; SXa7p: } public static function deleteAll($qpQex) { ModelUtil::model('member_message')->where(array('userId' => $qpQex))->delete(); self::updateMessageCount($qpQex); } public static function update($qpQex, $Da1nS = array(), $tcTgP = array()) { goto wmk6P; wmk6P: if (empty($Da1nS) || empty($tcTgP)) { return; } goto HvUoG; HvUoG: if (!is_array($Da1nS)) { $Da1nS = array($Da1nS); } goto TPPe9; TPPe9: ModelUtil::model('member_message')->whereIn('id', $Da1nS)->where(array('userId' => $qpQex))->update($tcTgP); goto eHQwZ; eHQwZ: self::updateMessageCount($qpQex); goto NjoMH; NjoMH: } public static function updateRead($qpQex, $Da1nS = array()) { self::update($qpQex, $Da1nS, array('status' => MemberMessageStatus::READ)); self::updateMessageCount($qpQex); } public static function updateReadAll($qpQex) { ModelUtil::model('member_message')->where(array('userId' => $qpQex))->update(array('status' => MemberMessageStatus::READ)); self::updateMessageCount($qpQex); } public static function send($qpQex, $KqFED, $NrE6Q = 0) { goto IWB0b; PZXO3: return Response::generate(0, null); goto ijB7e; Xg7hD: self::updateMessageCount($qpQex); goto PZXO3; IWB0b: ModelUtil::insert('member_message', array('userId' => $qpQex, 'fromId' => $NrE6Q, 'status' => MemberMessageStatus::UNREAD, 'content' => $KqFED)); goto Xg7hD; ijB7e: } public static function sendTemplate($MqkYF, $BEHqT, $sPK8A = array(), $dxx1X = 0, $FgRrl = null) { goto cutmo; Iud78: if (!view()->exists($Mi0Iq)) { BizException::throws(L('View Not Found : %s', $BEHqT)); } goto P0yKL; FkP6s: self::send($MqkYF, $O04Zr, $dxx1X); goto dlVUN; P0yKL: $O04Zr = View::make($Mi0Iq, $sPK8A)->render(); goto FkP6s; sx2Fu: $Mi0Iq = 'theme.' . $HWQQV . '.message.' . $BEHqT; goto Iinf4; cutmo: $HWQQV = modstart_config()->getWithEnv('siteTemplate', 'default'); goto sx2Fu; Iinf4: if (!view()->exists($Mi0Iq)) { $Mi0Iq = 'theme.default.message.' . $BEHqT; if (!view()->exists($Mi0Iq)) { if ($FgRrl) { $Mi0Iq = 'module::' . $FgRrl . '.View.m.message.' . $BEHqT; if (!view()->exists($Mi0Iq)) { $Mi0Iq = 'module::' . $FgRrl . '.View.pc.message.' . $BEHqT; } } else { $Mi0Iq = 'module::Member.View.' . $HWQQV . '.message.' . $BEHqT; if (!view()->exists($Mi0Iq)) { $Mi0Iq = 'module::Member.View.default.message.' . $BEHqT; } } } } goto Iud78; dlVUN: } public static function sendTemplateFromView($Mi0Iq, $hA7ug, $MqkYF, $dxx1X = 0) { goto A61iM; lu5N5: $O04Zr = View::make($Mi0Iq, $hA7ug)->render(); goto MsEfc; MsEfc: self::send($MqkYF, $O04Zr, $dxx1X); goto IWL9j; A61iM: if (!view()->exists($Mi0Iq)) { throw new \Exception('message view not found : ' . $Mi0Iq); } goto lu5N5; IWL9j: } }