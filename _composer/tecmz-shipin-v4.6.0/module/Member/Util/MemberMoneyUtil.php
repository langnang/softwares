<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Util; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Util\IdUtil; use Module\Member\Type\MemberMoneyCashStatus; use Module\Member\Type\MemberMoneyChargeStatus; class MemberMoneyUtil { public static function paginateLog($XK7hT, $H1G2d, $HugPs, $eMb8v = array()) { goto E6kWk; Ul0z3: return ModelUtil::paginate('member_money_log', $H1G2d, $HugPs, $eMb8v); goto oKcDD; gq8Iq: $eMb8v['order'] = array('id', 'desc'); goto Ul0z3; E6kWk: $eMb8v['where']['memberUserId'] = $XK7hT; goto gq8Iq; oKcDD: } public static function getTotal($XK7hT) { goto GkHKl; GkHKl: $bgpWq = ModelUtil::get('member_money', array('memberUserId' => $XK7hT)); goto kC5ED; YGwoA: return $bgpWq['total']; goto t9SH2; kC5ED: if (empty($bgpWq)) { return '0.00'; } goto YGwoA; t9SH2: } public static function change($XK7hT, $Ek1oC, $XYq5S) { goto gKPF7; gKPF7: if (!$Ek1oC) { throw new \Exception('MemberMoneyService -> change empty'); } goto uT0x7; o1Xhy: if (empty($bgpWq)) { $bgpWq = ModelUtil::insert('member_money', array('memberUserId' => $XK7hT, 'total' => 0)); } goto gfpaa; XB2z4: if ($bgpWq['total'] < 0) { throw new \Exception('MemberMoneyService -> total empty'); } goto I9oSZ; uT0x7: $bgpWq = ModelUtil::getWithLock('member_money', array('memberUserId' => $XK7hT)); goto o1Xhy; qXOwB: ModelUtil::insert('member_money_log', array('memberUserId' => $XK7hT, 'change' => $Ek1oC, 'remark' => $XYq5S)); goto iBYIJ; iBYIJ: $bgpWq = ModelUtil::update('member_money', array('id' => $bgpWq['id']), array('total' => $bgpWq['total'] + $Ek1oC)); goto XB2z4; gfpaa: if ($Ek1oC < 0 && $bgpWq['total'] + $Ek1oC < 0) { throw new \Exception('MemberMoneyService -> total change to empty'); } goto qXOwB; I9oSZ: } public static function cash($XK7hT, $WRPnK, $drvzO, $FmHYg, $mPadc, $iWh6t, $XYq5S = '余额提现') { self::change($XK7hT, -$WRPnK, '余额提现'); ModelUtil::insert('member_money_cash', array('memberUserId' => $XK7hT, 'status' => MemberMoneyCashStatus::VERIFYING, 'money' => $WRPnK, 'moneyAfterTax' => $drvzO, 'type' => $FmHYg, 'realname' => $mPadc, 'account' => $iWh6t, 'remark' => $XYq5S)); } public static function paginateCash($XK7hT, $H1G2d, $HugPs, $eMb8v = array()) { $eMb8v['where']['memberUserId'] = $XK7hT; return ModelUtil::paginate('member_money_cash', $H1G2d, $HugPs, $eMb8v); } public static function createCharge($XK7hT, $E6qWw) { return ModelUtil::insert('member_money_charge', array('sn' => IdUtil::generateSN(), 'status' => MemberMoneyChargeStatus::CREATED, 'memberUserId' => $XK7hT, 'fee' => $E6qWw)); } public static function processCharge($pu559) { goto V_eSO; EkFLI: if (empty($vmcRH)) { throw new \Exception('member_money_charge empty -> ' . $pu559); } goto H4aZb; V_eSO: $vmcRH = ModelUtil::getWithLock('member_money_charge', array('id' => $pu559)); goto EkFLI; C694l: ModelUtil::update('member_money_charge', array('id' => $pu559), array('status' => MemberMoneyChargeStatus::SUCCESS)); goto PIH2t; vxAf2: self::change($vmcRH['memberUserId'], $vmcRH['fee'], '充值'); goto C694l; H4aZb: if ($vmcRH['status'] != MemberMoneyChargeStatus::CREATED) { throw new \Exception('member_money_charge status error -> ' . $pu559); } goto vxAf2; PIH2t: } }