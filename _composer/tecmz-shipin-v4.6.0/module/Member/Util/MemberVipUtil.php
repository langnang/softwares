<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Util; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Input\Response; use ModStart\Module\ModuleManager; use Module\Vendor\Cache\CacheUtil; class MemberVipUtil { public static function isEnable() { return ModuleManager::getModuleConfigBoolean('Member', 'vipEnable'); } public static function all() { return CacheUtil::rememberForever('MemberVipList', function () { return ModelUtil::all('member_vip_set', array(), array('*'), array('sort', 'asc')); }); } public static function update($wQ1uv, $WAiaw) { ModelUtil::update('member_vip_set', $wQ1uv, $WAiaw); self::clearCache(); } public static function map() { return CacheUtil::rememberForever('MemberVipMap', function () { $iMATK = array(); foreach (ModelUtil::all('member_vip_set', array(), array('*'), array('sort', 'asc')) as $qlKQK) { $iMATK[intval($qlKQK['id'])] = $qlKQK; } return $iMATK; }); } public static function vipsByIds($zkSEe) { goto cVc39; fGtJW: $G5q5K = array(); goto oBuhL; oBuhL: foreach ($zkSEe as $cYTj3) { if (isset($iMATK[$cYTj3])) { $G5q5K[] = $iMATK[$cYTj3]; } } goto joo94; cVc39: $iMATK = self::map(); goto fGtJW; joo94: return $G5q5K; goto jFcrF; jFcrF: } public static function mapTitle() { return array_build(self::map(), function ($hBBDL, $p4EDY) { return array($hBBDL, $p4EDY['title']); }); } public static function getMemberVipById($XK7hT, $F66vY = null, $Ij1Yd = null) { $OYXQL = MemberUtil::get($XK7hT); return self::getMemberVip($OYXQL, $F66vY, $Ij1Yd); } public static function getMemberVipByIdCached($XK7hT, $F66vY = null, $Ij1Yd = null) { $OYXQL = MemberUtil::getCached($XK7hT); return self::getMemberVip($OYXQL, $F66vY, $Ij1Yd); } public static function getMemberVip($OYXQL, $F66vY = null, $Ij1Yd = null) { goto lQIJA; lQIJA: if (empty($OYXQL)) { $stOyg = self::get(null); } else { if (!empty($OYXQL['vipExpire']) && strtotime($OYXQL['vipExpire']) > time()) { $stOyg = self::get($OYXQL['vipId']); } else { $stOyg = self::get(null); } } goto SaBb3; o2Z3l: if (null === $F66vY) { return $stOyg; } goto OHlIX; SaBb3: if (empty($stOyg)) { return null; } goto o2Z3l; OHlIX: return isset($stOyg[$F66vY]) ? $stOyg[$F66vY] : $Ij1Yd; goto UHe9A; UHe9A: } public static function getDefaultVip() { foreach (self::map() as $cYTj3 => $stOyg) { if (!empty($stOyg['isDefault'])) { return $stOyg; } } return null; } public static function get($cYTj3, $F66vY = null) { goto ulkfD; yw7Fo: if (null === $F66vY) { if (isset($iMATK[$cYTj3])) { return $iMATK[$cYTj3]; } return self::getDefaultVip(); } else { goto yGON1; iKNWu: if (isset($stOyg[$F66vY])) { return $stOyg[$F66vY]; } goto mjD0x; IX1jZ: $stOyg = self::getDefaultVip(); goto iKNWu; yGON1: if (isset($iMATK[$cYTj3][$F66vY])) { return $iMATK[$cYTj3][$F66vY]; } goto IX1jZ; mjD0x: } goto VkPON; ulkfD: $iMATK = self::map(); goto yw7Fo; VkPON: return null; goto Al6MZ; Al6MZ: } public static function calcPrice($jQqIz, $jtGKA, $CfnuY) { goto ZRXMW; J5bDD: $LWjph = $CQwmX ? $CQwmX['vipDays'] : 0; goto bVstS; li2B7: $FmHYg = null; goto liFlT; rrXCL: $vh7jz = null; goto rZmCx; Dt4hy: if (empty($DoNU3)) { return Response::generate(-1, '数据错误'); } goto EuNnq; nOS6p: return Response::generate(0, 'ok', array('type' => $FmHYg, 'expire' => $vh7jz, 'price' => $s5gFX)); goto KTopP; vfnpo: $kHKG2 = $DoNU3 ? $DoNU3['vipDays'] : 0; goto Dt4hy; EuNnq: $t9nAD = strtotime($jtGKA) > 0 ? strtotime($jtGKA) : 0; goto rrXCL; jy592: $FPOSJ = $CQwmX ? $CQwmX['price'] : 0; goto J5bDD; liFlT: if ($jQqIz == $CfnuY) { goto FUTK5; Ij2h7: $vh7jz = date('Y-m-d', max($t9nAD, time()) + $DoNU3['vipDays'] * 24 * 3600); goto HWAoT; HWAoT: $s5gFX = $DoNU3['price']; goto ztJnz; FUTK5: $FmHYg = '续费会员'; goto Ij2h7; ztJnz: } else { if ($t9nAD > 0) { goto ljO2P; hlEp4: $vh7jz = date('Y-m-d', $X2gop); goto mgwzV; eNVIE: $udlnm = $CQwmX['vipDays']; goto NCrua; pLuUF: $Z_f7W = max(0, intval(($t9nAD - time()) / (24 * 3600))); goto eNVIE; n9lWd: $X2gop = max(time() + $DoNU3['vipDays'] * 24 * 3600, $t9nAD); goto hlEp4; NCrua: $l9QXf = $udlnm > 0 ? $CQwmX['price'] * $Z_f7W / $udlnm : 0; goto wAKpl; mgwzV: $s5gFX = $DoNU3['price'] * (($X2gop - time()) / (24 * 3600)) / $DoNU3['vipDays']; goto pLuUF; ljO2P: $FmHYg = '变更会员'; goto n9lWd; wAKpl: $s5gFX = max(bcsub($s5gFX, $l9QXf, 2), 0.01); goto nojCI; nojCI: } else { goto rff75; rff75: $FmHYg = '新开会员'; goto k5AlB; c0OQ9: $s5gFX = $DoNU3['price']; goto Kr0IR; k5AlB: $vh7jz = date('Y-m-d', time() + $DoNU3['vipDays'] * 24 * 3600); goto c0OQ9; Kr0IR: } } goto nOS6p; I1tWQ: $u_OWK = $DoNU3 ? $DoNU3['price'] : 0; goto vfnpo; bVstS: $DoNU3 = self::get($CfnuY); goto I1tWQ; rZmCx: $s5gFX = 0; goto li2B7; ZRXMW: $CQwmX = self::get($jQqIz); goto jy592; KTopP: } public static function clearCache() { CacheUtil::forget('MemberVipList'); CacheUtil::forget('MemberVipMap'); } }