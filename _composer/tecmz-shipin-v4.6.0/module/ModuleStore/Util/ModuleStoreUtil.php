<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\ModuleStore\Util; use Chumper\Zipper\Zipper; use Illuminate\Support\Facades\Cache; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Response; use ModStart\Core\Util\CurlUtil; use ModStart\Core\Util\FileUtil; use ModStart\Core\Util\VersionUtil; use ModStart\ModStart; use ModStart\Module\ModuleManager; class ModuleStoreUtil { const REMOTE_BASE = 'https://modstart.com'; public static function remoteModuleData() { goto lfQWr; Xr8gW: $Wr5Rs = $nIp2z->getTrimString('apiToken'); goto sEpaf; sEpaf: return Cache::remember('ModuleStore_Modules:' . $XK7hT, 60, function () use($Wr5Rs) { $ye3vG = 'cms'; if (class_exists('\\App\\Constant\\AppConstant')) { $ye3vG = \App\Constant\AppConstant::APP; } $ULXwZ = CurlUtil::getJSONData(self::REMOTE_BASE . '/api/store/module', array('app' => $ye3vG, 'api_token' => $Wr5Rs)); return $ULXwZ; }); goto zX6ah; TOeqA: $XK7hT = $nIp2z->getInteger('memberUserId'); goto Xr8gW; lfQWr: $nIp2z = InputPackage::buildFromInput(); goto TOeqA; zX6ah: } public static function all() { goto Hlvm3; Hlvm3: $EisAs = array('disable' => config('env.MS_MODULE_STORE_DISABLE', false)); goto QGrLW; LUs2O: if (!empty($TUqp0['data']['categories'])) { $o8DhA = $TUqp0['data']['categories']; } goto l5Bck; aFhj_: foreach (ModuleManager::listModules() as $bgpWq => $oZPNh) { $zoCJb = ModuleManager::getModuleBasic($bgpWq); if (isset($g3C1V[$bgpWq])) { goto mFfTK; ppD6X: $g3C1V[$bgpWq]['_isEnabled'] = $oZPNh['enable']; goto Q58P0; mFfTK: $g3C1V[$bgpWq]['_isInstalled'] = $oZPNh['isInstalled']; goto ppD6X; uSWRn: $g3C1V[$bgpWq]['_isSystem'] = $oZPNh['isSystem']; goto PXVAu; Q58P0: $g3C1V[$bgpWq]['_localVersion'] = $zoCJb['version']; goto uSWRn; PXVAu: $g3C1V[$bgpWq]['_hasConfig'] = !empty($zoCJb['config']); goto eVFIM; eVFIM: } else { $g3C1V[$bgpWq] = array('id' => 0, 'name' => $bgpWq, 'title' => $zoCJb['title'], 'cover' => null, 'categoryId' => null, 'latestVersion' => $zoCJb['version'], 'releases' => array(), 'url' => null, 'isFee' => false, 'priceSuper' => null, 'priceSuperEnable' => false, 'priceYear' => null, 'priceYearEnable' => false, 'description' => $zoCJb['description'], '_isLocal' => true, '_isInstalled' => $oZPNh['isInstalled'], '_isEnabled' => $oZPNh['enable'], '_localVersion' => $zoCJb['version'], '_isSystem' => $oZPNh['isSystem'], '_hasConfig' => !empty($zoCJb['config'])); } } goto u0AOn; Ci6XN: if (!empty($TUqp0['data']['types'])) { $s3zyq = $TUqp0['data']['types']; } goto STz1B; HrHEc: if (!empty($TUqp0['data']['modules'])) { foreach ($TUqp0['data']['modules'] as $nctPh) { goto i4bAI; stC0J: $nctPh['_hasConfig'] = false; goto Kb4g4; chsR1: $nctPh['_isSystem'] = false; goto stC0J; BI4Bf: $nctPh['_isInstalled'] = false; goto YChg2; i4bAI: $nctPh['_isLocal'] = false; goto BI4Bf; YChg2: $nctPh['_isEnabled'] = false; goto u5a5J; u5a5J: $nctPh['_localVersion'] = null; goto chsR1; Kb4g4: $g3C1V[$nctPh['name']] = $nctPh; goto I1PN6; I1PN6: } } goto aFhj_; X5t5E: $o8DhA = array(); goto LUs2O; QGrLW: $TUqp0 = self::remoteModuleData(); goto X5t5E; STz1B: $g3C1V = array(); goto HrHEc; l5Bck: $s3zyq = array(); goto Ci6XN; u0AOn: return array('storeConfig' => $EisAs, 'categories' => $o8DhA, 'types' => $s3zyq, 'modules' => array_values($g3C1V)); goto q0_QT; q0_QT: } private static function baseRequest($ELIlU, $WAiaw, $nxg8F) { return CurlUtil::postJSONBody(self::REMOTE_BASE . $ELIlU, $WAiaw, array('header' => array('api-token' => $nxg8F, 'X-Requested-With' => 'XMLHttpRequest'))); } public static function checkPackage($nxg8F, $DvHya, $h1TN3) { goto a4O2c; HBpHc: $DD4MC = $ULXwZ['data']['packageSize']; goto JDuUC; JDuUC: $jZRKN = array(); goto d9ahT; ZYgGw: $oZPNh = $ULXwZ['data']['config']; goto HBpHc; r6bQx: return Response::generateSuccessData(array('requires' => $jZRKN, 'errorCount' => count(array_filter($jZRKN, function ($gsYY4) { return !$gsYY4['success']; })), 'packageSize' => $DD4MC)); goto tYRlI; a4O2c: $ULXwZ = self::baseRequest('/api/store/module_info', array('module' => $DvHya, 'version' => $h1TN3), $nxg8F); goto i_IOk; wVNjg: if (!empty($oZPNh['require'])) { foreach ($oZPNh['require'] as $lZ9mO) { goto m71D6; DkHXW: if (ModuleManager::isModuleInstalled($bgpWq)) { goto SUcnX; kfvM3: BizException::throwsIfEmpty("获取模块 {$bgpWq} 信息失败", $J5GyQ); goto YRh_E; SUcnX: $J5GyQ = ModuleManager::getModuleBasic($bgpWq); goto kfvM3; YRh_E: $lZ9mO['success'] = VersionUtil::match($J5GyQ['version'], $p4EDY); goto E4Rls; E4Rls: if (!$lZ9mO['success']) { $lZ9mO['resolve'] = '请使用版本 ' . htmlspecialchars($p4EDY) . " 的模块 <a href='https://modstart.com/m/{$bgpWq}' class='ub-text-white tw-underline' target='_blank'>{$bgpWq}</a>"; } goto pNTzb; pNTzb: } else { $lZ9mO['success'] = false; $lZ9mO['resolve'] = "请先安装 {$lZ9mO['name']} <a href='https://modstart.com/m/{$bgpWq}' class='ub-text-white tw-underline' target='_blank'>[点击查看]</a>"; } goto guRWV; m71D6: list($bgpWq, $p4EDY) = VersionUtil::parse($lZ9mO); goto hoLWR; hoLWR: $lZ9mO = array('name' => "<a href='https://modstart.com/m/{$bgpWq}' class='ub-text-white tw-underline' target='_blank'>{$bgpWq}</a>:" . htmlspecialchars($p4EDY), 'success' => true, 'resolve' => null); goto DkHXW; guRWV: $jZRKN[] = $lZ9mO; goto ZaSSl; ZaSSl: } } goto x5klh; x5klh: if (empty($oZPNh['env'])) { $oZPNh['env'] = array('laravel5'); } goto cpG1U; i_IOk: BizException::throwsIfResponseError($ULXwZ); goto ZYgGw; d9ahT: if (!empty($oZPNh['modstartVersion'])) { goto AZ5Gx; RwgUX: if (!$lZ9mO['success']) { $lZ9mO['resolve'] = '请使用 MSCore' . $oZPNh['modstartVersion'] . ' 的版本'; } goto bI9kR; bI9kR: $jZRKN[] = $lZ9mO; goto pPeYN; AZ5Gx: $lZ9mO = array('name' => '<a href=\'https://modstart.com/download\' class=\'ub-text-white tw-underline\' target=\'_blank\'>MSCore</a>:' . htmlspecialchars($oZPNh['modstartVersion']), 'success' => VersionUtil::match(ModStart::$version, $oZPNh['modstartVersion']), 'resolve' => null); goto RwgUX; pPeYN: } goto wVNjg; cpG1U: if (method_exists(ModuleManager::class, 'getEnv')) { $PdLsM = ModuleManager::getEnv(); BizException::throwsIf(L('Module %s:%s compatible with env %s, current is %s', $DvHya, $oZPNh['version'], join(',', $oZPNh['env']), $PdLsM), !in_array($PdLsM, $oZPNh['env'])); } goto r6bQx; tYRlI: } public static function downloadPackage($nxg8F, $DvHya, $h1TN3) { goto QzA6A; yCuDc: file_put_contents($QkQlj, $WAiaw); goto u3Xbg; UD3JK: $S5NA4 = $ULXwZ['data']['package']; goto b03Ef; vByzP: $QkQlj = FileUtil::generateLocalTempPath('zip'); goto yCuDc; ctC2v: BizException::throwsIfEmpty('安装包获取失败', $WAiaw); goto vByzP; QzA6A: $ULXwZ = self::baseRequest('/api/store/module_package', array('module' => $DvHya, 'version' => $h1TN3), $nxg8F); goto lxu5m; JkIf_: $u4IvZ = $ULXwZ['data']['licenseKey']; goto f9GeK; u3Xbg: BizException::throwsIf('文件MD5校验失败', md5_file($QkQlj) != $JmKWs); goto VQFyZ; f9GeK: $WAiaw = CurlUtil::getRaw($S5NA4); goto ctC2v; VQFyZ: return Response::generateSuccessData(array('package' => $QkQlj, 'licenseKey' => $u4IvZ, 'packageSize' => filesize($QkQlj))); goto oi6UG; b03Ef: $JmKWs = $ULXwZ['data']['packageMd5']; goto JkIf_; lxu5m: BizException::throwsIfResponseError($ULXwZ); goto UD3JK; oi6UG: } public static function cleanDownloadedPackage($S5NA4) { FileUtil::safeCleanLocalTemp($S5NA4); } public static function unpackModule($DvHya, $S5NA4, $u4IvZ) { goto SQ0kK; IAOTT: $ha1kx = base_path('module/' . $DvHya); goto LcvKo; tvw1G: BizException::throwsIf('模块目录 module/' . $DvHya . ' 不正常，请手动删除', file_exists($ha1kx)); goto YJnBD; GCedz: BizException::throwsIfResponseError($ULXwZ); goto IAOTT; z9ILa: self::cleanDownloadedPackage($S5NA4); goto DmpL5; n1TUU: $ULXwZ = FileUtil::filePathWritableCheck(array('module/._write_check_')); goto GCedz; qAzeX: BizException::throwsIf('解压失败', !file_exists($ha1kx . '/config.json')); goto seWKI; DmpL5: return Response::generateSuccessData($azFjm); goto Y1M0y; seWKI: file_put_contents($ha1kx . '/license.json', json_encode(array('licenseKey' => $u4IvZ))); goto z9ILa; xyDZw: $lBl7m->make($S5NA4); goto oMYCr; QdorZ: $lBl7m->extractTo($ha1kx); goto Wu4Ql; LcvKo: if (file_exists($ha1kx)) { goto z15_T; kDH2_: BizException::throwsIf('模块目录 module/' . $DvHya . ' 不正常，请手动删除', !is_dir($ha1kx)); goto qva1f; z15_T: $U44qY = '_delete_.' . date('Ymd_His') . '.' . $DvHya; goto kDH2_; g828W: $azFjm[] = "备份模块 {$DvHya} 到 {$U44qY}"; goto cWtG3; P4l5n: BizException::throwsIf('备份模块旧文件失败', !file_exists($p8XRR)); goto g828W; qva1f: $p8XRR = base_path("module/{$U44qY}"); goto v05zd; v05zd: try { rename($ha1kx, $p8XRR); } catch (\Exception $H8GLS) { BizException::throws("备份模块 {$DvHya} 到 {$U44qY} 失败（确保模块中所有文件和目录已关闭）"); } goto P4l5n; cWtG3: } goto tvw1G; YJnBD: $lBl7m = new Zipper(); goto xyDZw; Wu4Ql: $lBl7m->close(); goto qAzeX; TESXD: BizException::throwsIf('文件不存在 ' . $S5NA4, empty($S5NA4) || !file_exists($S5NA4)); goto n1TUU; oMYCr: if ($lBl7m->contains($DvHya . '/config.json')) { $lBl7m->folder($DvHya . ''); } goto QdorZ; SQ0kK: $azFjm = array(); goto TESXD; Y1M0y: } public static function removeModule($DvHya, $h1TN3) { goto qm5B4; IZP2l: BizException::throwsIf('模块目录 module/' . $DvHya . ' 不正常，请手动删除', !is_dir($ha1kx)); goto bLKMV; F1cB1: BizException::throwsIf('模块目录不存在 ', !file_exists($ha1kx)); goto IZP2l; D9CpN: BizException::throwsIf('模块目录备份失败', !file_exists($p8XRR)); goto KQwa4; qm5B4: $ha1kx = base_path('module/' . $DvHya); goto F1cB1; KQwa4: return Response::generateSuccessData(array()); goto eQnup; Ui3rI: $p8XRR = base_path("module/{$U44qY}"); goto H22ij; H22ij: try { rename($ha1kx, $p8XRR); } catch (\Exception $H8GLS) { BizException::throws("移除模块 {$DvHya} 到 {$U44qY} 失败，请确保模块 {$DvHya} 中没有文件正在被使用"); } goto D9CpN; bLKMV: $U44qY = '_delete_.' . date('Ymd_His') . '.' . $DvHya; goto Ui3rI; eQnup: } }